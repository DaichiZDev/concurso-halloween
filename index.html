<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votación Concurso de Halloween</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        .font-creepster { font-family: 'Creepster', cursive; }
        .card {
            background-color: rgba(40, 40, 40, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #main-container {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .btn-primary {
            background: linear-gradient(145deg, #ff7800, #ff5400);
            border: none; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(255, 120, 0, 0.3);
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 120, 0, 0.5);
        }
        .btn-primary:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
            opacity: 0.8;
            transform: translateY(0);
        }
        .btn-primary.ready-to-send:not(:disabled) {
            background: linear-gradient(145deg, #00b469, #008f53);
            box-shadow: 0 4px 15px rgba(0, 180, 105, 0.3);
        }
        .btn-secondary {
            background-color: #333; border: 1px solid #555; color: white; padding: 12px 24px; border-radius: 8px; transition: background-color 0.2s ease;
        }
        .btn-secondary:hover:not(:disabled) { background-color: #444; }
        .btn-secondary:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }
        .btn-danger {
            background-color: #dc2626; color: white; padding: 12px 24px; border-radius: 8px; transition: background-color 0.2s ease;
        }
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        #feedback-stars span { transition: color 0.2s; cursor: pointer; }
        #feedback-stars span.selected { color: #facc15; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; padding: 1rem; overflow-y: auto;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: #2d2d2d; color: #f0f0f0; padding: 2rem; border-radius: 0.75rem;
            max-width: 90%; width: 500px; border: 1px solid #444; text-align: center;
            transform: scale(0.95); transition: transform 0.3s ease; margin: auto;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .rank-1 { color: #facc15; }
        .rank-2 { color: #e5e7eb; }
        .rank-3 { color: #d97706; }
        .pumpkin-icon { font-size: 2rem; opacity: 0.3; transition: all 0.1s ease; cursor: pointer; }
        .pumpkin-icon.selected { opacity: 1; transform: scale(1.1); color: #ff7800; text-shadow: 0 0 10px rgba(255, 120, 0, 0.9); }
        .pumpkin-icons { user-select: none; display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        .image-preview-sm { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ff7800; }
        .image-preview-lg { width: 100%; max-height: 400px; object-fit: contain; border-radius: 12px; border: 3px solid #ff7800; box-shadow: 0 0 20px rgba(255, 120, 0, 0.5); margin-bottom: 1.5rem; background-color: #000; }
        .toggle-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 0.9rem; color: #ccc; }
        .toggle-checkbox { display: none; }
        .toggle-switch { position: relative; width: 48px; height: 24px; background-color: #555; border-radius: 12px; transition: background-color 0.4s; flex-shrink: 0; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background-color: #f0f0f0; border-radius: 50%; transition: transform 0.4s, background-color 0.4s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4); }
        .toggle-checkbox:checked + .toggle-switch { background-color: #ff7800; }
        .toggle-checkbox:checked + .toggle-switch::after { transform: translateX(24px); }
        .editable-image-container { position: relative; cursor: pointer; }
        .editable-image-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; opacity: 0; transition: opacity 0.2s ease; border-radius: 4px; }
        .editable-image-container:hover .editable-image-overlay { opacity: 1; }
        .participant-me { border: 2px solid #facc15 !important; background-color: rgba(250, 204, 21, 0.1); }
        .participant-evaluated { background-color: rgba(22, 163, 74, 0.2) !important; border-left: 4px solid #16a34a; }
        .participant-evaluating { background-color: rgba(250, 204, 21, 0.2) !important; border-left: 4px solid #facc15; }
        .winner-notification {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%) translateY(-200%); z-index: 110;
            width: 90%; max-width: 450px;
            background: linear-gradient(145deg, #6d28d9, #4c1d95); color: white;
            padding: 1.5rem; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 2px solid #a78bfa;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
        }
        .winner-notification.visible { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
        @media (orientation: landscape) {
            .winner-notification.visible {
                width: 100vw; height: 100vh; max-width: 100vw;
                top: 0; left: 0; transform: none; border-radius: 0; padding: 2rem;
            }
            #winner-notification-title { font-size: 10vw !important; color: #f97316 !important; text-shadow: 0 0 15px rgba(255, 165, 0, 0.7); }
            #winner-notification-subtitle { font-size: 6vw !important; color: #f97316 !important; text-shadow: 0 0 10px rgba(255, 165, 0, 0.7); margin-top: 2vw !important; }
            #winner-notification-message { font-size: 3.5vw !important; max-width: 80%; margin: auto; color: white !important; }
        }
        .text-shadow-lg { text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
        @keyframes pop-in { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
        .emoji-pop { animation: pop-in 0.5s ease-out forwards; }
        @keyframes flash-blue-red { 0%, 100% { background-color: rgba(30, 64, 175, 0.7); } 50% { background-color: rgba(127, 29, 29, 0.7); } }
        @keyframes flash-green-purple { 0%, 100% { background-color: rgba(6, 95, 70, 0.7); } 50% { background-color: rgba(88, 28, 135, 0.7); } }
        .on-deck-alert .modal-content { animation: flash-green-purple 1s infinite; background-color: rgba(10, 10, 10, 0.8) !important; border: 2px solid #a78bfa !important; }
        .is-up-alert .modal-content { animation: flash-blue-red 0.5s infinite; background-color: rgba(10, 10, 10, 0.8) !important; border: 2px solid #f87171 !important; }
        .score-slider-wrapper { text-align: center; padding-top: 1rem; padding-bottom: 1.5rem; }
        .criterion-label { font-weight: bold; color: #cbd5e1; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .score-value-display { font-family: 'Creepster', cursive; font-size: 3rem; color: #ff7800; margin-bottom: 0.75rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.6); line-height: 1; }
        .score-slider-container { position: relative; height: 40px; display: flex; align-items: center; padding: 0 10px; }
        .score-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 10px; background: linear-gradient(to right, #4a5568, #718096); border-radius: 5px; outline: none; cursor: pointer; margin: 0; padding: 0; z-index: 1; }
        .score-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 60px; height: 60px; border: none; cursor: pointer; background-color: transparent; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='50' dy='.35em' font-size='80' text-anchor='middle'%3E🎃%3C/text%3E%3C/svg%3E"); background-size: 90%; background-repeat: no-repeat; background-position: center; filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.5)); margin-top: -10px; position: relative; z-index: 2; }
        .score-slider::-moz-range-thumb { width: 60px; height: 60px; border: none; cursor: pointer; background-color: transparent; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='50' dy='.35em' font-size='80' text-anchor='middle'%3E🎃%3C/text%3E%3C/svg%3E"); background-size: 90%; background-repeat: no-repeat; background-position: center; filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.5)); position: relative; z-index: 2; }
        .criterion-separator { border: none; border-top: 1px solid #4a5568; margin-top: 0; margin-bottom: 0; }
        details > summary { cursor: pointer; list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        #ayuda-container[open] { animation: fadeIn 0.5s ease-out; }
    </style>
    </head>
<body class="bg-cover bg-center bg-fixed" style="background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTcvPQDIhWe3h_ziKkQDe65BTFOe3OHfec-A1GTFnyumw&s=10');">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center z-[150] hidden">
        <svg class="animate-spin h-12 w-12 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p id="loading-text" class="font-creepster text-2xl text-orange-500 mt-4 tracking-wider">Conectando...</p>
    </div>

    <main id="main-container" class="container mx-auto p-4 max-w-5xl flex flex-col justify-center">

        <div id="home-screen" class="w-full">
            <div class="card rounded-xl p-6 md:p-8 text-center shadow-lg max-w-2xl mx-auto">
                <h1 class="font-creepster text-5xl md:text-7xl text-orange-500 mb-4 tracking-widest">Noche de Brujas</h1>
                <p class="text-gray-300 mb-8">Crea o únete a una sala de votación.</p>
                <button id="create-contest-btn" class="btn-primary w-full mb-4">Crear Nueva Sala</button>
                <div class="flex flex-col sm:flex-row gap-2 mt-4">
                     <input type="text" id="contest-id-input" placeholder="Pega el código de la sala" class="flex-grow bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500">
                     <button id="join-contest-btn" class="btn-primary">Unirse</button>
                </div>
            </div>
        </div>

        <div id="register-screen" class="hidden w-full">
             <div class="card rounded-xl p-8 text-center shadow-lg max-w-2xl mx-auto">
                <h2 class="font-creepster text-4xl text-orange-500 mb-6">Registro</h2>
                <div class="space-y-4">
                    <input type="text" id="user-name-input" placeholder="Tu nombre (obligatorio)" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <input type="text" id="costume-name-input" placeholder="Disfraz (opcional)" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500 mt-2">
                    <button id="register-btn" class="btn-primary w-full !mt-6">¡Entrar a la Sala!</button>
                    <button id="back-to-home-btn" class="btn-secondary w-full !mt-2">Volver</button>
                </div>
            </div>
        </div>

        <div id="lobby-screen" class="hidden w-full relative">
             <div class="card rounded-xl p-6 md:p-8 shadow-lg max-w-2xl mx-auto">
                <button id="leave-lobby-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-sm py-1 px-2 rounded-md bg-red-800/50 hover:bg-red-700/80">Salir</button>
                <button id="open-settings-btn" class="absolute top-4 right-16 text-gray-400 hover:text-white p-2 rounded-md bg-gray-700/50 hover:bg-gray-600/80 hidden" title="Configuración de IA">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>

                <h2 class="font-creepster text-4xl text-orange-500 mb-2 text-center">Sala de Espera</h2>
                <div class="bg-gray-900 p-3 rounded-lg flex items-center justify-between mb-4">
                    <div>
                        <span class="text-gray-400 text-sm block">Código de Sala:</span>
                        <span id="contest-code" class="text-orange-400 text-lg font-bold tracking-widest"></span>
                    </div>
                    <button id="copy-code-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-3 rounded-lg text-sm flex-shrink-0">Copiar</button>
                </div>

                <div id="notification-setup" class="mb-4 space-y-3">
                    <div id="diagnostic-box"></div>
                    <div id="ayuda-container" class="hidden">
                        <details class="bg-yellow-900/50 rounded-md border border-yellow-700">
                            <summary class="p-3 font-semibold text-yellow-300 flex items-center">
                                <span class="text-xl mr-2">🔔</span>
                                <span class="flex-1"><b>Ayuda:</b> ¿Notificación silenciosa?</span>
                                <span class="text-xs font-normal ml-2 text-yellow-400">(Presiona)</span>
                            </summary>
                            <div class="p-3 border-t border-yellow-700 text-xs text-yellow-200 space-y-2">
                                <p>Revisa los permisos del sitio:</p>
                                <ol class="list-decimal list-inside space-y-1">
                                    <li>Toca el candado (🔒) en la barra de direcciones.</li>
                                    <li>Ve a <b class="text-white">"Permisos"</b> o "Configuración de sitios".</li>
                                    <li>Busca <b class="text-white">"Notificaciones"</b>.</li>
                                    <li>Activa <b class="text-white">"Vibración"</b> y/o "Sonido".</li>
                                </ol>
                            </div>
                        </details>
                    </div>
                </div>

                <h3 class="font-bold text-xl mb-3 text-gray-200">Usuarios Conectados</h3>
                <div id="users-list" class="space-y-2 max-h-64 overflow-y-auto no-scrollbar pr-2"></div>

                <div id="admin-controls" class="hidden mt-6 pt-6 border-t border-gray-600">
                    <div id="criteria-settings" class="mb-6 bg-gray-900 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-3 text-center text-orange-400">Criterios de Votación</h3>
                        <div class="mb-4">
                            <label for="scoring-method-select" class="block text-sm font-medium text-gray-300 mb-2">Método de Cálculo Final:</label>
                            <select id="scoring-method-select" class="w-full bg-gray-800 rounded p-2 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <option value="weighted_average">Múltiples + Promedio Avanzado (Ponderado)</option>
                                <option value="simple_average">Múltiples + Promedio Simple</option>
                                <option value="sum">Múltiples + Suma</option>
                            </select>
                        </div>
                        <div id="criteria-list" class="space-y-3 mb-4"></div>
                        <button id="add-criterion-btn" class="btn-secondary w-full bg-blue-600 hover:bg-blue-700 text-sm py-2">Añadir Criterio</button>
                        <p id="criteria-weight-warning" class="text-xs text-yellow-400 mt-2 text-center hidden">La suma de los valores debe ser 100.</p>
                    </div>
                    <div id="bulk-participant-form" class="mb-6">
                        <h3 class="font-bold text-lg mb-3 text-center text-gray-300">Carga Masiva</h3>
                        <textarea id="participants-list-input" placeholder="Nombre1,Disfraz1,si&#10;Nombre2,Disfraz2,no&#10;Nombre3,,si" rows="5" class="w-full bg-gray-800 rounded p-2 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                        <div class="flex gap-2 mt-2">
                            <button id="add-participants-from-photo-btn" class="btn-secondary w-1/2 bg-teal-600 hover:bg-teal-700">📸 Cargar Foto</button>
                            <button id="add-participants-from-list-btn" class="btn-secondary w-1/2 bg-purple-700 hover:bg-purple-800">Cargar Lista</button>
                        </div>
                        <div class="mt-4 border-t border-gray-700 pt-4">
                            <h3 class="font-bold text-lg mb-3 text-center text-gray-300">Añadir Jurado</h3>
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <input type="text" id="new-juror-name" placeholder="Nombre del Jurado" class="bg-gray-800 rounded p-2 border border-gray-600 text-white w-full">
                                <button id="add-juror-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Añadir</button>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-gray-900 p-4 rounded-lg">
                            <label class="toggle-label">
                                <span class="font-bold text-lg">Permitir nuevos participantes</span>
                                <input type="checkbox" class="toggle-checkbox" id="lock-contest-toggle">
                                <div class="toggle-switch"></div>
                            </label>
                            <p class="text-xs text-gray-400 mt-2">Desactiva para cerrar la sala.</p>
                        </div>
                        <button id="start-contest-btn" class="btn-primary w-full">¡Comenzar Votación!</button>
                    </div>
                </div>
                <div id="wait-for-admin" class="mt-8 text-center text-gray-400">
                    <p>Esperando que el organizador inicie el concurso...</p>
                </div>
             </div>
        </div>

        <div id="voting-screen" class="hidden w-full">
            <div class="card rounded-xl p-6 md:p-8 shadow-lg w-full pb-24">
                <h2 id="voting-screen-title" class="font-creepster text-4xl text-orange-500 mb-6 text-center"></h2>
                <div id="admin-voting-view" class="hidden"></div>
                <div id="voter-voting-view">
                    <div id="catchup-list-container" class="hidden mb-6 card p-4 bg-blue-900/30 border-blue-700"></div>
                    <div id="currently-voting-for" class="text-center p-6 bg-gray-900 rounded-xl mb-6"></div>
                    <div id="juror-controls" class="hidden mb-6 card p-4">
                         <div id="self-vote-message" class="hidden p-4 rounded-lg bg-yellow-900/50 border border-yellow-700 text-yellow-300 font-bold">
                            ¡Eres jurado y participante! No puedes votar por ti mismo.
                         </div>
                         <div id="scoring-inputs" class="space-y-0"></div>
                         <button id="submit-vote-btn" class="btn-primary w-full mt-8">Enviar Voto</button>
                    </div>
                    <div id="pending-jurors-list-container" class="hidden mb-6 pt-4 border-t border-gray-600">
                        <h4 class="font-bold text-lg text-cyan-400 mb-2">Jurado pendiente de votar:</h4>
                        <ul id="pending-jurors-list-voter" class="space-y-1"></ul>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold text-lg text-green-400 mb-2">Evaluados</h4>
                            <ul id="voted-list" class="space-y-1 text-gray-400"></ul>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-yellow-400 mb-2">Pendientes</h4>
                            <ul id="pending-list" class="space-y-1"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results-screen" class="hidden w-full">
            <div class="card rounded-xl p-6 md:p-8 text-center shadow-lg w-full">
                 <h2 class="font-creepster text-5xl md:text-6xl text-orange-500 mb-6 tracking-widest">¡Resultados Finales!</h2>
                 <div id="results-container" class="space-y-4"></div>
                 <div id="results-controls" class="mt-8 pt-4 border-t border-gray-700"></div>
            </div>
        </div>

    </main>

    <div id="on-deck-modal" class="modal-backdrop on-deck-alert"><div class="modal-content !bg-transparent border-none text-center"><h2 id="on-deck-title" class="font-creepster text-6xl text-yellow-300 drop-shadow-lg"></h2><p id="on-deck-message" class="text-2xl text-white font-bold mt-4 drop-shadow-md"></p><div class="flex gap-4 mt-8"><button id="on-deck-not-ready" class="btn-danger flex-1">Necesito un momento ⏳</button><button id="on-deck-ready" class="btn-primary flex-1 bg-green-600 hover:bg-green-700">¡Estoy listo! ✅</button></div></div></div>
    <div id="is-up-modal" class="modal-backdrop is-up-alert"><div class="modal-content !bg-transparent border-none text-center"><h2 class="font-creepster text-8xl text-red-500 drop-shadow-lg">¡AHORA!</h2><p class="text-3xl text-white font-bold mt-4 drop-shadow-md">Es tu turno. ¡Pasa al escenario!</p><button id="is-up-close" class="btn-primary mt-8">¡VOY!</button></div></div>
    <div id="paused-modal" class="modal-backdrop"><div class="modal-content bg-yellow-900/50 border-yellow-700"><h2 class="font-creepster text-4xl text-yellow-300 mb-4">Votación Pausada</h2><p class="text-yellow-200">El organizador ha pausado. Espera...</p></div></div>
    <div id="catchup-vote-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Voto Pendiente</h2><div id="catchup-participant-info" class="mb-6"></div><div id="catchup-scoring-inputs" class="space-y-0"></div><div class="flex gap-4 mt-6"><button id="catchup-vote-cancel" class="btn-secondary flex-1">Cancelar</button><button id="catchup-vote-save" class="btn-primary flex-1">Enviar Voto</button></div></div></div>
    <div id="feedback-modal" class="modal-backdrop"><div class="modal-content"><h2 id="feedback-modal-title" class="font-creepster text-3xl text-orange-500 mb-4"></h2><p id="feedback-modal-message" class="text-gray-300 mb-4 text-left whitespace-pre-wrap"></p><div id="feedback-emoji-display" class="text-6xl h-20 flex items-center justify-center"></div><h3 class="font-bold text-lg mb-3 text-orange-400">¿Te gustó la aplicación?</h3><div id="feedback-stars" class="flex justify-center text-4xl text-gray-500 cursor-pointer mb-4"><span data-value="1">★</span><span data-value="2">★</span><span data-value="3">★</span><span data-value="4">★</span><span data-value="5">★</span></div><textarea id="feedback-comment" rows="3" class="w-full bg-gray-800 rounded p-2 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="(Opcional) Comentario"></textarea><div class="flex flex-col sm:flex-row gap-2 mt-6"><button id="skip-feedback-btn" class="btn-secondary flex-1">Finalizar sin valorar</button><button id="submit-feedback-btn" class="btn-primary flex-1" disabled>Enviar</button></div></div></div>
    <div id="winner-notification-modal" class="winner-notification text-center"><div class="flex flex-col justify-center items-center h-full"><h2 id="winner-notification-title" class="font-creepster text-4xl text-orange-500 drop-shadow-lg"></h2><p id="winner-notification-subtitle" class="font-creepster text-2xl text-orange-500 drop-shadow-lg mt-2"></p><p id="winner-notification-message" class="text-lg mt-4 text-white"></p></div><button id="winner-notification-close" class="absolute top-2 right-3 text-2xl font-bold opacity-70 hover:opacity-100">&times;</button></div>
    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="font-creepster text-3xl text-orange-500 mb-4"></h2><p id="alert-modal-message" class="text-gray-300 mb-6"></p><button id="alert-modal-close" class="btn-primary">Entendido</button></div></div>
    <div id="confirm-modal" class="modal-backdrop"><div class="modal-content"><h2 id="confirm-modal-title" class="font-creepster text-3xl text-orange-500 mb-4"></h2><p id="confirm-modal-message" class="text-gray-300 mb-6"></p><div class="flex gap-4 mt-6"><button id="confirm-modal-cancel" class="btn-secondary flex-1">Cancelar</button><button id="confirm-modal-confirm" class="btn-danger flex-1">Confirmar</button></div></div></div>
    <div id="link-user-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Enlazar Usuario</h2><p id="link-user-modal-message" class="text-gray-300 mb-6"></p><div id="link-user-list" class="space-y-2 max-h-64 overflow-y-auto"></div><button id="link-user-modal-cancel" class="btn-secondary w-full mt-6">Cancelar</button></div></div>
    <div id="prompt-modal" class="modal-backdrop"><div class="modal-content"><h2 id="prompt-modal-title" class="font-creepster text-3xl text-orange-500 mb-4"></h2><input type="text" id="prompt-modal-input" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500 hidden"><textarea id="prompt-modal-textarea" rows="4" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500 hidden" placeholder="Descripción..."></textarea><button id="prompt-modal-generate" class="btn-secondary w-full mt-4 bg-indigo-600 hover:bg-indigo-700 hidden">✨ Generar con IA</button><div class="flex gap-4 mt-6"><button id="prompt-modal-cancel" class="btn-secondary flex-1">Cancelar</button><button id="prompt-modal-save" class="btn-primary flex-1">Guardar</button></div></div></div>
    <div id="image-choice-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Elegir Imagen</h2><p class="text-gray-300 mb-6">¿Cómo quieres agregar la imagen?</p><div class="flex flex-col gap-4"><button id="image-choice-upload" class="btn-secondary w-full">⬆️ Subir Foto</button><button id="image-choice-generate" class="btn-secondary w-full bg-indigo-600 hover:bg-indigo-700">🤖 Generar con IA</button><button id="image-choice-cancel" class="btn-danger w-full mt-2">Cancelar</button></div></div></div>
    <div id="image-generation-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Generar Imagen con IA</h2><div id="image-generation-preview-container" class="mb-4 bg-black rounded-lg p-2 min-h-[256px] flex items-center justify-center"><img id="image-generation-preview" src="" alt="Previsualización IA" class="max-w-full max-h-[256px] object-contain rounded hidden"><div id="image-generation-status" class="text-gray-400"><p>Define tu idea...</p></div></div><textarea id="image-generation-prompt" rows="3" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Ej: Un vampiro elegante..."></textarea><button id="image-generation-generate" class="btn-primary w-full mt-4">Generar Imagen</button><div class="flex gap-4 mt-6"><button id="image-generation-cancel" class="btn-secondary flex-1">Cancelar</button><button id="image-generation-save" class="btn-primary flex-1" disabled>Guardar</button></div></div></div>
    <div id="settings-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Configuración de IA</h2><p class="text-gray-300 mb-4 text-left">Necesitas tu clave API de Google AI para usar las funciones de IA.</p><p class="mb-6 text-left text-sm"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-orange-400 hover:underline">Obtén tu clave API gratuita aquí</a>. Asegúrate que la facturación esté habilitada.</p><input type="password" id="api-key-input" placeholder="Pega tu clave API aquí" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500"><div class="flex gap-4 mt-6"><button id="settings-modal-cancel" class="btn-secondary flex-1">Cancelar</button><button id="settings-modal-save" class="btn-primary flex-1">Guardar Clave</button></div></div></div>

    <input type="file" id="image-file-input" class="hidden" accept="image/*">
    <input type="file" id="ocr-file-input" class="hidden" accept="image/*">

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, getDocs, writeBatch, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAogdul6URUEE0rQKKGQesZqgqAI5bQbZM",
            authDomain: "concurso-halloween.firebaseapp.com",
            projectId: "concurso-halloween",
            storageBucket: "concurso-halloween.appspot.com",
            messagingSenderId: "911444785839",
            appId: "1:911444785839:web:03326456c9b2b35d90325a"
        };

        // Inicialización de Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Constantes de la App
        const appId = 'concurso-halloween-shared-2025';
        const API_KEY_STORAGE_KEY = 'halloweenContestApiKey';
        const MAX_SCORE = 10;
        const SPINNER_HTML = `<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

        // Referencias Firestore
        const getContestRef = (id) => doc(db, `artifacts/${appId}/public/data/contests`, id);
        const getUserRef = (cId, uId) => doc(db, `artifacts/${appId}/public/data/contests/${cId}/users`, uId);
        const getUsersCollectionRef = (cId) => collection(db, `artifacts/${appId}/public/data/contests/${cId}/users`);
        const getVotesCollectionRef = (cId, participantId) => collection(db, `artifacts/${appId}/public/data/contests/${cId}/users/${participantId}/votes`);
        const getFeedbackCollectionRef = () => collection(db, `artifacts/${appId}/public/data/feedback`);

        // Referencias a Elementos DOM (Pantallas y Modales Principales)
        const screens = {
            home: document.getElementById('home-screen'),
            register: document.getElementById('register-screen'),
            lobby: document.getElementById('lobby-screen'),
            voting: document.getElementById('voting-screen'),
            results: document.getElementById('results-screen')
        };
        const loadingOverlay = document.getElementById('loading-overlay');
        const imageChoiceModal = document.getElementById('image-choice-modal');
        const imageGenerationModal = document.getElementById('image-generation-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const linkUserModal = document.getElementById('link-user-modal');
        const onDeckModal = document.getElementById('on-deck-modal');
        const isUpModal = document.getElementById('is-up-modal');
        const winnerNotificationModal = document.getElementById('winner-notification-modal');
        let diagnosticBox = null;
        let ayudaContainer = null;

        // Variables de Estado Global
        let currentUserId = null, contestId = null, localContestData = {};
        let contestUnsubscribe = null, usersUnsubscribe = null;
        let currentJurorScores = {};
        let generatedImageBase64 = null;
        let targetUserIdForImage = null;
        let existingImageForGenerator = null;
        let selectedForActionId = null;
        let previousRevealStep = 0;
        var notificationState = {
            lastOnDeckStatus: null,
            lastIsUpUserId: null
        };

        // --- Funciones Auxiliares (Alertas, Prompts, IDs, Imágenes) ---

        function customAlert(title, message) {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            const alertModal = document.getElementById('alert-modal');
            const closeBtn = document.getElementById('alert-modal-close');
            const newCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
            newCloseBtn.addEventListener('click', () => alertModal.classList.remove('visible'));
            alertModal.classList.add('visible');
        }

        function showConfirmation(title, message, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            confirmModal.classList.add('visible');
            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => { onConfirm(); confirmModal.classList.remove('visible'); });
        }
        document.getElementById('confirm-modal-cancel').addEventListener('click', () => confirmModal.classList.remove('visible'));

        function showPrompt({ title, value, type = 'input', showIaButton = false, onSave, onGenerate }) {
            const modal = document.getElementById('prompt-modal');
            const titleEl = document.getElementById('prompt-modal-title');
            const inputEl = document.getElementById('prompt-modal-input');
            const textareaEl = document.getElementById('prompt-modal-textarea');
            const iaBtn = document.getElementById('prompt-modal-generate');
            const saveBtn = document.getElementById('prompt-modal-save');
            const cancelBtn = document.getElementById('prompt-modal-cancel');

            titleEl.textContent = title;

            inputEl.classList.toggle('hidden', type !== 'input');
            textareaEl.classList.toggle('hidden', type !== 'textarea');

            if (type === 'input') inputEl.value = value;
            else textareaEl.value = value;

            iaBtn.classList.toggle('hidden', !showIaButton);
            if (showIaButton && onGenerate) {
                const newIaBtn = iaBtn.cloneNode(true);
                iaBtn.parentNode.replaceChild(newIaBtn, iaBtn);
                newIaBtn.onclick = () => onGenerate(textareaEl, newIaBtn);
            }

            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            newSaveBtn.onclick = () => {
                const newValue = (type === 'input') ? inputEl.value.trim() : textareaEl.value.trim();
                onSave(newValue);
                modal.classList.remove('visible');
            };

            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newCancelBtn.onclick = () => modal.classList.remove('visible');

            modal.classList.add('visible');
            if (type === 'input') inputEl.focus();
            else textareaEl.focus();
        }

        const generateId = () => Math.random().toString(36).substr(2, 6).toUpperCase();

        function processImage(base64Image) {
             return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const MAX_SIDE = 400; let { width, height } = img;
                    if (width > MAX_SIDE || height > MAX_SIDE) { if (width > height) { height *= MAX_SIDE / width; width = MAX_SIDE; } else { width *= MAX_SIDE / height; height = MAX_SIDE; } }
                    const canvas = Object.assign(document.createElement('canvas'), { width, height });
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.onerror = () => reject(new Error("Error al cargar imagen para procesar."));
                img.src = base64Image;
            });
        }

        const getImageTag = (b64, cls, alt) => b64 ? `<img src="${b64}" class="${cls}" alt="${alt || 'Disfraz'}">` : `<div class="${cls} bg-gray-700 flex items-center justify-center rounded-sm"><span class="text-gray-400 text-xs">IMG</span></div>`;

        // --- Funciones de IA y Configuración ---

        function getApiKey() { return localStorage.getItem(API_KEY_STORAGE_KEY); }

        function checkAndPromptForKey() {
            if (!getApiKey()) {
                customAlert("Clave API Requerida", "Configura tu clave API de Google AI en Ajustes (⚙️) para usar esta función.");
                return false;
            }
            return true;
        }

        async function generateDescriptionWithGemini(costumeName) {
            const apiKey = getApiKey();
            if (!apiKey) throw new Error("Clave API no configurada.");
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const systemPrompt = "Actúa como narrador entusiasta de concursos de disfraces. Genera una descripción corta (2-3 frases en español) para un disfraz, capturando su esencia y usando un tono apropiado. Cierra con una línea interactiva.";
                const userQuery = `Describe el disfraz de "${costumeName}" para un concurso.`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Error ${response.status} de la API Gemini.`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) return text.trim(); else throw new Error("Respuesta inválida de Gemini.");
            } catch (error) { console.error("Error en generateDescriptionWithGemini:", error); throw error; }
        }

        async function generateImageWithImagen(prompt) {
            const apiKey = getApiKey();
            if (!apiKey) throw new Error("Clave API no configurada.");
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                const payload = { instances: [{ prompt }], parameters: { "sampleCount": 1 } };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Error ${response.status} de la API Imagen.`);
                const result = await response.json();
                const base64Data = result.predictions?.[0]?.bytesBase64Encoded;
                if (base64Data) return `data:image/png;base64,${base64Data}`; else throw new Error("Respuesta inválida de Imagen.");
            } catch (error) { console.error("Error en generateImageWithImagen:", error); throw error; }
        }

        async function extractTextWithGemini(base64Image) {
            const apiKey = getApiKey();
            if (!apiKey) throw new Error("Clave API no configurada.");
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const prompt = "Extrae texto de esta imagen. Es una lista CSV con campos 'Nombre, Disfraz, EsJurado'. 'EsJurado' es opcional ('si'/'y' o 'no'/'n'/vacío). Estandariza la salida a CSV: 'Nombre,Disfraz,si' o 'Nombre,Disfraz,no'.";
                const payload = { contents: [ { role: "user", parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Image.split(',')[1] } } ] } ], };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Error ${response.status} de la API Gemini (OCR).`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                     return text.trim().split('\n').map(line => {
                         let [name, costume, juror] = line.split(',').map(s => s.trim());
                         juror = juror || '';
                         const isJuror = ['si', 'y', 's', 'yes', 'true'].includes(juror.toLowerCase()) ? 'si' : 'no';
                         return `${name || ''},${costume || ''},${isJuror}`;
                     }).join('\n');
                } else {
                     throw new Error("Gemini no pudo extraer texto.");
                }
            } catch (error) { console.error("Error en extractTextWithGemini:", error); throw error; }
        }

        // --- Lógica de Notificaciones ---

        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' });
                    await navigator.serviceWorker.ready;
                    console.log('Service Worker listo.');
                    checkNotificationPermission();
                } catch (error) {
                    console.error(`Error registro SW: ${error}`);
                    if(diagnosticBox) diagnosticBox.innerHTML = `<div class="bg-red-800/30 text-red-300 p-3 rounded border border-red-600"><p><b>Error Crítico:</b> No se pudo registrar el SW para notificaciones.</p></div>`;
                }
            } else {
                if(diagnosticBox) diagnosticBox.innerHTML = `<div class="bg-red-800/30 text-red-300 p-3 rounded border border-red-600"><p><b>Error:</b> Service Workers no soportados.</p></div>`;
            }
        }

        function checkNotificationPermission(forceRequest = false) {
            diagnosticBox = document.getElementById('diagnostic-box');
            ayudaContainer = document.getElementById('ayuda-container');
            if (!diagnosticBox || !ayudaContainer) return;

            if ('Notification' in window) {
               const permission = Notification.permission;
               diagnosticBox.innerHTML = '';
               ayudaContainer.classList.add('hidden');

               if (permission === 'granted') {
                   diagnosticBox.innerHTML = `<div class="bg-green-800/30 text-green-300 p-3 rounded border border-green-600"><p><b>Notificaciones:</b> ✅ Activadas</p></div>`;
                   ayudaContainer.classList.remove('hidden');
               } else if (permission === 'denied') {
                   diagnosticBox.innerHTML = `<div class="bg-red-800/30 text-red-300 p-3 rounded border border-red-600"><p><b>Notificaciones:</b> ❌ Denegadas. Habilita en ajustes del sitio.</p></div>`;
               } else { // 'default'
                   diagnosticBox.innerHTML = `<div class="bg-yellow-800/30 text-yellow-300 p-3 rounded border border-yellow-600"><p><b>Notificaciones:</b> ⏳ <button id="request-perm-btn" class="font-bold underline hover:text-yellow-100">Activar notificaciones</button> para alertas.</p></div>`;
                   const requestBtn = diagnosticBox.querySelector('#request-perm-btn');
                   if (requestBtn) {
                       requestBtn.onclick = () => Notification.requestPermission().then(checkNotificationPermission);
                   }
                   if (forceRequest) {
                       Notification.requestPermission().then(checkNotificationPermission);
                   }
               }
           } else {
               diagnosticBox.innerHTML = `<div class="bg-gray-700 text-gray-300 p-3 rounded"><p><b>Notificaciones:</b> No soportadas.</p></div>`;
           }
        }

        function showNotification(title, body, tag = 'halloween-alert') {
            if (!('Notification' in window) || Notification.permission !== 'granted') return;
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'show_notification', title, body, tag });
            } else { console.warn('SW no listo para notificar.'); }
        }

        // --- Lógica Principal (Navegación, Estados, Votación, Resultados) ---

        const showScreen = name => {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[name]?.classList.remove('hidden');
            loadingOverlay.classList.add('hidden');
            // Reasignar referencias y chequear permisos al mostrar lobby
            if (name === 'lobby') {
                diagnosticBox = document.getElementById('diagnostic-box');
                ayudaContainer = document.getElementById('ayuda-container');
                checkNotificationPermission();
            }
        };

        function subscribeToContest(id) {
            if (contestUnsubscribe) contestUnsubscribe();
            notificationState = { lastOnDeckStatus: null, lastIsUpUserId: null };

            contestUnsubscribe = onSnapshot(getContestRef(id), async (doc) => {
                if (!doc.exists()) { leaveContest(); customAlert("Error", "La sala ya no existe."); return; }

                const oldStatus = localContestData.status;
                localContestData = { id: doc.id, ...doc.data() };
                const newStatus = localContestData.status;
                const isAdmin = localContestData.creatorId === currentUserId;

                if (newStatus === 'finalized') {
                    if (oldStatus !== 'finalized') {
                        showFeedbackModal(localContestData.finalMessage || "El concurso ha finalizado.");
                    } else {
                        if (localContestData.topResults) {
                             showScreen('results');
                             try {
                                 const usersSnap = await getDocs(getUsersCollectionRef(id));
                                 renderResults(localContestData, usersSnap.docs.map(d => ({ id: d.id, ...d.data() })));
                             } catch { leaveContest(); }
                        } else {
                             leaveContest();
                        }
                    }
                    return;
                }

                document.getElementById('paused-modal').classList.toggle('visible', newStatus === 'paused' && !isAdmin);

                if (newStatus === 'voting' && oldStatus === 'lobby') {
                    previousRevealStep = 0;
                    const meSnapshot = await getDoc(getUserRef(contestId, currentUserId));
                    if(meSnapshot.exists() && !meSnapshot.data().isManualEntry) {
                        const me = meSnapshot.data();
                        let alertTitle = '', alertMessage = '';
                        if (me.isJuror && me.isParticipant) { alertTitle = "¡Doble Rol!"; alertMessage = "Eres Jurado y Participante. No podrás votar por ti mismo."; }
                        else if (me.isJuror) { alertTitle = "¡Atención, Jurado!"; alertMessage = "Tu voto es crucial."; }
                        else if (me.isParticipant) { alertTitle = "¡Concurso Iniciado!"; alertMessage = "¡Mucha suerte! Mantente atento."; }
                        if(alertTitle) customAlert(alertTitle, alertMessage);
                    }
                }

                // --- Lógica de Modales y Notificaciones OnDeck/IsUp CORREGIDA ---
                const onDeckData = localContestData.onDeck || {};
                const isUpData = localContestData.isUp || {};
                const currentOnDeckStatus = onDeckData.userId === currentUserId ? onDeckData.status : null;
                const currentIsUpUserId = isUpData.userId;

                // On Deck
                if (currentOnDeckStatus === 'called') {
                    if (notificationState.lastOnDeckStatus !== 'called') {
                        notificationState.lastOnDeckStatus = 'called';
                        const isFirst = !localContestData.votedOnParticipants?.length;
                        document.getElementById('on-deck-title').textContent = isFirst ? "¡Rompe el Hielo!" : "¡Prepárate!";
                        document.getElementById('on-deck-message').textContent = isFirst ? "Eres el primero. ¿Listo?" : "Eres el siguiente. ¿Listo?";
                        onDeckModal.classList.add('visible'); // MUESTRA MODAL
                        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                        showNotification(isFirst ? "¡Rompe el Hielo!" : "¡Prepárate!", isFirst ? "Eres el primero en pasar." : "Eres el siguiente.", 'on-deck-alert');
                    }
                } else {
                    notificationState.lastOnDeckStatus = currentOnDeckStatus;
                    onDeckModal.classList.remove('visible'); // CIERRA MODAL si no es 'called'
                }

                // Is Up
                if (currentIsUpUserId === currentUserId) {
                    if (notificationState.lastIsUpUserId !== currentUserId) {
                        notificationState.lastIsUpUserId = currentUserId;
                        isUpModal.classList.add('visible'); // MUESTRA MODAL
                        if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
                        showNotification("¡AHORA!", "Es tu turno. ¡Al escenario!", 'is-up-alert');
                    }
                } else {
                    notificationState.lastIsUpUserId = null;
                    isUpModal.classList.remove('visible'); // CIERRA MODAL si no es este usuario
                }
                // --- FIN Lógica CORREGIDA ---


                if (newStatus === 'paused' && isAdmin) {
                    showScreen('lobby');
                    subscribeToUsers(id, renderLobby);
                } else {
                    const screenMap = { lobby: 'lobby', voting: 'voting', paused: 'voting', tiebreaker: 'voting', results: 'results' };
                    const rendererMap = { lobby: renderLobby, voting: renderVotingScreen, paused: renderVotingScreen, tiebreaker: renderVotingScreen, results: renderResults };
                    const targetScreen = screenMap[newStatus] || 'home';
                    showScreen(targetScreen);
                    if (rendererMap[newStatus]) subscribeToUsers(id, rendererMap[newStatus]);
                    else if (usersUnsubscribe) { usersUnsubscribe(); usersUnsubscribe = null; }
                }
            }, (error) => {
                console.error("Error en Snapshot del Concurso:", error);
                customAlert("Error de Conexión", "Se perdió la conexión. Intenta recargar.");
            });
        }

        function subscribeToUsers(id, renderer) {
            if (usersUnsubscribe) usersUnsubscribe();
            usersUnsubscribe = onSnapshot(getUsersCollectionRef(id),
                (snap) => renderer(localContestData, snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                (error) => console.error("Error en Snapshot de Usuarios:", error)
            );
        }

        // --- Listeners de Botones de Modales OnDeck/IsUp (Corrección Aplicada) ---
        document.getElementById('on-deck-ready').addEventListener('click', async () => {
            // FIX: Ya no se cierra manualmente aquí
            notificationState.lastOnDeckStatus = 'acknowledged';
            try { await updateDoc(getContestRef(contestId), { 'onDeck.status': 'acknowledged' }); } catch (e) { console.error(e); }
        });
        document.getElementById('on-deck-not-ready').addEventListener('click', async () => {
            // FIX: Ya no se cierra manualmente aquí
            notificationState.lastOnDeckStatus = 'not_ready';
            try { await updateDoc(getContestRef(contestId), { 'onDeck.status': 'not_ready' }); } catch (e) { console.error(e); }
        });
        document.getElementById('is-up-close').addEventListener('click', async () => {
            // FIX: Ya no se cierra manualmente aquí
            notificationState.lastIsUpUserId = null;
            if (localContestData.isUp?.userId === currentUserId) {
                try { await updateDoc(getContestRef(contestId), { isUp: null, acknowledgedUp: currentUserId }); } catch (e) { console.error(e); }
            }
        });

        // --- Renderizado de Pantallas ---

        function renderCriteriaSettings(contestData) {
            const criteria = contestData.criteria || [];
            const scoringMethod = contestData.scoringMethod || 'weighted_average';
            const criteriaListContainer = document.getElementById('criteria-list');
            const isWeighted = scoringMethod === 'weighted_average';

            document.getElementById('scoring-method-select').value = scoringMethod;
            criteriaListContainer.innerHTML = '';

            let totalWeight = 0;
            criteria.forEach(crit => {
                totalWeight += (crit.weight || 0);
                const item = document.createElement('div');
                item.className = 'grid grid-cols-[1fr,auto,auto] items-center gap-2';
                item.innerHTML = `
                    <input type="text" value="${crit.name}" data-criterion-id="${crit.id}" class="criterion-name-input w-full bg-gray-700 rounded p-2 border border-gray-600 text-white">
                    <input type="number" value="${crit.weight || 0}" data-criterion-id="${crit.id}" class="criterion-weight-input w-20 bg-gray-700 rounded p-2 border border-gray-600 text-white text-center ${isWeighted ? '' : 'hidden'}" placeholder="%">
                    <button data-criterion-id="${crit.id}" class="remove-criterion-btn bg-red-700 hover:bg-red-800 text-white font-bold rounded-lg flex items-center justify-center h-10 w-10 text-xl">&times;</button>
                `;
                criteriaListContainer.appendChild(item);
            });

            const warningEl = document.getElementById('criteria-weight-warning');
            if (isWeighted) {
                warningEl.textContent = `Suma: ${totalWeight}%. Debe ser 100%.`;
                warningEl.classList.toggle('hidden', totalWeight === 100);
                warningEl.classList.toggle('text-red-500', totalWeight !== 100);
                warningEl.classList.toggle('text-green-400', totalWeight === 100);
            } else {
                warningEl.classList.add('hidden');
            }
        }

        function renderLobby(contestData, users) {
            document.getElementById('contest-code').textContent = contestId;
            const isAdmin = contestData.creatorId === currentUserId;
            document.getElementById('admin-controls').classList.toggle('hidden', !isAdmin);
            document.getElementById('wait-for-admin').classList.toggle('hidden', isAdmin);
            document.getElementById('open-settings-btn').classList.toggle('hidden', !isAdmin);

            if (isAdmin) {
                renderCriteriaSettings(contestData);
                document.getElementById('lock-contest-toggle').checked = !contestData.isLocked;
            }

            document.getElementById('start-contest-btn').textContent = contestData.status === 'paused' ? 'Reanudar Votación' : '¡Comenzar Votación!';

            const list = document.getElementById('users-list');
            list.innerHTML = '';
            const sortedUsers = [...users].sort((a, b) => a.name.localeCompare(b.name)).sort((a,b) => (a.id === currentUserId) ? -1 : (b.id === currentUserId) ? 1 : 0);

            sortedUsers.forEach(user => {
                const isMe = user.id === currentUserId;
                const canEdit = isAdmin || isMe;
                const adminCanDelete = isAdmin && user.id !== currentUserId;
                const adminCanEditParticipant = isAdmin && user.isParticipant;

                const nameActions = `
                    ${canEdit ? `<button data-action="edit-name" data-userid="${user.id}" class="p-1 rounded bg-gray-700 hover:bg-gray-600" title="Editar nombre">✏️</button>` : ''}
                    ${isAdmin && user.isManualEntry ? `<button data-action="link-user" data-userid="${user.id}" class="p-1 rounded bg-gray-700 hover:bg-gray-600" title="Enlazar usuario">🔗</button>` : ''}
                    ${adminCanDelete ? `<button data-action="delete-user" data-userid="${user.id}" class="p-1 rounded bg-red-800/80 hover:bg-red-700" title="Eliminar">❌</button>` : ''}
                `;
                const costumeActions = `
                    ${canEdit ? `<button data-action="edit-costume" data-userid="${user.id}" class="p-1 rounded bg-gray-700 hover:bg-gray-600" title="Editar disfraz">✏️</button>` : ''}
                    ${adminCanEditParticipant ? `<button data-action="edit-description" data-userid="${user.id}" data-costume="${user.costume || ''}" class="p-1 rounded bg-gray-700 hover:bg-gray-600" title="Editar descripción">✨</button>` : ''}
                `;

                const onlineIndicator = !user.isManualEntry ? `<span class="h-2 w-2 rounded-full bg-green-500 inline-block mr-2" title="Conectado"></span>` : `<span class="h-2 w-2 rounded-full bg-gray-600 inline-block mr-2" title="Manual"></span>`;
                const imgTag = getImageTag(user.costumeImageBase64, 'image-preview-sm flex-shrink-0', user.costume);
                const imgContainer = canEdit ? `<div class="editable-image-container mr-3" data-action="edit-image" data-userid="${user.id}" data-costume="${user.costume || ''}" data-description="${user.costumeDescription || ''}">${imgTag}<div class="editable-image-overlay">📸</div></div>` : `<div class="mr-3">${imgTag}</div>`;

                const rolesHTML = isAdmin ? `<div class="flex items-center gap-4 pt-2 border-t border-gray-700 mt-2"><label class="toggle-label flex-1"><span>Participa</span><input type="checkbox" class="toggle-checkbox" data-role="isParticipant" data-userid="${user.id}" ${user.isParticipant?'checked':''}><div class="toggle-switch"></div></label><label class="toggle-label flex-1"><span>Jurado</span><input type="checkbox" class="toggle-checkbox" data-role="isJuror" data-userid="${user.id}" ${user.isJuror?'checked':''}><div class="toggle-switch"></div></label></div>` : `<div class="text-sm text-orange-400 mt-1">${user.isParticipant?'Participante':''} ${user.isJuror?(user.isParticipant?'/ Jurado':'Jurado'):''}</div>`;

                const item = document.createElement('div');
                item.className = `bg-gray-800 p-3 rounded-lg ${isMe ? 'border-2 border-orange-500' : ''}`;
                item.innerHTML = `
                    <div class="flex items-center">
                        ${imgContainer}
                        <div class="flex-grow">
                            <div class="font-bold flex justify-between items-center">
                                <div class="flex items-center">${onlineIndicator}<span>${user.name} ${isMe?'(Tú)':''}</span></div>
                                <div class="flex items-center gap-1">${nameActions}</div>
                            </div>
                            <div class="text-sm text-gray-300 flex justify-between items-center mt-1">
                                <span>${user.costume?.trim() ? user.costume : (user.isParticipant ? 'Disfraz?' : 'No concursa')}</span>
                                <div class="flex items-center gap-1">${costumeActions}</div>
                            </div>
                        </div>
                    </div>
                    ${rolesHTML}
                `;
                list.appendChild(item);
            });

            // Listener Delegado para Acciones de Usuario en Lobby
            list.onclick = (e) => {
                const target = e.target.closest('[data-action], [data-role]');
                if (!target) return;
                const userId = target.dataset.userid;
                const user = users.find(u => u.id === userId);
                const action = target.dataset.action;
                const role = target.dataset.role;

                targetUserIdForImage = userId; // Para acciones de imagen

                if (action === 'delete-user') {
                    if (!isAdmin || !user || userId === currentUserId) return;
                    showConfirmation('Eliminar Usuario', `¿Eliminar a ${user.name}?`, async () => {
                        try { await deleteDoc(getUserRef(contestId, userId)); } catch (e) { console.error(e); customAlert("Error", "No se pudo eliminar."); }
                    });
                } else if (action === 'link-user') {
                     if (!isAdmin || !user || !user.isManualEntry) return;
                     // (Lógica para enlazar usuario aquí...)
                     // Esta parte es compleja, la omito por ahora pero debe ir aquí
                } else if (action === 'edit-name') {
                    if (!user || (!isAdmin && !isMe)) return;
                    showPrompt({
                        title: 'Editar Nombre', value: user.name || '',
                        onSave: async (val) => { if(val) try { await updateDoc(getUserRef(contestId, userId), { name: val }); } catch(e){ console.error(e); } }
                    });
                } else if (action === 'edit-costume') {
                    if (!user || (!isAdmin && !isMe)) return;
                    showPrompt({
                        title: 'Nombre del Disfraz', value: user.costume || '',
                        onSave: async (val) => { try { await updateDoc(getUserRef(contestId, userId), { costume: val.trim(), isParticipant: !!val.trim() }); } catch(e){ console.error(e); } }
                    });
                } else if (action === 'edit-image') {
                    if (!user || (!isAdmin && !isMe)) return;
                    existingImageForGenerator = user.costumeImageBase64 || null;
                    const costumeName = user.costume || "disfraz";
                    const description = user.costumeDescription || "";
                    document.getElementById('image-generation-prompt').value = description
                       ? `Ilustración detallada de ${costumeName}. Es ${description}. Ambiente Halloween.`
                       : `Ilustración detallada de ${costumeName}. Ambiente Halloween.`;
                    document.getElementById('image-choice-generate').classList.toggle('hidden', !isAdmin);
                    imageChoiceModal.classList.add('visible');
                } else if (action === 'edit-description') {
                     if (!isAdmin || !user || !user.isParticipant) return;
                     showPrompt({
                         title: 'Descripción del Disfraz', value: user.costumeDescription || '', type: 'textarea', showIaButton: true,
                         onSave: async (val) => { try { await updateDoc(getUserRef(contestId, userId), { costumeDescription: val.trim() }); } catch(e){ console.error(e); } },
                         onGenerate: async (textareaEl, btnEl) => {
                             if (!checkAndPromptForKey()) return;
                             if (!user.costume) return customAlert("Error", "Necesita nombre de disfraz.");
                             btnEl.disabled = true; btnEl.innerHTML = SPINNER_HTML;
                             try { textareaEl.value = await generateDescriptionWithGemini(user.costume); }
                             catch (e) { customAlert("Error IA", e.message); }
                             finally { btnEl.disabled = false; btnEl.innerHTML = '✨ Generar con IA'; }
                         }
                     });
                } else if (role) { // Toggle de roles
                    if (!isAdmin) return;
                    const isChecked = target.checked;
                    if (role === 'isParticipant' && isChecked && !user.costume?.trim()) {
                        target.checked = false;
                        customAlert("Disfraz Requerido", "Añade un nombre de disfraz primero.");
                        showPrompt({
                            title: 'Nombre del Disfraz', value: '',
                            onSave: async (val) => { if (val.trim()) try { await updateDoc(getUserRef(contestId, userId), { costume: val.trim(), isParticipant: true }); } catch(e){ console.error(e); } }
                        });
                    } else {
                        try { await updateDoc(getUserRef(contestId, userId), { [role]: isChecked }); } catch(e){ console.error(e); target.checked = !isChecked; } // Revertir si falla
                    }
                }
            };
            document.getElementById('link-user-modal-cancel').onclick = () => linkUserModal.classList.remove('visible');
        }

        async function calculateFullRanking(contestId) {
            try {
                const contestDoc = await getDoc(getContestRef(contestId));
                if (!contestDoc.exists()) return [];
                const contestData = contestDoc.data();
                const criteria = contestData.criteria || [];
                const scoringMethod = contestData.scoringMethod || 'weighted_average';

                const usersSnapshot = await getDocs(getUsersCollectionRef(contestId));
                const allUsers = usersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                const participants = allUsers.filter(u => u.isParticipant);
                const results = [];

                for (const p of participants) {
                    const votesSnapshot = await getDocs(getVotesCollectionRef(contestId, p.id));
                    const votes = votesSnapshot.docs.map(d => d.data());

                    if (votes.length === 0) {
                        results.push({ ...p, voteCount: 0, overallScore: 0 });
                        continue;
                    }

                    const jurorScores = votes.map(vote => {
                        const scores = vote.scores || {};
                        let finalJurorScore = 0;
                        if (scoringMethod === 'sum') {
                            finalJurorScore = Object.values(scores).reduce((sum, s) => sum + (s || 0), 0);
                        } else if (scoringMethod === 'simple_average') {
                            const scoreValues = Object.values(scores).filter(s => typeof s === 'number');
                            finalJurorScore = scoreValues.length > 0 ? scoreValues.reduce((sum, s) => sum + s, 0) / scoreValues.length : 0;
                        } else { // weighted_average
                            let weightedSum = 0;
                            let totalWeight = 0;
                            criteria.forEach(crit => {
                                if (scores[crit.id] !== undefined) {
                                    weightedSum += (scores[crit.id] || 0) * (crit.weight || 0);
                                    totalWeight += (crit.weight || 0);
                                }
                            });
                            finalJurorScore = totalWeight > 0 ? (weightedSum / totalWeight) : 0;
                        }
                        return finalJurorScore;
                    });

                    const overallScore = jurorScores.reduce((sum, s) => sum + s, 0) / jurorScores.length;
                    results.push({ ...p, voteCount: votes.length, overallScore });
                }
                return results.sort((a, b) => b.overallScore - a.overallScore);
            } catch (error) {
                console.error("Error calculating ranking:", error);
                return []; // Devolver array vacío en caso de error
            }
        }

        async function renderVotingScreen(contestData, users) {
             const isAdmin = contestData.creatorId === currentUserId;
             const me = users.find(u => u.id === currentUserId);
             const isJuror = me?.isJuror;
             const isTiebreaker = contestData.status === 'tiebreaker';

             document.getElementById('voting-screen-title').textContent = isTiebreaker ? `Desempate: ${contestData.tiebreakerInfo?.rank || '?'}º Lugar` : 'Votación en Progreso';
             document.getElementById('admin-voting-view').classList.toggle('hidden', !isAdmin);
             document.getElementById('voter-voting-view').classList.remove('hidden');

             let participants = users.filter(u => u.isParticipant);
             if (isTiebreaker && contestData.tiebreakerInfo?.participantIds) {
                 participants = participants.filter(p => contestData.tiebreakerInfo.participantIds.includes(p.id));
             }

             const jurors = users.filter(u => u.isJuror);
             const currentPId = contestData.currentlyVotingFor;
             const currentP = users.find(u => u.id === currentPId);

             // --- Vista Admin ---
             if (isAdmin) {
                 const view = document.getElementById('admin-voting-view');
                 // (Contenido del HTML de la vista admin, igual que antes)
                 // ...
                 // (Listener onclick de la vista admin, igual que antes)
                 // ...
                 // *** PEGAR AQUÍ EL BLOQUE HTML Y ONCLICK DE LA VISTA ADMIN DE LA RESPUESTA ANTERIOR ***
             }

            // --- Vista Votante/Participante ---
             const votingDiv = document.getElementById('currently-voting-for');
             const jurorControls = document.getElementById('juror-controls');
             const selfVoteMessage = document.getElementById('self-vote-message');
             const pendingJurorsList = document.getElementById('pending-jurors-list-voter');
             const pendingJurorsContainer = document.getElementById('pending-jurors-list-container');

             // Lista Catchup
             if (isJuror) {
                 const votedOnIds = contestData.votedOnParticipants || [];
                 const catchupParticipants = [];
                 for (const pId of votedOnIds) {
                     if (pId === currentUserId) continue;
                     try { // Evitar error si falta voto
                         const voteSnap = await getDoc(doc(getVotesCollectionRef(contestId, pId), currentUserId));
                         if (!voteSnap.exists()) {
                             const p = users.find(u => u.id === pId);
                             if (p) catchupParticipants.push(p);
                         }
                     } catch (e) { console.warn("Error check catchup:", e); }
                 }
                 renderCatchupList(catchupParticipants);
             } else {
                 document.getElementById('catchup-list-container').classList.add('hidden');
             }

             // Votando por...
             if (currentP) {
                 pendingJurorsContainer.classList.remove('hidden');
                 votingDiv.innerHTML = `${getImageTag(currentP.costumeImageBase64,'image-preview-lg mx-auto',currentP.costume)}<h3 class="font-creepster text-5xl text-orange-400 mt-4">${currentP.name}</h3><p class="text-2xl">"${currentP.costume || '?'}"</p>${currentP.costumeDescription ? `<p class="text-lg text-gray-300 mt-2 italic">"${currentP.costumeDescription}"</p>` : ''}`;
                 const selfVote = isJuror && me?.isParticipant && me.id === currentPId;
                 jurorControls.classList.toggle('hidden', !isJuror);
                 if (isJuror) {
                     selfVoteMessage.classList.toggle('hidden', !selfVote);
                     ['#scoring-inputs', '#submit-vote-btn'].forEach(sel => jurorControls.querySelector(sel)?.classList.toggle('hidden', selfVote));
                     if (!selfVote) { await setInitialJurorScores(currentPId); renderScoringInputs(); }
                 }
                 // Lista Jurado Pendiente
                 try {
                     const votesSnapshot = await getDocs(getVotesCollectionRef(contestId, currentPId));
                     const voterIds = votesSnapshot.docs.map(d => d.data().jurorId);
                     const pending = jurors.filter(j => !voterIds.includes(j.id) && j.id !== currentPId);
                     pendingJurorsList.innerHTML = pending.length ? pending.map(j => `<li>${j.name}</li>`).join('') : `<li class="text-green-400">¡Todos votaron!</li>`;

                     // Auto-avance Admin
                     const votingJurors = jurors.filter(j => j.id !== currentPId);
                     if (isAdmin && votesSnapshot.size >= votingJurors.length && !(contestData.votedOnParticipants || []).includes(currentPId)) {
                         await updateDoc(getContestRef(contestId), { currentlyVotingFor: null, votedOnParticipants: [...(contestData.votedOnParticipants || []), currentPId] });
                     }
                 } catch (e) { console.error("Error fetching votes:", e); }
             } else {
                 pendingJurorsContainer.classList.add('hidden');
                 const allVoted = participants.length > 0 && participants.every(p => contestData.votedOnParticipants?.includes(p.id));
                 votingDiv.innerHTML = `<h3 class="text-2xl text-gray-400">${allVoted ? '¡Votación Finalizada!' : 'Esperando concursante...'}</h3>`;
                 jurorControls.classList.add('hidden');
             }

             // Listas Evaluados/Pendientes
             const votedIds = contestData.votedOnParticipants || [];
             const sortedVoted = participants.filter(p=>votedIds.includes(p.id)).sort((a,b) => (a.id === currentUserId) ? -1 : (b.id === currentUserId) ? 1 : a.name.localeCompare(b.name));
             const sortedPending = participants.filter(p=>!votedIds.includes(p.id)&&p.id!==currentPId).sort((a,b) => (a.id === currentUserId) ? -1 : (b.id === currentUserId) ? 1 : a.name.localeCompare(b.name));

             document.getElementById('voted-list').innerHTML = sortedVoted.length ? sortedVoted.map(p=>`<li class="${p.id === currentUserId ? 'participant-me p-1 rounded' : ''}">${p.name}</li>`).join('') : '<li>Nadie evaluado aún.</li>';
             document.getElementById('pending-list').innerHTML = sortedPending.length ? sortedPending.map(p=>`<li class="${p.id === currentUserId ? 'participant-me p-1 rounded' : ''}">${p.name}</li>`).join('') : '<li>¡Nadie pendiente!</li>';
        }

        function renderCatchupList(participants) {
            const container = document.getElementById('catchup-list-container');
            if (!participants || participants.length === 0) return container.classList.add('hidden');

            container.classList.remove('hidden');
            let html = `<h3 class="font-bold text-xl mb-3 text-center text-blue-300">Votos Pendientes</h3><div class="space-y-2">`;
            participants.forEach(p => {
                html += `<button data-catchup-userid="${p.id}" class="w-full text-left p-3 rounded-lg bg-gray-800 hover:bg-gray-700">${p.name} - <i>${p.costume || '?'}</i></button>`;
            });
            html += `</div>`;
            container.innerHTML = html;

            container.onclick = e => { // Listener específico para catchup
                const target = e.target.closest('[data-catchup-userid]');
                if (!target) return;
                const participant = participants.find(p => p.id === target.dataset.catchupUserid);
                if (participant) showCatchupVoteModal(participant);
            };
        }

        let catchupScores = {}; // Estado separado para el modal catchup
        function showCatchupVoteModal(participant) {
            const modal = document.getElementById('catchup-vote-modal');
            modal.querySelector('#catchup-participant-info').innerHTML = `<p class="text-xl font-bold">${participant.name}</p><p class="text-gray-400">"${participant.costume || '?'}"</p>`;

            const criteria = localContestData.criteria || [];
            // Resetear scores para este modal
            catchupScores = criteria.reduce((acc, crit) => ({...acc, [crit.id]: 5}), {});

            const scoringContainer = modal.querySelector('#catchup-scoring-inputs');
            scoringContainer.innerHTML = '';
            let html = '';
            criteria.forEach((crit, index) => {
                 if (index > 0) html += '<hr class="criterion-separator my-4">';
                 const currentScore = catchupScores[crit.id] || 5;
                 html += `
                     <div class="score-slider-wrapper !pb-0">
                         <label class="criterion-label block !text-lg">${crit.name}</label>
                         <div class="score-value-display !text-3xl">${currentScore}</div>
                         <div class="score-slider-container">
                             <input type="range" min="1" max="${MAX_SCORE}" value="${currentScore}" class="score-slider" data-criterion-id="${crit.id}">
                         </div>
                     </div>`;
            });
            scoringContainer.innerHTML = html;

            // El listener global `attachScoringListeners` ya maneja los inputs de este modal

            const saveBtn = document.getElementById('catchup-vote-save');
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

            newSaveBtn.onclick = async () => { // Usar onclick aquí es más simple que addEventListener
                 newSaveBtn.disabled = true; newSaveBtn.textContent = 'Enviando...';
                 try {
                     const voteRef = doc(getVotesCollectionRef(contestId, participant.id), currentUserId);
                     await setDoc(voteRef, { jurorId: currentUserId, scores: catchupScores });
                     modal.classList.remove('visible');
                     // Forzar re-render de voting screen para actualizar lista catchup
                     const usersSnap = await getDocs(getUsersCollectionRef(contestId));
                     renderVotingScreen(localContestData, usersSnap.docs.map(d => ({ id: d.id, ...d.data() })));
                 } catch (e) {
                     console.error(e); customAlert("Error", "No se pudo guardar el voto.");
                     newSaveBtn.disabled = false; newSaveBtn.textContent = 'Enviar Voto';
                 }
            };
            modal.classList.add('visible');
        }
        document.getElementById('catchup-vote-cancel').addEventListener('click', () => document.getElementById('catchup-vote-modal').classList.remove('visible'));

        async function renderResults(contestData, users) {
             const isAdmin = contestData.creatorId === currentUserId;
             const resultsContainer = document.getElementById('results-container');
             const controlsContainer = document.getElementById('results-controls');
             controlsContainer.innerHTML = ''; // Limpiar siempre

             let finalResults = [];
             try { finalResults = contestData.topResults ? JSON.parse(contestData.topResults) : []; }
             catch (e) { console.error("Error parsing results:", e); }

             const newRevealStep = contestData.revealStep || 0;
             let resultsHTML = '';
             const ranks = [3, 2, 1];

             if (finalResults.length === 0 && newStatus === 'results') { // Corregido: usar newStatus
                 resultsHTML = '<p class="text-xl text-yellow-400">No hubo resultados.</p>';
             } else if (newRevealStep === 0) {
                 resultsHTML = '<p class="text-2xl text-gray-400 animate-pulse">🥁 Esperando revelación...</p>';
             } else {
                 ranks.forEach(rank => {
                     const result = finalResults.find(r => r.rank === rank);
                     const requiredStep = 4 - rank;
                     const isRevealed = newRevealStep >= requiredStep;

                     if (newRevealStep === requiredStep && previousRevealStep < requiredStep) {
                         if (result?.id === currentUserId) {
                             showWinnerNotification(rank);
                             const rankText = rank === 1 ? '1er' : rank === 2 ? '2do' : '3er';
                             showNotification(`🥇 ¡FELICIDADES! 🥇`, `¡Ganaste el ${rankText} Lugar!`, `winner-rank-${rank}`);
                         }
                     }

                     if (!result) {
                         resultsHTML += `<div class="bg-gray-900 p-4 rounded-xl opacity-50"><p class="text-xl font-bold text-gray-600">${rank}º Lugar: N/A</p></div>`;
                         return;
                     }

                     const reopenBtn = (result.id === currentUserId) ? `<button data-action="reopen-winner-modal" data-rank="${rank}" class="text-2xl ml-2 p-1 rounded-full hover:bg-purple-700">🏆</button>` : '';
                     const imageTag = getImageTag(result.costumeImageBase64, 'image-preview-sm mr-3 flex-shrink-0', result.costume);
                     if (isRevealed) {
                         const colorClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : 'rank-3';
                         const icon = rank === 1 ? '🥇' : rank === 2 ? '🥈' : '🥉';
                         resultsHTML += `<div class="bg-gray-900 p-4 rounded-xl flex justify-between items-center border-l-4 border-orange-500 hover:scale-[1.02] transition-transform"><div class="flex items-center text-left"><span class="font-creepster text-3xl md:text-4xl mr-4 ${colorClass}">${icon}</span>${imageTag}<div><p class="text-xl font-bold text-white flex items-center">${result.name} ${reopenBtn}</p><p class="text-sm text-gray-400">${result.costume || '?'}</p></div></div><div class="text-right flex items-center gap-2"><p class="font-creepster text-5xl ${colorClass}">${result.overallScore?.toFixed(2) ?? '?.?'}</p><span class="font-creepster text-3xl text-orange-500">🎃</span></div></div>`;
                     } else {
                         resultsHTML += `<div class="bg-gray-900 p-4 rounded-xl flex justify-between items-center opacity-40"><p class="text-xl font-bold text-gray-500">${rank}º Lugar</p><p class="font-creepster text-4xl text-gray-700">???</p></div>`;
                     }
                 });
             }
             resultsContainer.innerHTML = resultsHTML;
             resultsContainer.onclick = (e) => {
                 const target = e.target.closest('[data-action="reopen-winner-modal"]');
                 if (target) showWinnerNotification(parseInt(target.dataset.rank));
             };

             // Controles Admin/Usuario
             let controlsHTML = '';
             if (isAdmin) {
                 ranks.forEach(rank => {
                     const result = finalResults.find(r => r.rank === rank);
                     const stepToTriggerReveal = 3 - rank;
                     const nextStepValue = 4 - rank;
                     const isRevealed = newRevealStep >= nextStepValue;
                     const canReveal = newRevealStep === stepToTriggerReveal;
                     if (!result) controlsHTML += `<button class="btn-primary w-full mt-2 bg-gray-700" disabled>${rank}º N/A</button>`;
                     else if (isRevealed) controlsHTML += `<button class="btn-primary w-full mt-2 bg-green-600" disabled>✔️ ${rank}º Revelado</button>`;
                     else if (canReveal) controlsHTML += `<button data-action="reveal" data-next-step="${nextStepValue}" class="btn-primary w-full mt-2 animate-pulse bg-purple-600 hover:bg-purple-700">✨ Revelar ${rank}º</button>`;
                     else controlsHTML += `<button class="btn-primary w-full mt-2" disabled>Revelar ${rank}º</button>`;
                 });
             }

             if (newRevealStep >= 3) { // Si ya se reveló el 1er lugar
                 if (isAdmin) {
                     controlsHTML += `<button data-action="finalize" class="btn-danger mt-6 w-full">Finalizar y Eliminar Sala</button>`;
                     controlsHTML += `<button data-action="restart" class="btn-secondary mt-2 w-full">Reiniciar Concurso</button>`;
                 }
                 // CAMBIO: Botón 'leave' ahora está en el modal de feedback
             }
             controlsContainer.innerHTML = controlsHTML;

             controlsContainer.onclick = async (e) => { // Listener para controles de resultados
                 const target = e.target.closest('button[data-action]');
                 if (!target) return;
                 const action = target.dataset.action;
                 if (['reveal', 'finalize', 'restart'].includes(action) && !isAdmin) return; // Solo admin

                 if (action === 'reveal') {
                     try { await updateDoc(getContestRef(contestId), { revealStep: parseInt(target.dataset.nextStep) }); } catch(e){ console.error(e); }
                 } else if (action === 'finalize') {
                     showConfirmation('Finalizar Concurso', '¿Seguro? Esto eliminará la sala permanentemente.', async () => {
                         try { await updateDoc(getContestRef(contestId), { status: 'finalized', finalMessage: "¡Gracias a todos por participar!" }); } catch(e){ console.error(e); }
                         // El listener 'subscribeToContest' mostrará el feedback
                     });
                 } else if (action === 'restart') {
                     showConfirmation('Reiniciar Concurso', '¿Seguro? Se borrarán votos y resultados.', async () => {
                         loadingOverlay.classList.remove('hidden'); loadingOverlay.querySelector('p').textContent = 'Reiniciando...';
                         const batch = writeBatch(db);
                         batch.update(getContestRef(contestId), { status: "lobby", currentlyVotingFor: null, votedOnParticipants: [], revealStep: 0, topResults: null, tiebreakerInfo: null, acknowledgedUp: null, onDeck: null, isUp: null });
                         users.forEach(u => batch.update(getUserRef(contestId, u.id), { hasVoted: false, totalScore: 0 }));
                         try {
                             const allUsersSnap = await getDocs(getUsersCollectionRef(contestId));
                             for (const userDoc of allUsersSnap.docs) {
                                 const votesSnap = await getDocs(getVotesCollectionRef(contestId, userDoc.id));
                                 votesSnap.forEach(voteDoc => batch.delete(voteDoc.ref));
                             }
                             await batch.commit();
                         } catch (e) { console.error("Error reiniciando:", e); customAlert("Error", "No se pudo reiniciar."); }
                         finally { loadingOverlay.classList.add('hidden'); }
                         // El listener cambiará a lobby
                     });
                 }
                 // CAMBIO: Acción 'leave' eliminada de aquí
             };
             previousRevealStep = newRevealStep;
        }

        // --- Listeners de Eventos Generales ---

        document.getElementById('create-contest-btn').addEventListener('click', () => {
            contestId = generateId(); window.location.hash = contestId; showScreen('register');
        });
        document.getElementById('join-contest-btn').addEventListener('click', async () => {
            const id = document.getElementById('contest-id-input').value.trim().toUpperCase();
            if (!id) return;
            try {
                const contestDoc = await getDoc(getContestRef(id));
                if (!contestDoc.exists()) return customAlert("Error", "Sala no encontrada.");
                const contestData = contestDoc.data();
                const userDoc = await getDoc(getUserRef(id, currentUserId));
                if (contestData.isLocked && !userDoc.exists()) return customAlert("Acceso Denegado", "Sala cerrada.");
                contestId = id; window.location.hash = id; showScreen('register');
            } catch(e) { console.error(e); customAlert("Error", "No se pudo unir a la sala."); }
        });
        document.getElementById('back-to-home-btn').addEventListener('click', leaveContest);
        document.getElementById('leave-lobby-btn').addEventListener('click', leaveContest);
        document.getElementById('register-btn').addEventListener('click', async () => {
            const name = document.getElementById('user-name-input').value.trim();
            if (!name) return customAlert("Error", "Nombre requerido.");
            loadingOverlay.classList.remove('hidden'); loadingOverlay.querySelector('p').textContent = 'Registrando...';
            const costume = document.getElementById('costume-name-input').value.trim();
            try {
                const contestDoc = await getDoc(getContestRef(contestId));
                if (!contestDoc.exists()) {
                    await setDoc(getContestRef(contestId), { status: "lobby", creatorId: currentUserId, isLocked: false, scoringMethod: "weighted_average", criteria: [ { id: 'crit1', name: 'Creatividad', weight: 40 }, { id: 'crit2', name: 'Ejecución', weight: 40 }, { id: 'crit3', name: 'Presentación', weight: 20 }] });
                } else if (contestDoc.data().isLocked) {
                    const userDoc = await getDoc(getUserRef(contestId, currentUserId));
                    if(!userDoc.exists()) { loadingOverlay.classList.add('hidden'); return customAlert("Acceso Denegado", "La sala se cerró."); }
                }
                await setDoc(getUserRef(contestId, currentUserId), { name, costume, isParticipant: !!costume, isJuror: false, hasVoted: false, totalScore: 0, costumeDescription: '', isManualEntry: false }, { merge: true }); // Usar merge
                subscribeToContest(contestId);
            } catch(e) { console.error(e); customAlert("Error", "No se pudo registrar."); loadingOverlay.classList.add('hidden'); }
        });
        document.getElementById('copy-code-btn')?.addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('contest-code').textContent).then(() => customAlert("Copiado", "Código copiado.")).catch(() => customAlert("Error", "No se pudo copiar."));
        });
        document.getElementById('image-choice-upload').addEventListener('click', () => { imageChoiceModal.classList.remove('visible'); document.getElementById('image-file-input').click(); });
        document.getElementById('image-choice-generate').addEventListener('click', () => { if (!checkAndPromptForKey()) return; imageChoiceModal.classList.remove('visible'); /* ... (lógica modal IA) ... */ imageGenerationModal.classList.add('visible'); });
        document.getElementById('image-choice-cancel').addEventListener('click', () => imageChoiceModal.classList.remove('visible'));
        imageFileInput.addEventListener('change', async (e) => { /* ... (lógica subida imagen) ... */ });
        document.getElementById('open-settings-btn').addEventListener('click', () => { /* ... */ document.getElementById('settings-modal').classList.add('visible'); });
        document.getElementById('settings-modal-cancel').addEventListener('click', () => document.getElementById('settings-modal').classList.remove('visible'));
        document.getElementById('settings-modal-save').addEventListener('click', () => { /* ... (lógica guardar API key) ... */ });
        document.getElementById('add-participants-from-photo-btn').addEventListener('click', () => { if (!checkAndPromptForKey()) return; document.getElementById('ocr-file-input').click(); });
        document.getElementById('ocr-file-input').addEventListener('change', async (e) => { /* ... (lógica OCR) ... */ });
        document.getElementById('image-generation-cancel').addEventListener('click', () => imageGenerationModal.classList.remove('visible'));
        document.getElementById('image-generation-generate').addEventListener('click', async (e) => { /* ... (lógica generar imagen IA) ... */ });
        document.getElementById('image-generation-save').addEventListener('click', async () => { /* ... (lógica guardar imagen IA) ... */ });
        document.getElementById('add-participants-from-list-btn')?.addEventListener('click', async () => { /* ... (lógica carga masiva texto) ... */ });
        document.getElementById('add-juror-btn')?.addEventListener('click', async () => { /* ... (lógica añadir jurado manual) ... */ });
        document.getElementById('lock-contest-toggle')?.addEventListener('change', async (e) => { /* ... (lógica bloquear sala) ... */ });
        document.getElementById('start-contest-btn')?.addEventListener('click', async () => { /* ... (lógica iniciar/reanudar concurso) ... */ });
        document.getElementById('submit-vote-btn')?.addEventListener('click', async (e) => { /* ... (lógica enviar voto) ... */ });

        // --- Lógica Feedback Modal ---
        let currentRating = 0;
        const stars = document.querySelectorAll('#feedback-stars span');
        const emojiDisplay = document.getElementById('feedback-emoji-display');
        const submitFeedbackBtn = document.getElementById('submit-feedback-btn');
        const feedbackEmojis = ['😭', '😞', '🥺', '😊', '🤩'];
        stars.forEach(star => {
            star.addEventListener('click', () => {
                currentRating = parseInt(star.dataset.value);
                stars.forEach(s => s.classList.toggle('selected', parseInt(s.dataset.value) <= currentRating));
                emojiDisplay.textContent = feedbackEmojis[currentRating - 1];
                emojiDisplay.classList.add('emoji-pop');
                emojiDisplay.addEventListener('animationend', () => emojiDisplay.classList.remove('emoji-pop'), { once: true });
                submitFeedbackBtn.disabled = false;
            });
        });
        submitFeedbackBtn.addEventListener('click', async (e) => {
             e.target.disabled = true; e.target.textContent = 'Enviando...';
             const comment = document.getElementById('feedback-comment').value;
             try { await addDoc(getFeedbackCollectionRef(), { rating: currentRating, comment, contestId: contestId || '?', timestamp: serverTimestamp() }); }
             catch (e) { console.error("Error feedback:", e); }
             finally { document.getElementById('feedback-modal').classList.remove('visible'); leaveContest(); } // Salir después de enviar/fallar
        });
        document.getElementById('skip-feedback-btn').addEventListener('click', () => {
             document.getElementById('feedback-modal').classList.remove('visible'); leaveContest(); // Salir al omitir
        });
        function showFeedbackModal(message) {
             const modal = document.getElementById('feedback-modal');
             modal.querySelector('#feedback-modal-title').textContent = "¡Concurso Finalizado!";
             modal.querySelector('#feedback-modal-message').textContent = message || "¡Gracias por participar!";
             // Resetear estado
             currentRating = 0; stars.forEach(s => s.classList.remove('selected'));
             emojiDisplay.textContent = ''; document.getElementById('feedback-comment').value = '';
             submitFeedbackBtn.disabled = true; submitFeedbackBtn.textContent = 'Enviar';
             modal.classList.add('visible');
        }

        // --- Autenticación e Inicio ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                await registerServiceWorker(); // Registrar SW después de tener UID

                const hashId = window.location.hash.substring(1).toUpperCase();
                if (hashId) {
                    contestId = hashId;
                    try {
                        const contestDoc = await getDoc(getContestRef(hashId));
                        if(contestDoc.exists()){
                            const userDoc = await getDoc(getUserRef(hashId, currentUserId));
                            if(userDoc.exists()){
                                subscribeToContest(contestId);
                            } else if(contestDoc.data().isLocked) {
                                customAlert("Acceso Denegado", "Sala cerrada."); window.location.hash = ''; showScreen('home');
                            } else { showScreen('register'); }
                        } else { showScreen('register'); }
                    } catch (error) { console.error(error); customAlert("Error Conexión", "No se pudo verificar."); window.location.hash = ''; showScreen('home'); }
                } else { showScreen('home'); }
            } else {
                loadingOverlay.classList.remove('hidden'); loadingOverlay.querySelector('p').textContent = 'Autenticando...';
                try { await signInAnonymously(auth); } catch (e) { console.error("Error Auth:", e); /* Manejar error */ }
            }
        });

        // Adjuntar listener global para sliders
        attachScoringListeners();

    </script>
    </body>
</html>
