<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votaci√≥n Concurso de Halloween</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #f0f0f0; }
        .font-creepster { font-family: 'Creepster', cursive; }
        .card { background-color: rgba(40, 40, 40, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        #main-container {
            min-height: 100vh; /* Fallback for older browsers */
            min-height: -webkit-fill-available; /* Correct height for modern mobile browsers */
        }

        .btn-primary { 
            background: linear-gradient(145deg, #ff7800, #ff5400); 
            border: none; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; 
            text-transform: uppercase; letter-spacing: 1px; 
            box-shadow: 0 4px 15px rgba(255, 120, 0, 0.3); 
            transition: all 0.3s ease; 
        }
        .btn-primary:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(255, 120, 0, 0.5); 
        }
        .btn-primary:disabled { 
            background: #555; 
            cursor: not-allowed; 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); 
            opacity: 0.8; 
            transform: translateY(0); 
        }
        .btn-primary.ready-to-send:not(:disabled) {
            background: linear-gradient(145deg, #00b469, #008f53);
            box-shadow: 0 4px 15px rgba(0, 180, 105, 0.3);
        }

        .btn-secondary { background-color: #333; border: 1px solid #555; color: white; padding: 12px 24px; border-radius: 8px; transition: background-color 0.2s ease; }
        .btn-secondary:hover:not(:disabled) { background-color: #444; }
        .btn-secondary:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }
        .btn-danger { background-color: #dc2626; color: white; padding: 12px 24px; border-radius: 8px; transition: background-color 0.2s ease; }
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        
        #feedback-stars span { transition: color 0.2s; }
        #feedback-stars span.selected { color: #facc15; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .modal-backdrop { 
            position: fixed; 
            inset: 0; 
            background-color: rgba(0,0,0,0.7); 
            display: flex; 
            align-items: flex-start;
            justify-content: center; 
            z-index: 100; 
            padding: 2rem 1rem;
            overflow-y: auto;
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s ease; 
        }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: #2d2d2d; color: #f0f0f0; padding: 2rem; border-radius: 0.75rem; max-width: 90%; width: 500px; border: 1px solid #444; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        
        .rank-1 { color: #facc15; }
        .rank-2 { color: #e5e7eb; }
        .rank-3 { color: #d97706; }
        
        .pumpkin-icon { font-size: 2rem; opacity: 0.3; transition: all 0.1s ease; cursor: pointer; }
        .pumpkin-icon.selected { opacity: 1; transform: scale(1.1); color: #ff7800; text-shadow: 0 0 10px rgba(255, 120, 0, 0.9); }
        .pumpkin-icons { user-select: none; display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        
        .image-preview-sm { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ff7800; }
        .image-preview-lg { width: 100%; max-height: 400px; object-fit: contain; border-radius: 12px; border: 3px solid #ff7800; box-shadow: 0 0 20px rgba(255, 120, 0, 0.5); margin-bottom: 1.5rem; background-color: #000; }

        .toggle-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 0.9rem; color: #ccc; }
        .toggle-checkbox { display: none; }
        .toggle-switch { position: relative; width: 48px; height: 24px; background-color: #555; border-radius: 12px; transition: background-color 0.4s; flex-shrink: 0; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background-color: #f0f0f0; border-radius: 50%; transition: transform 0.4s, background-color 0.4s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4); }
        .toggle-checkbox:checked + .toggle-switch { background-color: #ff7800; }
        .toggle-checkbox:checked + .toggle-switch::after { transform: translateX(24px); }

        .editable-image-container { position: relative; cursor: pointer; }
        .editable-image-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; opacity: 0; transition: opacity 0.2s ease; border-radius: 4px; }
        .editable-image-container:hover .editable-image-overlay { opacity: 1; }
        
        .participant-me { border: 2px solid #facc15 !important; background-color: rgba(250, 204, 21, 0.1); }
        .participant-evaluated { background-color: rgba(22, 163, 74, 0.2) !important; border-left: 4px solid #16a34a; }
        .participant-evaluating { background-color: rgba(250, 204, 21, 0.2) !important; border-left: 4px solid #facc15; }

        .winner-notification {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%) translateY(-200%); z-index: 110;
            width: 90%; max-width: 450px;
            background: linear-gradient(145deg, #6d28d9, #4c1d95); color: white;
            padding: 1.5rem; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 2px solid #a78bfa;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
        }
        .winner-notification.visible { 
            transform: translateX(-50%) translateY(0); 
            opacity: 1; pointer-events: auto;
        }
        
        @media (orientation: landscape) {
            .winner-notification.visible {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                top: 0;
                left: 0;
                transform: none;
                border-radius: 0;
                padding: 2rem;
            }
            #winner-notification-title {
                font-size: 10vw !important;
                color: #f97316 !important;
                text-shadow: 0 0 15px rgba(255, 165, 0, 0.7);
            }
            #winner-notification-subtitle {
                font-size: 6vw !important;
                color: #f97316 !important;
                text-shadow: 0 0 10px rgba(255, 165, 0, 0.7);
                margin-top: 2vw !important;
            }
            #winner-notification-message {
                font-size: 3.5vw !important;
                max-width: 80%;
                margin-left: auto;
                margin-right: auto;
                color: white !important;
            }
        }
        
        .text-shadow-lg { text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
        @keyframes pop-in { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
        .emoji-pop { animation: pop-in 0.5s ease-out forwards; }
        
        @keyframes flash-blue-red { 0%, 100% { background-color: #1e40af; } 50% { background-color: #7f1d1d; } }
        @keyframes flash-green-purple { 0%, 100% { background-color: #065f46; } 50% { background-color: #581c87; } }
        .on-deck-alert { animation: flash-green-purple 1s infinite; }
        .is-up-alert { animation: flash-blue-red 0.5s infinite; }
    </style>
</head>
<body class="bg-cover bg-center bg-fixed" style="background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTcvPQDIhWe3h_ziKkQDe65BTFOe3OHfec-A1GTFnyumw&s=10');">
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center z-[150] hidden">
        <svg class="animate-spin h-12 w-12 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p id="loading-text" class="font-creepster text-2xl text-orange-500 mt-4 tracking-wider">Conectando...</p>
    </div>

    <main id="main-container" class="container mx-auto p-4 max-w-5xl flex flex-col justify-center">
        <div id="home-screen" class="w-full">
            <div class="card rounded-xl p-6 md:p-8 text-center shadow-lg max-w-2xl mx-auto">
                <h1 class="font-creepster text-5xl md:text-7xl text-orange-500 mb-4 tracking-widest">Noche de Brujas</h1>
                <p class="text-gray-300 mb-8">Crea o √∫nete a una sala de votaci√≥n.</p>
                <button id="create-contest-btn" class="btn-primary w-full mb-4">Crear Nueva Sala</button>
                <div class="flex flex-col sm:flex-row gap-2 mt-4">
                     <input type="text" id="contest-id-input" placeholder="Pega el c√≥digo de la sala" class="flex-grow bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500">
                     <button id="join-contest-btn" class="btn-primary">Unirse</button>
                </div>
            </div>
        </div>
        
        <div id="register-screen" class="hidden w-full">
             <div class="card rounded-xl p-8 text-center shadow-lg max-w-2xl mx-auto">
                <h2 class="font-creepster text-4xl text-orange-500 mb-6">Registro</h2>
                <div class="space-y-4">
                    <input type="text" id="user-name-input" placeholder="Tu nombre (obligatorio)" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <input type="text" id="costume-name-input" placeholder="Disfraz (opcional)" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500 mt-2">
                    <button id="register-btn" class="btn-primary w-full !mt-6">¬°Entrar a la Sala!</button>
                    <button id="back-to-home-btn" class="btn-secondary w-full !mt-2">Volver</button>
                </div>
            </div>
        </div>

        <div id="lobby-screen" class="hidden w-full relative">
             <div class="card rounded-xl p-6 md:p-8 shadow-lg max-w-2xl mx-auto">
                <button id="leave-lobby-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-sm py-1 px-2 rounded-md bg-red-800/50 hover:bg-red-700/80">Salir</button>
                <button id="open-settings-btn" class="absolute top-4 right-16 text-gray-400 hover:text-white p-2 rounded-md bg-gray-700/50 hover:bg-gray-600/80 hidden" title="Configuraci√≥n de IA">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>

                <h2 class="font-creepster text-4xl text-orange-500 mb-2 text-center">Sala de Espera</h2>
                <div class="bg-gray-900 p-3 rounded-lg flex items-center justify-between mb-6">
                    <div>
                        <span class="text-gray-400 text-sm block">C√≥digo de Sala:</span>
                        <span id="contest-code" class="text-orange-400 text-lg font-bold tracking-widest"></span>
                    </div>
                    <button id="copy-code-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-3 rounded-lg text-sm flex-shrink-0">Copiar</button>
                </div>
                <h3 class="font-bold text-xl mb-3 text-gray-200">Usuarios Conectados</h3>
                <div id="users-list" class="space-y-2 max-h-64 overflow-y-auto no-scrollbar pr-2"></div>
                
                <div id="admin-controls" class="hidden mt-6 pt-6 border-t border-gray-600">
                    <div id="bulk-participant-form" class="mb-6">
                        <h3 class="font-bold text-lg mb-3 text-center text-gray-300">Carga Masiva de Participantes</h3>
                        <textarea id="participants-list-input" placeholder="Pega aqu√≠ tu lista de participantes o usa la opci√≥n de cargar desde foto." rows="5" class="w-full bg-gray-800 rounded p-2 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                        <div class="flex gap-2 mt-2">
                            <button id="add-participants-from-photo-btn" class="btn-secondary w-1/2 bg-teal-600 hover:bg-teal-700">üì∏ Cargar desde Foto</button>
                            <button id="add-participants-from-list-btn" class="btn-secondary w-1/2 bg-purple-700 hover:bg-purple-800">Cargar Lista</button>
                        </div>
                        
                        <div class="mt-4 border-t border-gray-700 pt-4">
                            <h3 class="font-bold text-lg mb-3 text-center text-gray-300">A√±adir Jurado Manualmente</h3>
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <input type="text" id="new-juror-name" placeholder="Nombre del Jurado" class="bg-gray-800 rounded p-2 border border-gray-600 text-white w-full">
                                <button id="add-juror-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">A√±adir Jurado</button>
                            </div>
                        </div>
                    </div>
                    <p class="text-center text-yellow-400 mb-4 font-bold">Eres el organizador. Asigna los roles:</p>
                    <button id="start-contest-btn" class="btn-primary w-full">¬°Comenzar Votaci√≥n!</button>
                </div>
                <div id="wait-for-admin" class="mt-8 text-center text-gray-400">
                    <p>Esperando que el organizador inicie el concurso...</p>
                </div>
             </div>
        </div>

        <div id="voting-screen" class="hidden w-full">
            <div class="card rounded-xl p-6 md:p-8 shadow-lg w-full pb-24">
                <h2 id="voting-screen-title" class="font-creepster text-4xl text-orange-500 mb-6 text-center">Votaci√≥n en Progreso</h2>
                <div id="admin-voting-view" class="hidden"></div>
                <div id="voter-voting-view">
                    <div id="catchup-list-container" class="hidden mb-6 card p-4 bg-blue-900/30 border-blue-700"></div>
                    <div id="currently-voting-for" class="text-center p-6 bg-gray-900 rounded-xl mb-6"></div>
                    <div id="juror-controls" class="hidden mb-6 card p-4">
                         <div id="self-vote-message" class="hidden p-4 rounded-lg bg-yellow-900/50 border border-yellow-700 text-yellow-300 font-bold">
                            Eres Jurado y participante, no tienes permitido votar por ti mismo. Espera al siguiente participante para votar.
                         </div>
                         <h3 class="font-bold text-xl mb-4 text-center text-orange-400">¬°Emite tu puntaje de calabazas!</h3>
                         <div id="scoring-inputs" class="space-y-6"></div>
                         <button id="submit-vote-btn" class="btn-primary w-full mt-6">Enviar Voto</button>
                    </div>
                    <div id="pending-jurors-list-container" class="hidden mb-6 pt-4 border-t border-gray-600">
                        <h4 class="font-bold text-lg text-cyan-400 mb-2">Jurado pendiente de votar:</h4>
                        <ul id="pending-jurors-list-voter" class="space-y-1"></ul>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold text-lg text-green-400 mb-2">Evaluados</h4>
                            <ul id="voted-list" class="space-y-1 text-gray-400"></ul>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-yellow-400 mb-2">Pendientes</h4>
                            <ul id="pending-list" class="space-y-1"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results-screen" class="hidden w-full">
            <div class="card rounded-xl p-6 md:p-8 text-center shadow-lg w-full">
                 <h2 class="font-creepster text-5xl md:text-6xl text-orange-500 mb-6 tracking-widest">¬°Resultados Finales!</h2>
                 <div id="results-container" class="space-y-4">
                     <p class="text-gray-400 text-lg">Esperando la revelaci√≥n de los ganadores...</p>
                 </div>
                 <div id="results-controls" class="mt-8 pt-4 border-t border-gray-700"></div>
            </div>
        </div>
        
        <div id="debug-panel" class="hidden w-full">
             <div class="card rounded-xl p-8 shadow-lg max-w-2xl mx-auto">
                <h2 class="font-creepster text-4xl text-orange-500 mb-6 text-center">Panel de Desarrollador</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    <button data-debug="home" class="btn-secondary">Inicio</button>
                    <button data-debug="lobby-admin" class="btn-secondary">Lobby (Admin)</button>
                    <button data-debug="lobby-user" class="btn-secondary">Lobby (User)</button>
                    <button data-debug="voting-admin" class="btn-secondary">Votaci√≥n (Admin)</button>
                    <button data-debug="voting-juror" class="btn-secondary">Votaci√≥n (Jurado)</button>
                    <button data-debug="voting-participant" class="btn-secondary">Votaci√≥n (Participante)</button>
                    <button data-debug="results-admin" class="btn-secondary">Resultados (Admin)</button>
                    <button data-debug="results-user" class="btn-secondary">Resultados (User)</button>
                    <button data-debug="on-deck" class="btn-secondary">Aviso "Prep√°rate"</button>
                    <button data-debug="is-up" class="btn-secondary">Aviso "¬°Ahora!"</button>
                    <button data-debug="feedback" class="btn-secondary">Ventana Feedback</button>
                    <button data-debug="winner-1" class="btn-primary">Ganador 1¬∫</button>
                    <button data-debug="winner-2" class="btn-primary">Ganador 2¬∫</button>
                    <button data-debug="winner-3" class="btn-primary">Ganador 3¬∫</button>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-700 text-center">
                    <p class="text-gray-400 text-sm">Cr√©ditos: <span class="text-orange-400 font-bold">Daichi PC</span></p>
                </div>
                 <button data-debug="exit" class="btn-danger w-full mt-4">Salir del Modo Debug</button>
            </div>
        </div>

    </main>

    <div id="debug-back-button-container" class="hidden fixed bottom-4 right-4 z-[200]">
        <button id="debug-back-button" class="btn-secondary bg-purple-700 hover:bg-purple-800 shadow-lg">Volver al Panel</button>
    </div>
    
    <div id="easter-egg-overlay" class="hidden fixed inset-0 z-[200] cursor-pointer">
        <p class="absolute bottom-4 right-4 font-creepster text-2xl text-orange-500 text-shadow-lg">Daichi PC</p>
    </div>
    
    <div id="on-deck-modal" class="modal-backdrop on-deck-alert">
        <div class="modal-content !bg-transparent border-none text-center">
            <h2 id="on-deck-title" class="font-creepster text-6xl text-yellow-300 drop-shadow-lg">¬°Prep√°rate!</h2>
            <p id="on-deck-message" class="text-2xl text-white font-bold mt-4 drop-shadow-md">Eres el siguiente en pasar. ¬øEst√°s listo?</p>
            <div class="flex gap-4 mt-8">
                <button id="on-deck-not-ready" class="btn-danger flex-1">Necesito un momento ‚è≥</button>
                <button id="on-deck-ready" class="btn-primary flex-1 bg-green-600 hover:bg-green-700">¬°Estoy listo! ‚úÖ</button>
            </div>
        </div>
    </div>
     <div id="is-up-modal" class="modal-backdrop is-up-alert">
        <div class="modal-content !bg-transparent border-none text-center">
            <h2 class="font-creepster text-8xl text-red-500 drop-shadow-lg">¬°AHORA!</h2>
            <p class="text-3xl text-white font-bold mt-4 drop-shadow-md">Es tu turno. ¬°Pasa al escenario!</p>
            <button id="is-up-close" class="btn-primary mt-8">¬°VOY!</button>
        </div>
    </div>
    <div id="paused-modal" class="modal-backdrop">
        <div class="modal-content bg-yellow-900/50 border-yellow-700">
            <h2 class="font-creepster text-4xl text-yellow-300 mb-4">Votaci√≥n Pausada</h2>
            <p class="text-yellow-200">El organizador ha pausado el concurso. Por favor, espera...</p>
        </div>
    </div>
    <div id="catchup-vote-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="font-creepster text-3xl text-orange-500 mb-4">Voto Pendiente</h2>
            <div id="catchup-participant-info" class="mb-6"></div>
            <div id="catchup-scoring-inputs"></div>
            <div class="flex gap-4 mt-6">
                <button id="catchup-vote-cancel" class="btn-secondary flex-1">Cancelar</button>
                <button id="catchup-vote-save" class="btn-primary flex-1">Enviar Voto</button>
            </div>
        </div>
    </div>
    <div id="feedback-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="feedback-modal-title" class="font-creepster text-3xl text-orange-500 mb-4"></h2>
            <p id="feedback-modal-message" class="text-gray-300 mb-4 text-left whitespace-pre-wrap"></p>
            <div id="feedback-emoji-display" class="text-6xl h-20 flex items-center justify-center"></div>
            <h3 class="font-bold text-lg mb-3 text-orange-400">¬øTe gust√≥ la aplicaci√≥n? Deja tu valoraci√≥n.</h3>
            <div id="feedback-stars" class="flex justify-center text-4xl text-gray-500 cursor-pointer mb-4">
                <span data-value="1">‚òÖ</span><span data-value="2">‚òÖ</span><span data-value="3">‚òÖ</span><span data-value="4">‚òÖ</span><span data-value="5">‚òÖ</span>
            </div>
            <textarea id="feedback-comment" rows="3" class="w-full bg-gray-800 rounded p-2 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="(Opcional) ¬øAlguna sugerencia o comentario?"></textarea>
            <div class="flex flex-col sm:flex-row gap-2 mt-6">
                 <button id="skip-feedback-btn" class="btn-secondary flex-1">Finalizar sin valorar</button>
                 <button id="submit-feedback-btn" class="btn-primary flex-1" disabled>Enviar Valoraci√≥n</button>
            </div>
        </div>
    </div>

    <div id="winner-notification-modal" class="winner-notification text-center">
        <div class="flex flex-col justify-center items-center h-full">
            <h2 id="winner-notification-title" class="font-creepster text-4xl text-orange-500 drop-shadow-lg"></h2>
            <p id="winner-notification-subtitle" class="font-creepster text-2xl text-orange-500 drop-shadow-lg mt-2"></p>
            <p id="winner-notification-message" class="text-lg mt-4 text-white"></p>
        </div>
        <button id="winner-notification-close" class="absolute top-2 right-3 text-2xl font-bold opacity-70 hover:opacity-100">&times;</button>
    </div>

    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="font-creepster text-3xl text-orange-500 mb-4"></h2><p id="alert-modal-message" class="text-gray-300 mb-6"></p><button id="alert-modal-close" class="btn-primary">Entendido</button></div></div>
    <div id="confirm-modal" class="modal-backdrop"><div class="modal-content"><h2 id="confirm-modal-title" class="font-creepster text-3xl text-orange-500 mb-4"></h2><p id="confirm-modal-message" class="text-gray-300 mb-6"></p><div class="flex gap-4 mt-6"><button id="confirm-modal-cancel" class="btn-secondary flex-1">Cancelar</button><button id="confirm-modal-confirm" class="btn-danger flex-1">Confirmar</button></div></div></div>
    <div id="link-user-modal" class="modal-backdrop"><div class="modal-content"><h2 id="link-user-modal-title" class="font-creepster text-3xl text-orange-500 mb-4">Enlazar Usuario</h2><p id="link-user-modal-message" class="text-gray-300 mb-6"></p><div id="link-user-list" class="space-y-2 max-h-64 overflow-y-auto"></div><button id="link-user-modal-cancel" class="btn-secondary w-full mt-6">Cancelar</button></div></div>
    <div id="name-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Editar Nombre</h2><input type="text" id="name-modal-input" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500"><div class="flex gap-4 mt-6"><button id="name-modal-cancel" class="btn-secondary flex-1">Cancelar</button><button id="name-modal-save" class="btn-primary flex-1">Guardar</button></div></div></div>
    <div id="costume-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Nombre del Disfraz</h2><input type="text" id="costume-modal-input" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500"><div class="flex gap-4 mt-6"><button id="costume-modal-cancel" class="btn-secondary flex-1">Cancelar</button><button id="costume-modal-save" class="btn-primary flex-1">Guardar</button></div></div></div>
    <div id="description-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Descripci√≥n del Disfraz</h2><textarea id="description-modal-input" rows="4" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Descripci√≥n..."></textarea><button id="description-modal-generate" class="btn-secondary w-full mt-4 bg-indigo-600 hover:bg-indigo-700">‚ú® Generar con IA</button><div class="flex gap-4 mt-6"><button id="description-modal-cancel" class="btn-secondary flex-1">Cancelar</button><button id="description-modal-save" class="btn-primary flex-1">Guardar</button></div></div></div>
    <div id="image-choice-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Elegir Imagen</h2><p class="text-gray-300 mb-6">¬øC√≥mo quieres agregar la imagen del disfraz?</p><div class="flex flex-col gap-4"><button id="image-choice-upload" class="btn-secondary w-full">‚¨ÜÔ∏è Subir Foto</button><button id="image-choice-generate" class="btn-secondary w-full bg-indigo-600 hover:bg-indigo-700">ü§ñ Generar con IA</button><button id="image-choice-cancel" class="btn-danger w-full mt-2">Cancelar</button></div></div></div>
    <div id="image-generation-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Generar Imagen con IA</h2><div id="image-generation-preview-container" class="mb-4 bg-black rounded-lg p-2 min-h-[256px] flex items-center justify-center"><img id="image-generation-preview" src="" alt="Previsualizaci√≥n de IA" class="max-w-full max-h-[256px] object-contain rounded hidden"><div id="image-generation-status" class="text-gray-400"><p>Define tu idea y presiona "Generar".</p></div></div><textarea id="image-generation-prompt" rows="3" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="S√© descriptivo. Ej: Un vampiro elegante, personaje completo..."></textarea><button id="image-generation-generate" class="btn-primary w-full mt-4">Generar Imagen</button><div class="flex gap-4 mt-6"><button id="image-generation-cancel" class="btn-secondary flex-1">Cancelar</button><button id="image-generation-save" class="btn-primary flex-1" disabled>Guardar</button></div></div></div>
    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="font-creepster text-3xl text-orange-500 mb-4">Configuraci√≥n de IA</h2>
            <p class="text-gray-300 mb-4 text-left">
                Para usar las funciones de Inteligencia Artificial (generaci√≥n de im√°genes, descripciones y lectura de fotos), necesitas tu propia clave de API de Google AI.
            </p>
            <p class="mb-6 text-left text-sm">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-orange-400 hover:underline">
                    Obt√©n tu clave de API gratuita aqu√≠
                </a>. Aseg√∫rate de que tu proyecto de Google Cloud asociado tenga la facturaci√≥n habilitada.
            </p>
            <input type="password" id="api-key-input" placeholder="Pega tu clave de API aqu√≠" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500">
            <div class="flex gap-4 mt-6">
                <button id="settings-modal-cancel" class="btn-secondary flex-1">Cancelar</button>
                <button id="settings-modal-save" class="btn-primary flex-1">Guardar Clave</button>
            </div>
        </div>
    </div>
    <input type="file" id="image-file-input" class="hidden" accept="image/*">
    <input type="file" id="ocr-file-input" class="hidden" accept="image/*">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, getDocs, writeBatch, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAogdul6URUEE0rQKKGQesZqgqAI5bQbZM",
            authDomain: "concurso-halloween.firebaseapp.com",
            projectId: "concurso-halloween",
            storageBucket: "concurso-halloween.appspot.com",
            messagingSenderId: "911444785839",
            appId: "1:911444785839:web:03326456c9b2b35d90325a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appId = 'concurso-halloween-shared-2025';

        const getContestRef = (id) => doc(db, `artifacts/${appId}/public/data/contests`, id);
        const getUserRef = (cId, uId) => doc(db, `artifacts/${appId}/public/data/contests/${cId}/users`, uId);
        const getUsersCollectionRef = (cId) => collection(db, `artifacts/${appId}/public/data/contests/${cId}/users`);
        const getVotesCollectionRef = (cId, participantId) => collection(db, `artifacts/${appId}/public/data/contests/${cId}/users/${participantId}/votes`);
        const getFeedbackCollectionRef = () => collection(db, `artifacts/${appId}/public/data/feedback`);
        
        const screens = { home: document.getElementById('home-screen'), register: document.getElementById('register-screen'), lobby: document.getElementById('lobby-screen'), voting: document.getElementById('voting-screen'), results: document.getElementById('results-screen'), debug: document.getElementById('debug-panel') };
        const loadingOverlay = document.getElementById('loading-overlay');
        const debugBackButtonContainer = document.getElementById('debug-back-button-container');
        const easterEggOverlay = document.getElementById('easter-egg-overlay');
        let currentUserId = null, contestId = null, localContestData = {};
        let contestUnsubscribe = null, usersUnsubscribe = null;
        let currentJurorScore = 5;
        const MAX_PUMPKINS = 10;
        
        const imageChoiceModal = document.getElementById('image-choice-modal');
        const imageGenerationModal = document.getElementById('image-generation-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const linkUserModal = document.getElementById('link-user-modal');
        const onDeckModal = document.getElementById('on-deck-modal');
        const isUpModal = document.getElementById('is-up-modal');
        const winnerNotificationModal = document.getElementById('winner-notification-modal');
        let generatedImageBase64 = null;
        let targetUserIdForImage = null;
        let existingImageForGenerator = null;
        let selectedForActionId = null;
        let isInDebugMode = false;
        const API_KEY_STORAGE_KEY = 'halloweenContestApiKey';
        let previousRevealStep = 0;

        document.getElementById('winner-notification-close').addEventListener('click', () => {
            winnerNotificationModal.classList.remove('visible');
        });

        function showWinnerNotification(rank) {
            const rankText = rank === 1 ? '1er' : (rank === 2 ? '2do' : '3er');
            const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â';
            document.getElementById('winner-notification-title').innerHTML = `${medal} FELICIDADES ${medal}`;
            document.getElementById('winner-notification-subtitle').textContent = `Ganaste el ${rankText} Lugar`;
            document.getElementById('winner-notification-message').textContent = '¬°Tu disfraz fue incre√≠ble! Pasa a recoger tu premio y celebra tu victoria.';
            winnerNotificationModal.classList.add('visible');
        }

        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE_KEY);
        }

        function checkAndPromptForKey() {
            if (!getApiKey()) {
                customAlert("Clave de API Requerida", "Para usar esta funci√≥n de IA, por favor configura tu clave de API de Google AI en los ajustes (icono de engranaje).");
                return false;
            }
            return true;
        }

        document.getElementById('open-settings-btn').addEventListener('click', () => {
            document.getElementById('api-key-input').value = getApiKey() || '';
            document.getElementById('settings-modal').classList.add('visible');
        });

        document.getElementById('settings-modal-cancel').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.remove('visible');
        });

        document.getElementById('settings-modal-save').addEventListener('click', () => {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                localStorage.setItem(API_KEY_STORAGE_KEY, key);
                customAlert("Guardado", "Tu clave de API ha sido guardada en este navegador.");
            } else {
                localStorage.removeItem(API_KEY_STORAGE_KEY);
                customAlert("Eliminado", "La clave de API ha sido eliminada.");
            }
            document.getElementById('settings-modal').classList.remove('visible');
        });

        function customAlert(title, message) {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            const alertModal = document.getElementById('alert-modal');
            const closeBtn = document.getElementById('alert-modal-close');
            const newCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
            newCloseBtn.addEventListener('click', () => alertModal.classList.remove('visible'));
            alertModal.classList.add('visible');
        }
        
        function showConfirmation(title, message, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            confirmModal.classList.add('visible');
            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => { onConfirm(); confirmModal.classList.remove('visible'); });
        }
        document.getElementById('confirm-modal-cancel').addEventListener('click', () => confirmModal.classList.remove('visible'));

        function setupModal(modalElement, inputId, saveButtonId, cancelButtonId) {
            const input = modalElement.querySelector(`#${inputId}`);
            const cancelBtn = modalElement.querySelector(`#${cancelButtonId}`);
            const show = (currentValue, onSave) => {
                const saveBtn = modalElement.querySelector(`#${saveButtonId}`);
                input.value = currentValue;
                modalElement.classList.add('visible');
                input.focus();
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                newSaveBtn.addEventListener('click', async () => { await onSave(input.value.trim()); hide(); });
            };
            const hide = () => modalElement.classList.remove('visible');
            cancelBtn.addEventListener('click', hide);
            return { show };
        }

        const namePrompt = setupModal(document.getElementById('name-modal'), 'name-modal-input', 'name-modal-save', 'name-modal-cancel');
        const costumePrompt = setupModal(document.getElementById('costume-modal'), 'costume-modal-input', 'costume-modal-save', 'costume-modal-cancel');
        const descriptionPrompt = setupModal(document.getElementById('description-modal'), 'description-modal-input', 'description-modal-save', 'description-modal-cancel');
        
        const generateId = () => Math.random().toString(36).substr(2, 6).toUpperCase();

        document.getElementById('copy-code-btn')?.addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('contest-code').textContent).then(() => customAlert("Copiado", "C√≥digo de sala copiado.")).catch(() => customAlert("Error", "No se pudo copiar."));
        });

        async function deleteContest(contestIdToDelete) {
            loadingOverlay.classList.remove('hidden');
            document.getElementById('loading-text').textContent = 'Eliminando Sala...';
            try {
                const usersSnapshot = await getDocs(getUsersCollectionRef(contestIdToDelete));
                const batch = writeBatch(db);
                for (const userDoc of usersSnapshot.docs) {
                    const votesSnapshot = await getDocs(getVotesCollectionRef(contestIdToDelete, userDoc.id));
                    votesSnapshot.forEach(voteDoc => batch.delete(voteDoc.ref));
                    batch.delete(userDoc.ref);
                }
                batch.delete(getContestRef(contestIdToDelete));
                await batch.commit();
            } catch (error) {
                console.error("Error deleting contest:", error);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function leaveContest() {
            const contestIdToLeave = contestId;
            const isOrganizer = localContestData.creatorId === currentUserId;
            const shouldDeleteContest = (isOrganizer && localContestData.status === 'lobby') || (isOrganizer && localContestData.status === 'finalized');

            if (contestUnsubscribe) contestUnsubscribe();
            if (usersUnsubscribe) usersUnsubscribe();
            contestUnsubscribe = null;
            usersUnsubscribe = null;

            const oldLocalData = { ...localContestData };
            contestId = null;
            localContestData = {};
            window.location.hash = '';
            showScreen('home');

            if (contestIdToLeave && currentUserId) {
                if (shouldDeleteContest) {
                    await deleteContest(contestIdToLeave);
                } else if (!isOrganizer) {
                    await deleteDoc(getUserRef(contestIdToLeave, currentUserId));
                }
            }
        }
        
        function processImage(base64Image) {
             return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const MAX_SIDE = 400; let { width, height } = img;
                    if (width > MAX_SIDE || height > MAX_SIDE) { if (width > height) { height *= MAX_SIDE / width; width = MAX_SIDE; } else { width *= MAX_SIDE / height; height = MAX_SIDE; } }
                    const canvas = Object.assign(document.createElement('canvas'), { width, height });
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.onerror = () => reject(new Error("Error al cargar imagen para procesar."));
                img.src = base64Image;
            });
        }
        
        document.getElementById('image-choice-upload').addEventListener('click', () => {
            imageChoiceModal.classList.remove('visible');
            document.getElementById('image-file-input').click();
        });

        document.getElementById('image-choice-generate').addEventListener('click', () => {
            if (!checkAndPromptForKey()) return;
            imageChoiceModal.classList.remove('visible');
            const preview = document.getElementById('image-generation-preview');
            const status = document.getElementById('image-generation-status');
            const saveBtn = document.getElementById('image-generation-save');

            if (existingImageForGenerator) {
                preview.src = existingImageForGenerator;
                preview.classList.remove('hidden');
                status.classList.add('hidden');
                saveBtn.disabled = false;
                generatedImageBase64 = existingImageForGenerator;
            } else {
                preview.src = '';
                preview.classList.add('hidden');
                status.innerHTML = '<p>Define tu idea y presiona "Generar".</p>';
                status.classList.remove('hidden');
                saveBtn.disabled = true;
                generatedImageBase64 = null;
            }
            imageGenerationModal.classList.add('visible');
        });
        document.getElementById('image-choice-cancel').addEventListener('click', () => imageChoiceModal.classList.remove('visible'));

        const imageFileInput = document.getElementById('image-file-input');
        imageFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            loadingOverlay.classList.remove('hidden');
            document.getElementById('loading-text').textContent = 'Procesando Imagen...';
            try {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const processed = await processImage(event.target.result);
                    await updateDoc(getUserRef(contestId, targetUserIdForImage), { costumeImageBase64: processed });
                    imageFileInput.value = '';
                };
                reader.readAsDataURL(file);
            } catch (error) {
                customAlert("Error de Imagen", error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        const getImageTag = (b64, cls, alt) => b64 ? `<img src="${b64}" class="${cls}" alt="${alt}">` : `<div class="${cls} bg-gray-700 flex items-center justify-center rounded-sm"><span class="text-gray-400 text-xs">IMG</span></div>`;

        function renderScoringInputs(containerSelector = '#scoring-inputs', scoreValueSelector = '.score-value', currentScore = currentJurorScore) {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            container.innerHTML = `<div class="text-center"><label class="block mb-4 text-xl font-bold">Puntaje: <span class="${scoreValueSelector.substring(1)} text-orange-400 font-creepster text-3xl">${currentScore}</span></label><div class="pumpkin-icons">${Array(MAX_PUMPKINS).fill(0).map((_,i)=>`<span class="pumpkin-icon" data-value="${i+1}">üéÉ</span>`).join('')}</div></div>`;
            updatePumpkinSelection(currentScore, container);
        }

        const updatePumpkinSelection = (score, parentElement = document) => parentElement.querySelectorAll('.pumpkin-icon').forEach(p => p.classList.toggle('selected', p.dataset.value <= score));

        async function setInitialJurorScore(participantId) {
            if (!participantId || !currentUserId) return;
            const q = query(getVotesCollectionRef(contestId, participantId), where("jurorId", "==", currentUserId));
            const snap = await getDocs(q); let hasVoted = false; currentJurorScore = 5;
            if (!snap.empty) { currentJurorScore = snap.docs[0].data().score; hasVoted = true; }
            const scoreSpan = document.querySelector('#scoring-inputs .score-value'); if (scoreSpan) scoreSpan.textContent = currentJurorScore;
            updatePumpkinSelection(currentJurorScore);
            const btn = document.getElementById('submit-vote-btn'); if (btn) { btn.disabled = hasVoted; btn.textContent = hasVoted ? 'Voto Enviado' : 'Enviar Voto'; btn.classList.toggle('ready-to-send', !hasVoted); }
        }

        function attachScoringListeners() {
            document.querySelector('#voter-voting-view').addEventListener('click', (e) => {
                const target = e.target.closest('.pumpkin-icon'); if (!target) return;
                const parentModal = target.closest('.modal-backdrop');
                if (parentModal && parentModal.id === 'catchup-vote-modal') return; // Handled by modal-specific listener
                currentJurorScore = parseInt(target.dataset.value);
                document.querySelector('#scoring-inputs .score-value').textContent = currentJurorScore;
                updatePumpkinSelection(currentJurorScore);
                const btn = document.getElementById('submit-vote-btn'); if (btn.disabled) { btn.disabled = false; btn.textContent = 'Enviar Voto'; btn.classList.add('ready-to-send'); }
            });
        }
        
        document.getElementById('create-contest-btn').addEventListener('click', () => { contestId = generateId(); window.location.hash = contestId; showScreen('register'); });
        
        document.getElementById('join-contest-btn').addEventListener('click', async () => {
            const id = document.getElementById('contest-id-input').value.trim().toUpperCase();

            if (id === 'HALLOWEENDPC') {
                document.getElementById('home-screen').classList.add('hidden');
                easterEggOverlay.classList.remove('hidden');
                let tapCount = 0;
                let tapTimeout = null;
                const exitEasterEgg = () => {
                    tapCount = 0;
                    clearTimeout(tapTimeout);
                    easterEggOverlay.classList.add('hidden');
                    document.getElementById('home-screen').classList.remove('hidden');
                    easterEggOverlay.removeEventListener('click', handleTap);
                };
                const handleTap = () => {
                    clearTimeout(tapTimeout);
                    tapCount++;
                    if (tapCount >= 3) {
                        exitEasterEgg();
                    } else {
                        tapTimeout = setTimeout(() => { tapCount = 0; }, 800);
                    }
                };
                easterEggOverlay.addEventListener('click', handleTap);
                return;
            }

            if (id === 'DEBUGMODE') {
                 initializeDebugMode();
                 return;
            }
            if (!id) return;
            if ((await getDoc(getContestRef(id))).exists()) { contestId = id; window.location.hash = id; showScreen('register'); } else { customAlert("Error", "Sala no encontrada."); }
        });

        document.getElementById('back-to-home-btn').addEventListener('click', leaveContest);
        document.getElementById('leave-lobby-btn').addEventListener('click', leaveContest);

        document.getElementById('register-btn').addEventListener('click', async () => {
            const name = document.getElementById('user-name-input').value.trim(); if (!name) return customAlert("Error", "Nombre requerido.");
            loadingOverlay.classList.remove('hidden');
            document.getElementById('loading-text').textContent = 'Registrando...';
            const costume = document.getElementById('costume-name-input').value.trim();
            const isCreator = !(await getDoc(getContestRef(contestId))).exists();
            if (isCreator) { await setDoc(getContestRef(contestId), { status: "lobby", creatorId: currentUserId }); }
            await setDoc(getUserRef(contestId, currentUserId), { name, costume, isParticipant: !!costume, isJuror: false, hasVoted: false, totalScore: 0, costumeDescription: '', isManualEntry: false });
            subscribeToContest(contestId);
        });
        
        const showScreen = name => { 
            Object.values(screens).forEach(s => s.classList.add('hidden')); 
            screens[name]?.classList.remove('hidden'); 
            
            if (isInDebugMode) {
                debugBackButtonContainer.classList.toggle('hidden', name === 'debug' || name === 'home');
            }

            loadingOverlay.classList.add('hidden');
        };

        function subscribeToContest(id) {
            if (contestUnsubscribe) contestUnsubscribe();
            contestUnsubscribe = onSnapshot(getContestRef(id), async (doc) => {
                if (!doc.exists()) { leaveContest(); customAlert("Error", "La sala ha sido eliminada."); return; }
                const oldStatus = localContestData.status;
                localContestData = { id: doc.id, ...doc.data() };
                
                const newStatus = localContestData.status;
                const isAdmin = localContestData.creatorId === currentUserId;

                if (newStatus === 'finalized') {
                    showFeedbackModal(localContestData.finalMessage);
                    return;
                }

                document.getElementById('paused-modal').classList.toggle('visible', newStatus === 'paused' && !isAdmin);

                if (newStatus === 'voting' && oldStatus === 'lobby') {
                    previousRevealStep = 0; // Reset for a new voting round
                    const meSnapshot = await getDoc(getUserRef(contestId, currentUserId));
                    if(meSnapshot.exists()) {
                        const me = meSnapshot.data();
                         if (!me.isManualEntry) {
                             let alertTitle = ''; let alertMessage = '';
                             if (me.isJuror && me.isParticipant) { alertTitle = "¬°Atenci√≥n! Tienes Doble Rol"; alertMessage = "Eres Jurado y Participante. No podr√°s votar por ti mismo."; } 
                             else if (me.isJuror) { alertTitle = "¬°Atenci√≥n, Jurado!"; alertMessage = "Tu voto es crucial. Mantente atento durante todo el evento."; } 
                             else if (me.isParticipant) { alertTitle = "¬°El Concurso ha Empezado!"; alertMessage = "Mantente atento a los llamados del organizador. ¬°Mucha suerte!"; }
                             if(alertTitle) customAlert(alertTitle, alertMessage);
                        }
                    }
                }

                const onDeckData = localContestData.onDeck || {};
                const isUpData = localContestData.isUp || {};

                if (onDeckData.userId === currentUserId && onDeckData.status === 'called') {
                    const isFirstCall = !localContestData.votedOnParticipants || localContestData.votedOnParticipants.length === 0;
                    if(isFirstCall) {
                        document.getElementById('on-deck-title').textContent = "¬°Rompe el Hielo!";
                        document.getElementById('on-deck-message').textContent = "Eres el primero en pasar. ¬øEst√°s listo?";
                    } else {
                        document.getElementById('on-deck-title').textContent = "¬°Prep√°rate!";
                        document.getElementById('on-deck-message').textContent = "Eres el siguiente en pasar. ¬øEst√°s listo?";
                    }

                    onDeckModal.classList.add('visible'); 
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                }
                if (isUpData.userId === currentUserId) {
                    isUpModal.classList.add('visible'); if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
                }

                if (newStatus === 'paused' && isAdmin) {
                    showScreen('lobby');
                    subscribeToUsers(id, renderLobby);
                } else {
                    const screenMap = { lobby: 'lobby', voting: 'voting', paused: 'voting', tiebreaker: 'voting', results: 'results' };
                    const rendererMap = { lobby: renderLobby, voting: renderVotingScreen, paused: renderVotingScreen, tiebreaker: renderVotingScreen, results: renderResults };
                    showScreen(screenMap[newStatus]);
                    if (rendererMap[newStatus]) subscribeToUsers(id, rendererMap[newStatus]);
                }
            });
        }
        
        document.getElementById('on-deck-ready').addEventListener('click', async () => {
            onDeckModal.classList.remove('visible');
            await updateDoc(getContestRef(contestId), { 'onDeck.status': 'acknowledged' });
        });
        document.getElementById('on-deck-not-ready').addEventListener('click', async () => {
            onDeckModal.classList.remove('visible');
            await updateDoc(getContestRef(contestId), { 'onDeck.status': 'not_ready' });
        });
        document.getElementById('is-up-close').addEventListener('click', async () => {
            isUpModal.classList.remove('visible');
            if (localContestData.isUp && localContestData.isUp.userId) {
                await updateDoc(getContestRef(contestId), { isUp: null, acknowledgedUp: localContestData.isUp.userId });
            }
        });

        function subscribeToUsers(id, renderer) {
            if (usersUnsubscribe) usersUnsubscribe();
            usersUnsubscribe = onSnapshot(getUsersCollectionRef(id), (snap) => renderer(localContestData, snap.docs.map(d => ({ id: d.id, ...d.data() }))));
        }
        
        function renderLobby(contestData, users) {
            document.getElementById('contest-code').textContent = contestId;
            const isAdmin = contestData.creatorId === currentUserId;
            document.getElementById('admin-controls').classList.toggle('hidden', !isAdmin);
            document.getElementById('wait-for-admin').classList.toggle('hidden', isAdmin);
            document.getElementById('open-settings-btn').classList.toggle('hidden', !isAdmin);
            
            const startBtn = document.getElementById('start-contest-btn');
            startBtn.textContent = contestData.status === 'paused' ? 'Reanudar Votaci√≥n' : '¬°Comenzar Votaci√≥n!';

            const list = document.getElementById('users-list'); list.innerHTML = '';
            const sortedUsers = [...users].sort((a, b) => a.name.localeCompare(b.name)).sort((a,b) => (a.id === currentUserId) ? -1 : (b.id === currentUserId) ? 1 : 0);
            
            sortedUsers.forEach(user => {
                const isMe = user.id === currentUserId;
                const canEdit = isAdmin || isMe;
                const adminCanDelete = isAdmin && user.id !== currentUserId;
                const adminCanEditParticipant = isAdmin && user.isParticipant;

                const nameActions = `
                    ${canEdit ? `<button data-action="edit-name" data-userid="${user.id}" class="p-1 rounded bg-gray-700 hover:bg-gray-600" title="Editar nombre">‚úèÔ∏è</button>` : ''}
                    ${isAdmin && user.isManualEntry ? `<button data-action="link-user" data-userid="${user.id}" class="p-1 rounded bg-gray-700 hover:bg-gray-600" title="Enlazar usuario">üîó</button>` : ''}
                    ${adminCanDelete ? `<button data-action="delete-user" data-userid="${user.id}" class="p-1 rounded bg-red-800/80 hover:bg-red-700" title="Eliminar participante">‚ùå</button>` : ''}
                `;
                const costumeActions = `
                    ${canEdit ? `<button data-action="edit-costume" data-userid="${user.id}" class="p-1 rounded bg-gray-700 hover:bg-gray-600" title="Editar disfraz">‚úèÔ∏è</button>` : ''}
                    ${adminCanEditParticipant ? `<button data-action="edit-description" data-userid="${user.id}" data-costume="${user.costume}" class="p-1 rounded bg-gray-700 hover:bg-gray-600" title="Editar/Generar descripci√≥n">‚ú®</button>` : ''}
                `;

                const onlineIndicator = !user.isManualEntry ? `<span class="h-2 w-2 rounded-full bg-green-500 inline-block mr-2" title="Conectado"></span>` : `<span class="h-2 w-2 rounded-full bg-gray-600 inline-block mr-2" title="A√±adido manualmente"></span>`;
                const imgTag = getImageTag(user.costumeImageBase64, 'image-preview-sm flex-shrink-0', user.costume);
                const imgContainer = canEdit ? `<div class="editable-image-container mr-3" data-action="edit-image" data-userid="${user.id}" data-costume="${user.costume}" data-description="${user.costumeDescription}">${imgTag}<div class="editable-image-overlay">üì∏</div></div>` : `<div class="mr-3">${imgTag}</div>`;
                
                const rolesHTML = isAdmin ? `<div class="flex items-center gap-4 pt-2 border-t border-gray-700 mt-2"><label class="toggle-label flex-1"><span>Participa</span><input type="checkbox" class="toggle-checkbox" data-role="isParticipant" data-userid="${user.id}" ${user.isParticipant?'checked':''}><div class="toggle-switch"></div></label><label class="toggle-label flex-1"><span>Jurado</span><input type="checkbox" class="toggle-checkbox" data-role="isJuror" data-userid="${user.id}" ${user.isJuror?'checked':''}><div class="toggle-switch"></div></label></div>` : `<div class="text-sm text-orange-400 mt-1">${user.isParticipant?'Participante':''} ${user.isJuror?(user.isParticipant?'/ Jurado':'Jurado'):''}</div>`;
                
                const item = document.createElement('div'); 
                item.className = `bg-gray-800 p-3 rounded-lg ${isMe ? 'border-2 border-orange-500' : ''}`;
                item.innerHTML = `
                    <div class="flex items-center">
                        ${imgContainer}
                        <div class="flex-grow">
                            <div class="font-bold flex justify-between items-center">
                                <div class="flex items-center">${onlineIndicator}<span>${user.name} ${isMe?'(T√∫)':''}</span></div>
                                <div class="flex items-center gap-1">${nameActions}</div>
                            </div>
                            <div class="text-sm text-gray-300 flex justify-between items-center mt-1">
                                <span>${user.costume?.trim() ? user.costume : 'No concursa'}</span>
                                <div class="flex items-center gap-1">${costumeActions}</div>
                            </div>
                        </div>
                    </div>
                    ${rolesHTML}
                `;
                list.appendChild(item);
            });

            list.onclick = (e) => {
                const target = e.target.closest('[data-action], [data-role]'); if (!target) return;
                const userId = target.dataset.userid;
                const user = users.find(u => u.id === userId);
                const action = target.dataset.action;
                
                targetUserIdForImage = userId;

                if (action === 'delete-user') showConfirmation('Eliminar Usuario', `¬øEst√°s seguro de que quieres eliminar a ${user.name}?`, () => deleteDoc(getUserRef(contestId, userId)));
                else if (action === 'link-user') {
                    const onlineUsers = users.filter(u => !u.isManualEntry);
                    const linkUserList = document.getElementById('link-user-list');
                    linkUserList.innerHTML = '';
                    if (onlineUsers.length > 0) {
                        document.getElementById('link-user-modal-message').textContent = `Selecciona el usuario conectado para enlazarlo al perfil de ${user.name}:`;
                        onlineUsers.forEach(onlineUser => {
                            const userButton = document.createElement('button');
                            userButton.className = 'btn-secondary w-full text-left p-3';
                            userButton.textContent = `${onlineUser.name} ${onlineUser.id === currentUserId ? '(T√∫)' : ''}`;
                            userButton.onclick = () => {
                                linkUserModal.classList.remove('visible');
                                showConfirmation('Enlazar Perfiles', `¬øAsignar a ${onlineUser.name} al perfil de ${user.name}?`, async () => {
                                    loadingOverlay.classList.remove('hidden'); document.getElementById('loading-text').textContent = 'Enlazando...';
                                    const placeholderData = (await getDoc(getUserRef(contestId, user.id))).data();
                                    await updateDoc(getUserRef(contestId, onlineUser.id), { ...placeholderData, isManualEntry: false });
                                    await deleteDoc(getUserRef(contestId, user.id));
                                    loadingOverlay.classList.add('hidden');
                                });
                            };
                            linkUserList.appendChild(userButton);
                        });
                    } else document.getElementById('link-user-modal-message').textContent = 'No hay usuarios conectados para enlazar.';
                    linkUserModal.classList.add('visible');
                }
                else if (action === 'edit-name') namePrompt.show(user?.name || '', async val => { if(val) await updateDoc(getUserRef(contestId, userId), { name: val }); });
                else if (action === 'edit-costume') costumePrompt.show(user?.costume || '', async val => await updateDoc(getUserRef(contestId, userId), { costume: val, isParticipant: !!val }));
                else if (action === 'edit-image') {
                    existingImageForGenerator = user.costumeImageBase64 || null;
                    const costumeName = target.dataset.costume;
                    const description = target.dataset.description;
                    if(description?.trim()){
                         document.getElementById('image-generation-prompt').value = `Ilustraci√≥n detallada de ${costumeName}. El protagonista es ${description} en s√≠ mismo, representado v√≠vidamente y con gran detalle. Est√° ubicado en un ambiente ic√≥nico y atmosf√©rico de Halloween. Estilo de arte conceptual, cuerpo completo, colores apropiados y una atm√≥sfera inmersiva.`;
                    } else {
                        document.getElementById('image-generation-prompt').value = `Ilustraci√≥n detallada de un personaje con un disfraz de '${costumeName}'. Estilo de arte conceptual, cuerpo completo, colores vibrantes en un ambiente de Halloween.`;
                    }
                    document.getElementById('image-choice-generate').classList.toggle('hidden', !isAdmin);
                    imageChoiceModal.classList.add('visible');
                }
                else if (action === 'edit-description') {
                    const descInput = document.getElementById('description-modal-input');
                    const genBtn = document.getElementById('description-modal-generate');
                    descriptionPrompt.show(user?.costumeDescription || '', val => updateDoc(getUserRef(contestId, userId), { costumeDescription: val }));
                    const newGenBtn = genBtn.cloneNode(true);
                    genBtn.parentNode.replaceChild(newGenBtn, genBtn);
                    newGenBtn.onclick = async () => {
                        if (!checkAndPromptForKey()) return;
                        if (!user.costume) return customAlert("Error", "El participante necesita un disfraz para generar una descripci√≥n.");
                        newGenBtn.disabled = true; newGenBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                        try { descInput.value = await generateDescriptionWithGemini(user.costume); }
                        catch (error) { customAlert("Error de IA", error.message); }
                        finally { newGenBtn.disabled = false; newGenBtn.innerHTML = '‚ú® Generar con IA'; }
                    };
                } else if (target.dataset.role) {
                    if (target.dataset.role === 'isParticipant' && target.checked && !user.costume?.trim()) { target.checked = false; customAlert("Disfraz Requerido", "A√±ade un nombre de disfraz antes de marcarlo como participante."); costumePrompt.show('', async val => { if (val) await updateDoc(getUserRef(contestId, userId), { costume: val, isParticipant: true }); }); }
                    else { updateDoc(getUserRef(contestId, userId), { [target.dataset.role]: target.checked }); }
                }
            };
            document.getElementById('link-user-modal-cancel').onclick = () => linkUserModal.classList.remove('visible');
        }
        
        async function calculateFullRanking(contestId) {
             const usersSnapshot = await getDocs(getUsersCollectionRef(contestId));
            const allUsers = usersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            const participants = allUsers.filter(u => u.isParticipant);
            const results = [];
            for (const p of participants) {
                const votesSnapshot = await getDocs(getVotesCollectionRef(contestId, p.id));
                 const totalScore = votesSnapshot.docs.reduce((sum, doc) => sum + doc.data().score, 0);
                 const voteCount = votesSnapshot.size;
                 const averageScore = voteCount > 0 ? totalScore / voteCount : 0;
                results.push({ ...p, voteCount: voteCount, overallScore: averageScore });
            }
            return results.sort((a, b) => b.overallScore - a.overallScore);
        }
        
        async function renderVotingScreen(contestData, users) {
            const isAdmin = contestData.creatorId === currentUserId;
            const me = users.find(u => u.id === currentUserId);
            const isJuror = me?.isJuror;
            const isTiebreaker = contestData.status === 'tiebreaker';

            document.getElementById('voting-screen-title').textContent = isTiebreaker ? `Desempate por el ${contestData.tiebreakerInfo.rank}¬∫ Lugar` : 'Votaci√≥n en Progreso';
            document.getElementById('admin-voting-view').classList.toggle('hidden', !isAdmin); 
            document.getElementById('voter-voting-view').classList.remove('hidden');
            
            let participants = users.filter(u => u.isParticipant);
            if (isTiebreaker) participants = participants.filter(p => contestData.tiebreakerInfo.participantIds.includes(p.id));
            
            const jurors = users.filter(u => u.isJuror);
            const currentPId = contestData.currentlyVotingFor;
            const currentP = users.find(u => u.id === currentPId);
            
            if (isAdmin) {
                const view = document.getElementById('admin-voting-view');
                let html = `<div class="mb-4 pb-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-bold">Panel de Votaci√≥n</h3><button id="pause-contest-btn" class="btn-secondary bg-yellow-600 hover:bg-yellow-700 text-sm py-2 px-3">Pausar</button></div>`;
                
                const allVoted = participants.length > 0 && participants.every(p => contestData.votedOnParticipants?.includes(p.id));
                if (allVoted && !isTiebreaker) {
                    html += `<button id="calculate-results-btn" class="btn-primary w-full bg-green-600 hover:bg-green-700 mt-4">Calcular y Ver Resultados</button>`;
                } else if (allVoted && isTiebreaker) {
                    html += `<button id="calculate-results-btn" class="btn-primary w-full bg-purple-600 hover:bg-purple-700 mt-4">Finalizar Desempate y Ver Ganador</button>`;
                } else {
                    html += `<div class="space-y-2 mb-4 mt-4">`;
                    const votingJurorsForCurrentP = currentP ? jurors.filter(j => j.id !== currentP.id) : [];
                    const allVotesIn = currentP ? (await getDocs(getVotesCollectionRef(contestId, currentP.id))).size >= votingJurorsForCurrentP.length : false;

                    participants.forEach(p => { 
                        const isSelected = p.id === selectedForActionId;
                        const evaluated = contestData.votedOnParticipants?.includes(p.id);
                        const voting = p.id === currentPId;
                        let participantClasses = `flex justify-between items-center p-3 rounded-lg cursor-pointer bg-gray-800`;
                        if(evaluated) participantClasses += ' participant-evaluated';
                        if(voting) participantClasses += ' participant-evaluating';
                        if(isSelected) participantClasses += ' border-2 border-blue-500';

                        const onDeck = contestData.onDeck?.userId === p.id, onDeckStatus = onDeck ? contestData.onDeck.status : null;
                        const isUp = contestData.isUp?.userId === p.id, acknowledgedUp = contestData.acknowledgedUp === p.id;
                        
                        let statusIcon = !p.isManualEntry ? 'üü¢' : '';
                        if (isUp) statusIcon = 'üö®'; else if (acknowledgedUp) statusIcon = '‚úÖ'; else if (onDeck) {
                            if (onDeckStatus === 'acknowledged') statusIcon = '‚úÖ'; else if (onDeckStatus === 'not_ready') statusIcon = '‚è≥'; else statusIcon = 'üì£';
                        }

                        let statusText = 'Pendiente', statusColor = 'text-yellow-400';
                        if(evaluated) { statusText = 'Evaluado'; statusColor = 'text-green-400'; }
                        if(voting) { statusText = allVotesIn ? 'Votaci√≥n Completa' : 'Evaluando...'; statusColor = allVotesIn ? 'text-green-400' : 'text-yellow-400'; }
                        
                        html += `<div data-userid="${p.id}" data-is-online="${!p.isManualEntry}" class="${participantClasses}"><div><p class="font-bold flex items-center"><span class="mr-2 text-xs" title="Conectado">${statusIcon}</span>${p.name}</p><p class="text-sm text-gray-400">${p.costume}</p></div><span class="text-sm ${statusColor}">${statusText}</span></div>`; 
                    });
                    html += `</div>`; 

                    if(selectedForActionId) {
                        const selectedUser = users.find(u=> u.id === selectedForActionId), canCall = selectedUser && !selectedUser.isManualEntry;
                        const isEvaluated = contestData.votedOnParticipants?.includes(selectedForActionId);
                        const callBtnClasses = `btn-secondary w-1/2 ${canCall ? 'bg-cyan-600 hover:bg-cyan-700' : ''}`;

                        html += `<div class="mt-6 p-4 bg-gray-700 rounded-xl"><h4 class="font-bold text-yellow-400">Acciones para: ${selectedUser.name}</h4><div class="flex gap-2 mt-4">`;
                        if(isEvaluated) html += `<button id="admin-reopen-btn" class="btn-secondary w-full bg-yellow-600 hover:bg-yellow-700">üîÑ Reiniciar Votos</button>`;
                        else html += `<button id="admin-call-btn" class="${callBtnClasses}" ${!canCall ? 'disabled' : ''}>üì£ Llamar</button><button id="admin-eval-btn" class="btn-primary w-1/2">Evaluar</button>`;
                        html +=`</div></div>`;
                    }
                }

                view.innerHTML = html;
                view.onclick = async e => { 
                    const target = e.target.closest('button, [data-userid]'); if (!target) return; 
                    if (target.dataset.userid) { selectedForActionId = target.dataset.userid === selectedForActionId ? null : target.dataset.userid; return renderVotingScreen(contestData, users); }
                    
                    if (target.id === 'pause-contest-btn') return await updateDoc(getContestRef(contestId), { status: 'paused' });
                    if (target.id === 'calculate-results-btn') return await calculateAndFinalizeResults(users);
                    
                    if (selectedForActionId) {
                        const actionMap = {
                            'admin-call-btn': async () => {
                                const onDeck = contestData.onDeck;
                                const update = (onDeck && onDeck.userId === selectedForActionId) || contestData.acknowledgedUp === selectedForActionId
                                    ? { isUp: { userId: selectedForActionId }, onDeck: null, acknowledgedUp: null }
                                    : { onDeck: { userId: selectedForActionId, status: 'called' }, isUp: null, acknowledgedUp: null };
                                await updateDoc(getContestRef(contestId), update);
                            },
                            'admin-eval-btn': async () => {
                                const batch = writeBatch(db); 
                                jurors.forEach(j => batch.update(getUserRef(contestId, j.id), { hasVoted: false })); 
                                batch.update(getContestRef(contestId), { currentlyVotingFor: selectedForActionId, onDeck: null, isUp: null, acknowledgedUp: null }); 
                                await batch.commit();
                                selectedForActionId = null;
                            },
                            'admin-reopen-btn': async () => {
                                const batch = writeBatch(db); 
                                const votes = await getDocs(getVotesCollectionRef(contestId, selectedForActionId)); 
                                votes.forEach(v => batch.delete(v.ref)); 
                                batch.update(getContestRef(contestId), { votedOnParticipants: contestData.votedOnParticipants.filter(id => id !== selectedForActionId) });
                                if (isTiebreaker) { // Reset tiebreaker if a vote is reopened
                                     batch.update(getContestRef(contestId), { status: 'voting', tiebreakerInfo: null });
                                }
                                await batch.commit();
                                selectedForActionId = null;
                            }
                        };
                        if (actionMap[target.id]) await actionMap[target.id]();
                    }
                };
            }

            const votingDiv = document.getElementById('currently-voting-for'), jurorControls = document.getElementById('juror-controls');
            const selfVoteMessage = document.getElementById('self-vote-message'), pendingJurorsList = document.getElementById('pending-jurors-list-voter');
            const pendingJurorsContainer = document.getElementById('pending-jurors-list-container');

            if (isJuror) {
                const votedOnIds = contestData.votedOnParticipants || [];
                const catchupParticipants = [];
                for (const participantId of votedOnIds) {
                    if (participantId === currentUserId) continue;
                    const voteSnap = await getDoc(doc(getVotesCollectionRef(contestId, participantId), currentUserId));
                    if (!voteSnap.exists()) {
                        const p = users.find(u => u.id === participantId);
                        if (p) catchupParticipants.push(p);
                    }
                }
                renderCatchupList(catchupParticipants);
            }

            if(currentP) { 
                pendingJurorsContainer.classList.remove('hidden');
                votingDiv.innerHTML = `${getImageTag(currentP.costumeImageBase64,'image-preview-lg mx-auto',currentP.costume)}<h3 class="font-creepster text-5xl text-orange-400 mt-4">${currentP.name}</h3><p class="text-2xl">"${currentP.costume}"</p>${currentP.costumeDescription ? `<p class="text-lg text-gray-300 mt-2 italic">"${currentP.costumeDescription}"</p>` : ''}`; 
                const selfVote = me?.isParticipant && me.id === currentP.id;
                jurorControls.classList.toggle('hidden', !isJuror);
                if (isJuror) {
                    selfVoteMessage.classList.toggle('hidden', !selfVote);
                    ['#scoring-inputs', '#submit-vote-btn', 'h3'].forEach(sel => jurorControls.querySelector(sel).classList.toggle('hidden', selfVote));
                    if (!selfVote) { renderScoringInputs(); await setInitialJurorScore(currentPId); }
                }
                const votes = (await getDocs(getVotesCollectionRef(contestId,currentP.id))).docs.map(d=>d.data().jurorId); 
                const pending = jurors.filter(j => !votes.includes(j.id) && j.id !== currentP.id);
                pendingJurorsList.innerHTML=pending.length?pending.map(j=>`<li>${j.name}</li>`).join(''):`<li class="text-green-400">¬°Todos votaron!</li>`;
                const votingJurors = jurors.filter(j => j.id !== currentP.id);
                if(isAdmin && votes.length >= votingJurors.length && !contestData.votedOnParticipants?.includes(currentPId)) {
                    await updateDoc(getContestRef(contestId), { currentlyVotingFor: null, votedOnParticipants: [...(contestData.votedOnParticipants || []), currentPId] });
                }
            } else { 
                pendingJurorsContainer.classList.add('hidden');
                const allVoted = participants.length > 0 && participants.every(p => contestData.votedOnParticipants?.includes(p.id));
                votingDiv.innerHTML = `<h3 class="text-2xl text-gray-400">${allVoted ? '¬°Votaci√≥n Finalizada!' :'Esperando concursante...'}</h3>`; 
                jurorControls.classList.add('hidden'); 
            }
            
            const votedIds = contestData.votedOnParticipants || [];
            const sortedVoted = participants.filter(p=>votedIds.includes(p.id)).sort((a,b) => (a.id === currentUserId && a.isParticipant) ? -1 : (b.id === currentUserId && b.isParticipant) ? 1 : 0);
            const sortedPending = participants.filter(p=>!votedIds.includes(p.id)&&p.id!==currentPId).sort((a,b) => (a.id === currentUserId && a.isParticipant) ? -1 : (b.id === currentUserId && b.isParticipant) ? 1 : 0);

            document.getElementById('voted-list').innerHTML = sortedVoted.map(p=>`<li class="${p.id === currentUserId && p.isParticipant ? 'participant-me p-1 rounded' : ''}">${p.name}</li>`).join(''); 
            document.getElementById('pending-list').innerHTML = sortedPending.map(p=>`<li class="${p.id === currentUserId && p.isParticipant ? 'participant-me p-1 rounded' : ''}">${p.name}</li>`).join('');
        }
        
        async function calculateAndFinalizeResults(allUsers) {
            loadingOverlay.classList.remove('hidden');
            document.getElementById('loading-text').textContent = 'Calculando Resultados...';

            const results = await calculateFullRanking(contestId);
            if (results.length === 0) {
                 await updateDoc(getContestRef(contestId), { status: 'results', topResults: JSON.stringify([]) });
                 loadingOverlay.classList.add('hidden');
                 return;
            }

            const groupedByScore = results.reduce((acc, p) => {
                const score = p.overallScore.toFixed(3); // Group by a fixed precision
                if (!acc[score]) acc[score] = [];
                acc[score].push(p);
                return acc;
            }, {});

            let rank = 1;
            let finalResults = [];
            const sortedScores = Object.keys(groupedByScore).sort((a,b) => b-a);
            
            for(const score of sortedScores){
                const group = groupedByScore[score];
                if(rank <= 3 && group.length > 1){
                    const isTiebreaker = localContestData.status === 'tiebreaker';
                    const tieIsForCurrentRank = isTiebreaker && localContestData.tiebreakerInfo.rank === rank;

                    if (!isTiebreaker || !tieIsForCurrentRank) {
                        customAlert("¬°Empate Detectado!", `Hay un empate por el ${rank}¬∫ lugar. Se iniciar√° una ronda de desempate.`);
                        const batch = writeBatch(db);
                        batch.update(getContestRef(contestId), { status: 'tiebreaker', votedOnParticipants: [], currentlyVotingFor: null, tiebreakerInfo: { rank, participantIds: group.map(p => p.id) } });
                        // Reset votes for tied participants
                         for (const p of group) {
                            const votesSnapshot = await getDocs(getVotesCollectionRef(contestId, p.id));
                            votesSnapshot.forEach(voteDoc => batch.delete(voteDoc.ref));
                        }
                        await batch.commit();
                        loadingOverlay.classList.add('hidden');
                        return;
                    }
                }
                group.forEach(p => finalResults.push({ ...p, rank }));
                rank += group.length;
            }

            const top3 = finalResults.filter(r => r.rank <= 3);
            await updateDoc(getContestRef(contestId), { status: 'results', topResults: JSON.stringify(top3), tiebreakerInfo: null });
            loadingOverlay.classList.add('hidden');
        }

        function renderCatchupList(participants) {
            const container = document.getElementById('catchup-list-container');
            if (participants.length === 0) return container.classList.add('hidden');
            
            container.classList.remove('hidden');
            let html = `<h3 class="font-bold text-xl mb-3 text-center text-blue-300">Votos Pendientes (Ponte al d√≠a)</h3><div class="space-y-2">`;
            participants.forEach(p => {
                html += `<button data-catchup-userid="${p.id}" class="w-full text-left p-3 rounded-lg bg-gray-800 hover:bg-gray-700">${p.name} - <i>${p.costume}</i></button>`;
            });
            html += `</div>`;
            container.innerHTML = html;

            container.onclick = e => {
                const target = e.target.closest('[data-catchup-userid]');
                if (!target) return;
                const participant = participants.find(p => p.id === target.dataset.catchupUserid);
                if (participant) showCatchupVoteModal(participant);
            };
        }

        let catchupScore = 5;
        function showCatchupVoteModal(participant) {
            const modal = document.getElementById('catchup-vote-modal');
            modal.querySelector('#catchup-participant-info').innerHTML = `<p class="text-xl font-bold">${participant.name}</p><p class="text-gray-400">"${participant.costume}"</p>`;
            catchupScore = 5;
            renderScoringInputs('#catchup-scoring-inputs', '.catchup-score-value', catchupScore);
            
            const scoreHandler = e => {
                const target = e.target.closest('.pumpkin-icon');
                if (!target) return;
                catchupScore = parseInt(target.dataset.value);
                modal.querySelector('.catchup-score-value').textContent = catchupScore;
                updatePumpkinSelection(catchupScore, modal);
            };
            modal.querySelector('.pumpkin-icons').onclick = scoreHandler;
            
            const saveBtn = document.getElementById('catchup-vote-save');
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

            newSaveBtn.addEventListener('click', async () => {
                const voteRef = doc(getVotesCollectionRef(contestId, participant.id), currentUserId);
                await setDoc(voteRef, { jurorId: currentUserId, score: catchupScore });
                modal.classList.remove('visible');
            });
            modal.classList.add('visible');
        }
        document.getElementById('catchup-vote-cancel').addEventListener('click', () => document.getElementById('catchup-vote-modal').classList.remove('visible'));

        async function renderResults(contestData, users) {
            const isAdmin = contestData.creatorId === currentUserId;
            const resultsContainer = document.getElementById('results-container');
            const controlsContainer = document.getElementById('results-controls');
            controlsContainer.innerHTML = '';

            const finalResults = contestData.topResults ? JSON.parse(contestData.topResults) : [];
            const newRevealStep = contestData.revealStep || 0; 
            let resultsHTML = '';
            const ranks = [3, 2, 1];

            if (finalResults.length === 0 && contestData.status === 'results') {
                resultsHTML = '<p class="text-xl text-yellow-400">No hubo participantes con votos para mostrar.</p>';
            } else {
                 if (newRevealStep === 0) {
                    resultsHTML = '<p class="text-2xl text-gray-400 animate-pulse">ü•Å Redoble de tambores... Esperando la revelaci√≥n de los ganadores... ü•Å</p>';
                } else {
                    ranks.forEach(rank => {
                        const result = finalResults.find(r => r.rank === rank);
                        const requiredStep = 4 - rank; 
                        const isRevealed = newRevealStep >= requiredStep;

                        if (newRevealStep >= requiredStep && previousRevealStep < requiredStep) {
                            if (result && result.id === currentUserId) {
                                showWinnerNotification(rank);
                            }
                        }

                        if (!result) {
                            resultsHTML += `<div class="bg-gray-900 p-4 rounded-xl flex justify-between items-center opacity-50"><p class="text-xl font-bold text-gray-600">${rank}¬∫ Lugar:</p><p class="text-gray-500">N/A</p></div>`;
                            return;
                        }
                        
                        const reopenBtn = (result.id === currentUserId) ? `<button data-action="reopen-winner-modal" data-rank="${rank}" class="text-2xl ml-2 p-1 rounded-full hover:bg-purple-700">üèÜ</button>` : '';

                        const imageTag = getImageTag(result.costumeImageBase64, 'image-preview-sm mr-3 flex-shrink-0', result.costume);
                        if (isRevealed) {
                            const colorClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : 'rank-3';
                            const icon = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â';
                            
                            resultsHTML += `
                                <div class="bg-gray-900 p-4 rounded-xl flex justify-between items-center border-l-4 border-orange-500 transform transition-transform hover:scale-[1.02]">
                                    <div class="flex items-center text-left">
                                        <span class="font-creepster text-3xl md:text-4xl mr-4 ${colorClass}">${icon}</span>
                                        ${imageTag}
                                        <div>
                                            <p class="text-xl font-bold text-white flex items-center">${result.name} ${reopenBtn}</p>
                                            <p class="text-sm text-gray-400">${result.costume}</p>
                                        </div>
                                    </div>
                                    <div class="text-right flex items-center gap-2">
                                        <p class="font-creepster text-5xl ${colorClass}">${result.overallScore.toFixed(2)}</p>
                                        <span class="font-creepster text-3xl text-orange-500">üéÉ</span>
                                    </div>
                                </div>`;
                        } else {
                            resultsHTML += `
                                <div class="bg-gray-900 p-4 rounded-xl flex justify-between items-center opacity-40">
                                    <p class="text-xl font-bold text-gray-500">${rank}¬∫ Lugar</p>
                                    <p class="font-creepster text-4xl text-gray-700">???</p>
                                </div>`;
                        }
                    });
                }
            }
            resultsContainer.innerHTML = resultsHTML;
             resultsContainer.onclick = (e) => {
                const target = e.target.closest('[data-action="reopen-winner-modal"]');
                if (target) showWinnerNotification(parseInt(target.dataset.rank));
            };

            let controlsHTML = '';
            if (isAdmin) {
                ranks.forEach(rank => {
                    const result = finalResults.find(r => r.rank === rank);
                    const stepToTriggerReveal = 3 - rank;
                    const nextStepValue = 4 - rank;
                    const isRevealed = newRevealStep >= nextStepValue;
                    const canReveal = newRevealStep === stepToTriggerReveal;

                    if (!result) controlsHTML += `<button class="btn-primary w-full mt-2 bg-gray-700" disabled>${rank}¬∫ Lugar (N/A)</button>`;
                    else if (isRevealed) controlsHTML += `<button class="btn-primary w-full mt-2 bg-green-600" disabled>‚úîÔ∏è ${rank}¬∫ Lugar Revelado</button>`;
                    else if (canReveal) controlsHTML += `<button data-action="reveal" data-next-step="${nextStepValue}" class="btn-primary w-full mt-2 animate-pulse bg-purple-600 hover:bg-purple-700">‚ú® Revelar ${rank}¬∫ Lugar</button>`;
                    else controlsHTML += `<button class="btn-primary w-full mt-2" disabled>Revelar ${rank}¬∫ Lugar</button>`;
                });
            }

            if (newRevealStep >= 3) {
                if (isAdmin) {
                    controlsHTML += `<button data-action="finalize" class="btn-danger mt-6 w-full">Finalizar y Eliminar Sala</button>`;
                    controlsHTML += `<button data-action="restart" class="btn-secondary mt-2 w-full">Reiniciar Concurso</button>`;
                }
                controlsHTML += `<button data-action="leave" class="btn-secondary mt-2 w-full">Volver al Inicio</button>`;
            }
            controlsContainer.innerHTML = controlsHTML;
            
            controlsContainer.onclick = async (e) => {
                const target = e.target.closest('button[data-action]');
                if (!target) return;
                const action = target.dataset.action;
                if(action === 'reveal') {
                    await updateDoc(getContestRef(contestId), { revealStep: parseInt(target.dataset.nextStep) });
                } else if (action === 'finalize') {
                    showConfirmation('Finalizar Concurso', '¬øEst√°s seguro? Esto eliminar√° permanentemente la sala para todos los usuarios.', async () => {
                        await updateDoc(getContestRef(contestId), { 
                            status: 'finalized', 
                            finalMessage: "¬°Un aplauso grande para los ganadores y para cada uno de los participantes que llenaron esta noche de creatividad y espanto! El jurado ha deliberado y el concurso de disfraces ha concluido oficialmente.\n\nGracias a todos por hacer de este un evento inolvidable. ¬°Ahora, que la fiesta contin√∫e, y que esta noche se convierta en un recuerdo inolvidable para todos!"
                        });
                    });
                } else if (action === 'restart') {
                    const batch = writeBatch(db);
                    batch.update(getContestRef(contestId), { status: "lobby", currentlyVotingFor: null, votedOnParticipants: [], revealStep: 0, topResults: null, tiebreakerInfo: null, acknowledgedUp: null });
                    users.forEach(u => batch.update(getUserRef(contestId, u.id), { hasVoted: false, totalScore: 0, costumeDescription: '' }));
                    const allUsers = (await getDocs(getUsersCollectionRef(contestId))).docs;
                    for (const userDoc of allUsers) {
                        const votesSnapshot = await getDocs(getVotesCollectionRef(contestId, userDoc.id));
                        votesSnapshot.forEach(voteDoc => batch.delete(voteDoc.ref));
                    }
                    await batch.commit();
                } else if(action === 'leave') {
                    leaveContest();
                }
            };
            previousRevealStep = newRevealStep;
        }

        async function generateDescriptionWithGemini(costumeName) {
            const apiKey = getApiKey();
            if (!apiKey) throw new Error("Clave de API no configurada. Por favor, a√±√°dela en los ajustes.");
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const systemPrompt = "Act√∫a como un narrador entusiasta con gran conocimiento de la cultura popular, mitolog√≠a y cuentos cl√°sicos. Tu tarea es generar una descripci√≥n corta para un disfraz en un concurso. Debe capturar la esencia del personaje, explicando brevemente qui√©n es o qu√© representa. Usa un tono accesible y directo, pero apropiado para la atm√≥sfera del personaje. Incluye siempre una l√≠nea de cierre que interact√∫e con el personaje o el p√∫blico. La respuesta debe ser en espa√±ol, de dos a tres frases vibrantes.";
                const userQuery = `Describe el disfraz de "${costumeName}" para un concurso.`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData?.error?.message || `Error HTTP ${response.status}`;
                    if (response.status === 400) throw new Error(`Solicitud inv√°lida (400): ${errorMsg}. Revisa el texto por contenido inapropiado o contacta al soporte de Google AI.`);
                    if (response.status === 403) throw new Error("Permiso denegado (403). Tu clave de API podr√≠a ser inv√°lida o no tener los permisos necesarios. Aseg√∫rate de que la API 'Generative Language' est√© habilitada en tu proyecto de Google Cloud y que la facturaci√≥n est√© activa.");
                    if (response.status === 429) throw new Error("Demasiadas solicitudes. Por favor, espera un momento.");
                    throw new Error(errorMsg);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) return text.trim(); else throw new Error("La IA no devolvi√≥ una respuesta v√°lida. Revisa la respuesta de la API en la consola del navegador.");
            } catch (error) {
                console.error("Error en generateDescriptionWithGemini:", error);
                throw error; 
            }
        }
        
        async function generateImageWithImagen(prompt) {
            const apiKey = getApiKey();
            if (!apiKey) throw new Error("Clave de API no configurada. Por favor, a√±√°dela en los ajustes.");
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                const payload = { instances: [{ prompt }], parameters: { "sampleCount": 1 } };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData?.error?.message || `Error HTTP ${response.status}`;
                    if (response.status === 400) throw new Error(`Solicitud inv√°lida (400): ${errorMsg}. Intenta con un prompt diferente o revisa si infringe las pol√≠ticas de seguridad.`);
                    if (response.status === 403) throw new Error("Permiso denegado (403). Tu clave de API podr√≠a ser inv√°lida. Aseg√∫rate de que la API 'Vertex AI' est√© habilitada en tu proyecto de Google Cloud y que la facturaci√≥n est√© activa.");
                    if (response.status === 429) throw new Error("Demasiadas solicitudes de im√°genes. Por favor, espera un momento.");
                    throw new Error(errorMsg);
                }
                const result = await response.json();
                const base64Data = result.predictions?.[0]?.bytesBase64Encoded;
                if (base64Data) return `data:image/png;base64,${base64Data}`; else throw new Error("La IA no devolvi√≥ una imagen v√°lida.");
            } catch (error) {
                console.error("Error en generateImageWithImagen:", error);
                throw error;
            }
        }
        
        async function extractTextWithGemini(base64Image) {
            const apiKey = getApiKey();
            if (!apiKey) throw new Error("Clave de API no configurada. Por favor, a√±√°dela en los ajustes.");
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const prompt = "Extrae el texto de esta imagen. Es una lista para un concurso con 3 campos separados por comas: 'Nombre, Disfraz, EsJurado'. El campo 'EsJurado' es opcional ('si', 'y', 'no', 'n', o vac√≠o). Estandariza la salida a CSV, con cada persona en una nueva l√≠nea. Para 'EsJurado', usa 'si' para respuestas afirmativas ('si', 'y') y 'no' para todo lo dem√°s (vac√≠o, 'no', 'n'). Ejemplo: 'Pepito, Pez gordo, si' -> 'Pepito,Pez gordo,si'. 'Pac, payaso' -> 'Pac,payaso,no'.";
                const payload = { contents: [ { role: "user", parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Image.split(',')[1] } } ] } ], };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData?.error?.message || `Error HTTP ${response.status}`;
                    if (response.status === 400) throw new Error(`Solicitud inv√°lida (400): ${errorMsg}. La imagen podr√≠a ser inv√°lida o contener contenido no permitido.`);
                    if (response.status === 403) throw new Error("Permiso denegado (403). Tu clave de API podr√≠a ser inv√°lida. Aseg√∫rate de que la API 'Generative Language' est√© habilitada en tu proyecto de Google Cloud y que la facturaci√≥n est√© activa.");
                    if (response.status === 429) throw new Error("Demasiadas solicitudes de an√°lisis de imagen. Por favor, espera un momento.");
                    throw new Error(errorMsg);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) return text.trim(); else throw new Error("La IA no pudo extraer texto de la imagen.");
            } catch (error) {
                console.error("Error en extractTextWithGemini:", error);
                throw error;
            }
        }

        document.getElementById('add-participants-from-photo-btn').addEventListener('click', () => {
            if (!checkAndPromptForKey()) return;
            document.getElementById('ocr-file-input').click();
        });

        document.getElementById('ocr-file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const uploadBtn = document.getElementById('add-participants-from-photo-btn');
            uploadBtn.disabled = true;
            loadingOverlay.classList.remove('hidden');
            document.getElementById('loading-text').textContent = 'Leyendo la Foto...';
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const textList = await extractTextWithGemini(event.target.result);
                    document.getElementById('participants-list-input').value = textList;
                    customAlert("Revisi√≥n Necesaria", "La IA ha procesado la imagen. Por favor, revisa y corrige el texto antes de cargar la lista.");
                } catch (error) { customAlert("Error al Leer Foto", error.message); }
                finally { loadingOverlay.classList.add('hidden'); uploadBtn.disabled = false; e.target.value = ''; }
            };
            reader.onerror = () => { customAlert("Error de Archivo", "No se pudo leer el archivo."); loadingOverlay.classList.add('hidden'); uploadBtn.disabled = false; e.target.value = ''; };
            reader.readAsDataURL(file);
        });
        
        document.getElementById('image-generation-cancel').addEventListener('click', () => imageGenerationModal.classList.remove('visible'));
        document.getElementById('image-generation-generate').addEventListener('click', async (e) => {
            if (!checkAndPromptForKey()) return;
            const btn = e.target, prompt = document.getElementById('image-generation-prompt').value;
            if(!prompt) return customAlert("Error", "El prompt no puede estar vac√≠o.");
            const preview = document.getElementById('image-generation-preview'), status = document.getElementById('image-generation-status'), saveBtn = document.getElementById('image-generation-save');
            btn.disabled = true; status.innerHTML = `<svg class="animate-spin h-8 w-8 text-orange-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-2">Generando...</p>`;
            preview.classList.add('hidden'); status.classList.remove('hidden'); saveBtn.disabled = true;
            try {
                const rawBase64 = await generateImageWithImagen(prompt);
                generatedImageBase64 = await processImage(rawBase64);
                preview.src = generatedImageBase64;
                preview.classList.remove('hidden'); status.classList.add('hidden'); saveBtn.disabled = false;
            } catch (error) { customAlert("Error al Generar Imagen", error.message); status.innerHTML = `<p>Error al generar.</p>`; }
            finally { btn.disabled = false; }
        });
        document.getElementById('image-generation-save').addEventListener('click', async () => {
            if (!generatedImageBase64 || !targetUserIdForImage) return;
            loadingOverlay.classList.remove('hidden'); document.getElementById('loading-text').textContent = 'Guardando...';
            try { await updateDoc(getUserRef(contestId, targetUserIdForImage), { costumeImageBase64: generatedImageBase64 }); imageGenerationModal.classList.remove('visible'); }
            catch(error) { customAlert("Error", "No se pudo guardar la imagen."); }
            finally { loadingOverlay.classList.add('hidden'); }
        });

        document.getElementById('add-participants-from-list-btn')?.addEventListener('click', async () => {
            const list = document.getElementById('participants-list-input').value.trim(); if (!list) return;
            const batch = writeBatch(db);
            list.split('\n').forEach(line => {
                const parts = line.split(',').map(p => p.trim()), name = parts[0];
                if (name) {
                    const costume = parts[1] || '', jurorText = (parts[2] || '').toLowerCase();
                    const isJuror = ['si', 'y', 's', 'yes', 'true'].includes(jurorText);
                    batch.set(doc(getUsersCollectionRef(contestId)), { name, costume, isParticipant: !!costume, isJuror, isManualEntry: true, costumeDescription: '' });
                }
            });
            await batch.commit(); document.getElementById('participants-list-input').value = '';
        });

        document.getElementById('add-juror-btn')?.addEventListener('click', async () => { const name=document.getElementById('new-juror-name').value.trim(); if(name){await addDoc(getUsersCollectionRef(contestId),{name,costume:'',isParticipant:false,isJuror:true,isManualEntry:true,costumeDescription:''}); document.getElementById('new-juror-name').value='';} });
        
        document.getElementById('start-contest-btn')?.addEventListener('click', async () => { 
            if (localContestData.status === 'paused') return await updateDoc(getContestRef(contestId), { status: 'voting' });
            const users = (await getDocs(getUsersCollectionRef(contestId))).docs.map(d => d.data());
            if(users.filter(u=>u.isParticipant).length<1) return customAlert("Error","Debe haber al menos un participante."); 
            if(users.filter(u=>u.isJuror).length<3) return customAlert("Regla del Concurso","Debe haber al menos 3 jurados para iniciar."); 
            await updateDoc(getContestRef(contestId), {status:'voting', votedOnParticipants: [], onDeck: null, isUp: null, acknowledgedUp: null }); 
        });

        document.getElementById('submit-vote-btn')?.addEventListener('click', async (e) => { if (e.target.disabled) return; e.target.disabled=true; e.target.textContent='Enviado'; const voteRef=doc(getVotesCollectionRef(contestId,localContestData.currentlyVotingFor), currentUserId); const batch=writeBatch(db); batch.set(voteRef,{jurorId:currentUserId,score:currentJurorScore}); batch.update(getUserRef(contestId,currentUserId),{hasVoted:true}); await batch.commit(); });
        
        onAuthStateChanged(auth, async (user) => {
            if (user) { 
                currentUserId = user.uid; 
                const hashId = window.location.hash.substring(1).toUpperCase(); 
                if (hashId) {
                    contestId = hashId;
                    const contestDoc = await getDoc(getContestRef(hashId));
                    if(contestDoc.exists()){
                        const userDoc = await getDoc(getUserRef(hashId, currentUserId));
                        if(userDoc.exists()){
                            subscribeToContest(contestId);
                        } else {
                            showScreen('register');
                        }
                    } else {
                         showScreen('register');
                    }
                } else {
                    showScreen('home'); 
                }
            } else {
                loadingOverlay.classList.remove('hidden');
                document.getElementById('loading-text').textContent = 'Autenticando...';
                await signInAnonymously(auth);
            }
        });
        
        let currentRating = 0;
        const stars = document.querySelectorAll('#feedback-stars span');
        const emojiDisplay = document.getElementById('feedback-emoji-display');
        const submitFeedbackBtn = document.getElementById('submit-feedback-btn');
        const feedbackEmojis = ['üò≠', 'üòû', 'ü•∫', 'üòä', 'ü§©'];

        stars.forEach(star => {
            star.addEventListener('click', () => {
                currentRating = parseInt(star.dataset.value);
                stars.forEach(s => s.classList.toggle('selected', parseInt(s.dataset.value) <= currentRating));
                emojiDisplay.textContent = feedbackEmojis[currentRating - 1];
                emojiDisplay.classList.add('emoji-pop');
                emojiDisplay.addEventListener('animationend', () => emojiDisplay.classList.remove('emoji-pop'), { once: true });
                submitFeedbackBtn.disabled = false;
            });
        });

        submitFeedbackBtn.addEventListener('click', async (e) => {
            e.target.disabled = true;
            e.target.textContent = 'Enviando...';
            const comment = document.getElementById('feedback-comment').value;
            await addDoc(getFeedbackCollectionRef(), {
                rating: currentRating,
                comment: comment,
                contestId: contestId,
                timestamp: serverTimestamp()
            });
            document.getElementById('feedback-modal').classList.remove('visible');
            leaveContest();
        });

        document.getElementById('skip-feedback-btn').addEventListener('click', () => {
             document.getElementById('feedback-modal').classList.remove('visible');
             leaveContest();
        });

        function showFeedbackModal(message) {
            const modal = document.getElementById('feedback-modal');
            modal.querySelector('#feedback-modal-title').textContent = "¬°Una Noche M√°gica!";
            modal.querySelector('#feedback-modal-message').textContent = message;
            modal.classList.add('visible');
        }
        
        // --- DEBUG MODE ---
        function initializeDebugMode() {
            isInDebugMode = true;
             const mockUsers = [
                { id: 'admin1', name: 'Organizador', isParticipant: false, isJuror: false },
                { id: 'juror1', name: 'Jurado 1', isParticipant: false, isJuror: true },
                { id: 'juror2', name: 'Jurado 2 (y participa)', costume: 'Vampiro', isParticipant: true, isJuror: true },
                { id: 'participant1', name: 'Dr√°cula', costume: 'Conde Dr√°cula', isParticipant: true, isJuror: false, costumeDescription: 'El rey de los vampiros, elegante y sediento.' },
                { id: 'participant2', name: 'Frankenstein', costume: 'Monstruo de Frank', isParticipant: true, isJuror: false },
                { id: 'participant3', name: 'Momia', costume: 'Momia Egipsia', isParticipant: true, isJuror: false }
            ];
            const mockContest = {
                creatorId: 'admin1',
                status: 'lobby',
                votedOnParticipants: ['participant2'],
                currentlyVotingFor: 'participant1',
                topResults: JSON.stringify([
                    { id: 'participant1', rank: 1, name: 'Dr√°cula', costume: 'Conde Dr√°cula', overallScore: 9.50 },
                    { id: 'juror2', rank: 2, name: 'Jurado 2 (y participa)', costume: 'Vampiro', overallScore: 8.75 },
                    { id: 'participant3', rank: 3, name: 'Momia', costume: 'Momia Egipsia', overallScore: 8.20 }
                ])
            };
            
            showScreen('debug');
            
            document.querySelector('#debug-panel').addEventListener('click', (e) => {
                const action = e.target.dataset.debug;
                if (!action) return;
                
                document.querySelectorAll('.modal-backdrop, .winner-notification').forEach(el => el.classList.remove('visible'));

                switch(action) {
                    case 'home': showScreen('home'); break;
                    case 'lobby-admin': currentUserId = 'admin1'; renderLobby(mockContest, mockUsers); showScreen('lobby'); break;
                    case 'lobby-user': currentUserId = 'participant1'; renderLobby(mockContest, mockUsers); showScreen('lobby'); break;
                    case 'voting-admin': currentUserId = 'admin1'; renderVotingScreen(mockContest, mockUsers); showScreen('voting'); break;
                    case 'voting-juror': currentUserId = 'juror1'; renderVotingScreen(mockContest, mockUsers); showScreen('voting'); break;
                    case 'voting-participant': currentUserId = 'participant2'; renderVotingScreen(mockContest, mockUsers); showScreen('voting'); break;
                    case 'results-admin': currentUserId = 'admin1'; renderResults({...mockContest, revealStep: 3}, mockUsers); showScreen('results'); break;
                    case 'results-user': currentUserId = 'participant1'; renderResults({...mockContest, revealStep: 3}, mockUsers); showScreen('results'); break;
                    case 'on-deck': onDeckModal.classList.add('visible'); break;
                    case 'is-up': isUpModal.classList.add('visible'); break;
                    case 'feedback': showFeedbackModal("Mensaje de prueba para la ventana de feedback. Gracias por jugar."); break;
                    case 'winner-1': showWinnerNotification(1); break;
                    case 'winner-2': showWinnerNotification(2); break;
                    case 'winner-3': showWinnerNotification(3); break;
                    case 'exit': 
                        isInDebugMode = false;
                        debugBackButtonContainer.classList.add('hidden');
                        window.location.reload(); 
                        break;
                }
            });

            document.getElementById('debug-back-button').addEventListener('click', () => showScreen('debug'));
        }

        attachScoringListeners();
    </script>
</body>
</html>


