<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votación Concurso de Halloween</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #f0f0f0; }
        .font-creepster { font-family: 'Creepster', cursive; }
        .card { background-color: rgba(40, 40, 40, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        .btn-primary { 
            background: linear-gradient(145deg, #ff7800, #ff5400); 
            border: none; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; 
            text-transform: uppercase; letter-spacing: 1px; 
            box-shadow: 0 4px 15px rgba(255, 120, 0, 0.3); 
            transition: all 0.3s ease; 
        }
        .btn-primary:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(255, 120, 0, 0.5); 
        }
        .btn-primary:disabled { 
            background: #555; 
            cursor: not-allowed; 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); 
            opacity: 0.8; 
            transform: translateY(0); 
        }
        .btn-primary.ready-to-send:not(:disabled) {
            background: linear-gradient(145deg, #00b469, #008f53);
            box-shadow: 0 4px 15px rgba(0, 180, 105, 0.3);
        }

        .btn-secondary { background-color: #333; border: 1px solid #555; color: white; padding: 12px 24px; border-radius: 8px; transition: background-color 0.2s ease; }
        .btn-secondary:hover:not(:disabled) { background-color: #444; }
        .btn-danger { background-color: #dc2626; color: white; padding: 12px 24px; border-radius: 8px; transition: background-color 0.2s ease; }
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 1rem; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: #2d2d2d; color: #f0f0f0; padding: 2rem; border-radius: 0.75rem; max-width: 90%; width: 500px; border: 1px solid #444; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        
        .rank-1 { color: #facc15; } /* Amarillo */
        .rank-2 { color: #e5e7eb; } /* Plata */
        .rank-3 { color: #d97706; } /* Bronce */
        
        .pumpkin-icon { 
            font-size: 2rem; /* Adjusted size for more icons */
            opacity: 0.3; 
            transition: all 0.1s ease; 
            cursor: pointer; 
        }
        .pumpkin-icon.selected { 
            opacity: 1; 
            transform: scale(1.1); 
            color: #ff7800; 
            text-shadow: 0 0 10px rgba(255, 120, 0, 0.9); 
        }
        .pumpkin-icons { 
            user-select: none; 
            display: flex; 
            flex-wrap: wrap; /* Allow icons to wrap */
            justify-content: center; 
            gap: 0.5rem; 
        }
        .image-preview-sm {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ff7800;
        }
        .image-preview-lg {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            border: 3px solid #ff7800;
            box-shadow: 0 0 20px rgba(255, 120, 0, 0.5);
            margin-bottom: 1.5rem;
            background-color: #000;
        }

        .toggle-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 0.9rem; color: #ccc; }
        .toggle-label span { margin-right: 0.5rem; }
        .toggle-checkbox { display: none; }
        .toggle-switch { position: relative; width: 48px; height: 24px; background-color: #555; border-radius: 12px; transition: background-color 0.4s; flex-shrink: 0; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background-color: #f0f0f0; border-radius: 50%; transition: transform 0.4s, background-color 0.4s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4); }
        .toggle-checkbox:checked + .toggle-switch { background-color: #ff7800; }
        .toggle-checkbox:checked + .toggle-switch::after { transform: translateX(24px); background-color: #f0f0f0; }

        .editable-image-container { position: relative; cursor: pointer; }
        .editable-image-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; opacity: 0; transition: opacity 0.2s ease; border-radius: 4px; }
        .editable-image-container:hover .editable-image-overlay { opacity: 1; }
    </style>
</head>
<body class="bg-cover bg-center bg-fixed" style="background-image: url('https://placehold.co/1920x1080/000000/FF7800?text=Halloween+Background')">
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center z-50">
        <svg class="animate-spin h-12 w-12 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p class="font-creepster text-2xl text-orange-500 mt-4 tracking-wider">Conectando...</p>
    </div>

    <main class="container mx-auto p-4 max-w-5xl min-h-screen flex flex-col justify-center">
        <div id="home-screen" class="w-full">
            <div class="card rounded-xl p-6 md:p-8 text-center shadow-lg max-w-2xl mx-auto">
                <h1 class="font-creepster text-5xl md:text-7xl text-orange-500 mb-4 tracking-widest">Noche de Brujas</h1>
                <p class="text-gray-300 mb-8">Crea o únete a una sala de votación.</p>
                <button id="create-contest-btn" class="btn-primary w-full mb-4">Crear Nueva Sala</button>
                <div class="flex flex-col sm:flex-row gap-2 mt-4">
                     <input type="text" id="contest-id-input" placeholder="Pega el código de la sala" class="flex-grow bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500">
                     <button id="join-contest-btn" class="btn-primary">Unirse</button>
                </div>
            </div>
        </div>
        
        <div id="register-screen" class="hidden w-full">
             <div class="card rounded-xl p-8 text-center shadow-lg max-w-2xl mx-auto">
                <h2 class="font-creepster text-4xl text-orange-500 mb-6">Registro</h2>
                <div class="space-y-4">
                    <input type="text" id="user-name-input" placeholder="Tu nombre (obligatorio)" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <input type="text" id="costume-name-input" placeholder="Disfraz (opcional)" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500 mt-2">
                    <button id="register-btn" class="btn-primary w-full !mt-6">¡Entrar a la Sala!</button>
                    <button id="back-to-home-btn" class="btn-secondary w-full !mt-2">Volver</button>
                </div>
            </div>
        </div>

        <div id="lobby-screen" class="hidden w-full relative">
             <div class="card rounded-xl p-6 md:p-8 shadow-lg max-w-2xl mx-auto">
                <button id="leave-lobby-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-sm py-1 px-2 rounded-md bg-red-800/50 hover:bg-red-700/80">Salir</button>
                <h2 class="font-creepster text-4xl text-orange-500 mb-2 text-center">Sala de Espera</h2>
                <div class="bg-gray-900 p-3 rounded-lg flex items-center justify-between mb-6">
                    <div>
                        <span class="text-gray-400 text-sm block">Código de Sala:</span>
                        <span id="contest-code" class="text-orange-400 text-lg font-bold tracking-widest"></span>
                    </div>
                    <button id="copy-code-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-3 rounded-lg text-sm flex-shrink-0">Copiar</button>
                </div>
                <h3 class="font-bold text-xl mb-3 text-gray-200">Usuarios Conectados</h3>
                <div id="users-list" class="space-y-2 max-h-64 overflow-y-auto no-scrollbar pr-2"></div>
                
                <div id="admin-controls" class="hidden mt-6 pt-6 border-t border-gray-600">
                    <div id="bulk-participant-form" class="mb-6">
                        <h3 class="font-bold text-lg mb-3 text-center text-gray-300">Carga Masiva de Participantes</h3>
                        <textarea id="participants-list-input" placeholder="Pega aquí tu lista de participantes" rows="5" class="w-full bg-gray-800 rounded p-2 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-orange-500">Carlos Rivera,El Jinete sin Cabeza
Ana Martínez,La Llorona Digital
Javier Soto,Vampiro Programador
Sofía Castro,Calavera de Azúcar Neón
Mateo Rojas,Fantasma Glitch</textarea>
                        <button id="add-participants-from-list-btn" class="btn-secondary w-full mt-2 bg-purple-700 hover:bg-purple-800">Cargar Lista de Participantes</button>
                        
                        <div class="mt-4 border-t border-gray-700 pt-4">
                            <h3 class="font-bold text-lg mb-3 text-center text-gray-300">Añadir Jurado Manualmente</h3>
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <input type="text" id="new-juror-name" placeholder="Nombre del Jurado" class="bg-gray-800 rounded p-2 border border-gray-600 text-white w-full">
                                <button id="add-juror-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Añadir Jurado</button>
                            </div>
                        </div>
                    </div>
                    <p class="text-center text-yellow-400 mb-4 font-bold">Eres el organizador. Asigna los roles:</p>
                    <button id="start-contest-btn" class="btn-primary w-full">¡Comenzar Votación!</button>
                </div>
                <div id="wait-for-admin" class="mt-8 text-center text-gray-400">
                    <p>Esperando que el organizador inicie el concurso...</p>
                </div>
             </div>
        </div>

        <div id="voting-screen" class="hidden w-full">
            <div class="card rounded-xl p-6 md:p-8 shadow-lg w-full">
                <h2 id="voting-screen-title" class="font-creepster text-4xl text-orange-500 mb-6 text-center">Votación en Progreso</h2>
                <div id="admin-voting-view" class="hidden"></div>
                <div id="voter-voting-view">
                    <div id="currently-voting-for" class="text-center p-6 bg-gray-900 rounded-xl mb-6"></div>
                    <div id="juror-controls" class="hidden mb-6 card p-4">
                         <h3 class="font-bold text-xl mb-4 text-center text-orange-400">¡Emite tu puntaje de calabazas!</h3>
                         <div id="scoring-inputs" class="space-y-6"></div>
                         <button id="submit-vote-btn" class="btn-primary w-full mt-6">Enviar Voto</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold text-lg text-green-400 mb-2">Evaluados</h4>
                            <ul id="voted-list" class="space-y-1 text-gray-400"></ul>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-yellow-400 mb-2">Pendientes</h4>
                            <ul id="pending-list" class="space-y-1"></ul>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-600">
                        <h4 class="font-bold text-lg text-cyan-400 mb-2">Jurado pendiente de votar:</h4>
                        <ul id="pending-jurors-list-voter" class="space-y-1"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="results-screen" class="hidden w-full">
            <div class="card rounded-xl p-6 md:p-8 text-center shadow-lg w-full">
                 <h2 class="font-creepster text-5xl md:text-6xl text-orange-500 mb-6 tracking-widest">¡Resultados Finales!</h2>
                 <div id="results-container" class="space-y-4">
                     <p class="text-gray-400 text-lg">Esperando que el organizador revele los resultados...</p>
                 </div>
                 <div id="results-controls" class="mt-8 pt-4 border-t border-gray-700"></div>
            </div>
        </div>
    </main>
    
    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="font-creepster text-3xl text-orange-500 mb-4"></h2><p id="alert-modal-message" class="text-gray-300 mb-6"></p><button id="alert-modal-close" class="btn-primary">Entendido</button></div></div>
    <div id="name-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Editar Nombre</h2><input type="text" id="name-modal-input" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500"><div class="flex gap-4 mt-6"><button id="name-modal-cancel" class="btn-secondary flex-1">Cancelar</button><button id="name-modal-save" class="btn-primary flex-1">Guardar</button></div></div></div>
    <div id="costume-modal" class="modal-backdrop"><div class="modal-content"><h2 class="font-creepster text-3xl text-orange-500 mb-4">Nombre del Disfraz</h2><input type="text" id="costume-modal-input" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-500"><div class="flex gap-4 mt-6"><button id="costume-modal-cancel" class="btn-secondary flex-1">Cancelar</button><button id="costume-modal-save" class="btn-primary flex-1">Guardar</button></div></div></div>
    <div id="image-upload-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="font-creepster text-3xl text-orange-500 mb-4">Subir Foto del Disfraz</h2>
            <div id="image-upload-preview-container" class="mb-4 bg-black rounded-lg p-2 min-h-[200px] flex items-center justify-center">
                 <img id="image-upload-preview" src="" alt="Previsualización" class="max-w-full max-h-[200px] object-contain rounded hidden">
                 <div id="image-upload-status" class="text-gray-400"><p>Selecciona una imagen...</p></div>
            </div>
            <div class="flex gap-4 mt-6"><button id="image-upload-cancel" class="btn-secondary flex-1">Cancelar</button><button id="image-upload-save" class="btn-primary flex-1" disabled>Guardar</button></div>
        </div>
    </div>
    <input type="file" id="image-file-input" class="hidden" accept="image/*">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, getDocs, writeBatch, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAogdul6URUEE0rQKKGQesZqgqAI5bQbZM",
            authDomain: "concurso-halloween.firebaseapp.com",
            projectId: "concurso-halloween",
            storageBucket: "concurso-halloween.appspot.com",
            messagingSenderId: "911444785839",
            appId: "1:911444785839:web:03326456c9b2b35d90325a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appId = 'concurso-halloween-shared-2025';

        const getContestRef = (id) => doc(db, `artifacts/${appId}/public/data/contests`, id);
        const getUserRef = (cId, uId) => doc(db, `artifacts/${appId}/public/data/contests/${cId}/users`, uId);
        const getUsersCollectionRef = (cId) => collection(db, `artifacts/${appId}/public/data/contests/${cId}/users`);
        const getVotesCollectionRef = (cId, participantId) => collection(db, `artifacts/${appId}/public/data/contests/${cId}/users/${participantId}/votes`);
        
        const screens = { home: document.getElementById('home-screen'), register: document.getElementById('register-screen'), lobby: document.getElementById('lobby-screen'), voting: document.getElementById('voting-screen'), results: document.getElementById('results-screen') };
        const loadingOverlay = document.getElementById('loading-overlay');
        let currentUserId = null, contestId = null, localContestData = {};
        let contestUnsubscribe = null, usersUnsubscribe = null;
        let currentJurorScore = 5;
        const MAX_PUMPKINS = 10;

        const imageUploadModal = document.getElementById('image-upload-modal');
        const imageFileInput = document.getElementById('image-file-input');
        let imageUploadAbortController = null;
        let processedImageBase64 = null;
        let targetUserIdForImageUpload = null;

        function customAlert(title, message) {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            document.getElementById('alert-modal').classList.add('visible');
        }
        document.getElementById('alert-modal-close').addEventListener('click', () => document.getElementById('alert-modal').classList.remove('visible'));

        function setupModal(modalElement, inputId, saveButtonId, cancelButtonId) {
            const input = modalElement.querySelector(`#${inputId}`);
            const cancelBtn = modalElement.querySelector(`#${cancelButtonId}`);
            const show = (currentValue, onSave) => {
                const saveBtn = modalElement.querySelector(`#${saveButtonId}`);
                input.value = currentValue;
                modalElement.classList.add('visible');
                input.focus();
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                newSaveBtn.addEventListener('click', async () => {
                    await onSave(input.value.trim());
                    hide();
                });
            };
            const hide = () => modalElement.classList.remove('visible');
            cancelBtn.addEventListener('click', hide);
            return { show };
        }

        const namePrompt = setupModal(document.getElementById('name-modal'), 'name-modal-input', 'name-modal-save', 'name-modal-cancel');
        const costumePrompt = setupModal(document.getElementById('costume-modal'), 'costume-modal-input', 'costume-modal-save', 'costume-modal-cancel');
        
        const generateId = () => Math.random().toString(36).substr(2, 6).toUpperCase();

        document.getElementById('copy-code-btn')?.addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('contest-code').textContent).then(() => customAlert("Copiado", "Código de sala copiado.")).catch(() => customAlert("Error", "No se pudo copiar."));
        });

        function leaveContest() {
            if (contestUnsubscribe) contestUnsubscribe();
            if (usersUnsubscribe) usersUnsubscribe();
            contestUnsubscribe = null;
            usersUnsubscribe = null;
            contestId = null;
            localContestData = {};
            window.location.hash = '';
            showScreen('home');
        }
        
        function processImageWithCancellation(file, signal) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const cleanup = () => { signal.removeEventListener('abort', handleAbort); };
                const handleAbort = () => { reader.abort(); cleanup(); reject(new DOMException('Cancelado.', 'AbortError')); };
                signal.addEventListener('abort', handleAbort, { once: true });
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const MAX_SIDE = 400; let { width, height } = img;
                        if (width > MAX_SIDE || height > MAX_SIDE) { if (width > height) { height *= MAX_SIDE / width; width = MAX_SIDE; } else { width *= MAX_SIDE / height; height = MAX_SIDE; } }
                        const canvas = Object.assign(document.createElement('canvas'), { width, height });
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        cleanup(); resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = () => { cleanup(); reject(new Error("Error al cargar imagen.")); };
                    img.src = e.target.result;
                };
                reader.onerror = () => { cleanup(); reject(new Error("Error al leer archivo.")); };
                reader.readAsDataURL(file);
            });
        }

        function showImageUploadModal(userId) {
            targetUserIdForImageUpload = userId; processedImageBase64 = null;
            const preview = document.getElementById('image-upload-preview'), status = document.getElementById('image-upload-status'), saveBtn = document.getElementById('image-upload-save');
            preview.classList.add('hidden'); status.innerHTML = '<p>Selecciona una imagen...</p>'; status.classList.remove('hidden'); saveBtn.disabled = true;
            imageUploadModal.classList.add('visible'); imageFileInput.click();
        }

        function hideImageUploadModal() {
            if (imageUploadAbortController) imageUploadAbortController.abort();
            imageUploadModal.classList.remove('visible'); imageFileInput.value = '';
        }

        imageFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) { hideImageUploadModal(); return; }
            const preview = document.getElementById('image-upload-preview'), status = document.getElementById('image-upload-status'), saveBtn = document.getElementById('image-upload-save');
            imageUploadAbortController = new AbortController();
            status.innerHTML = `<svg class="animate-spin h-8 w-8 text-orange-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-2">Procesando...</p>`;
            saveBtn.disabled = true;
            try {
                processedImageBase64 = await processImageWithCancellation(file, imageUploadAbortController.signal);
                preview.src = processedImageBase64; preview.classList.remove('hidden'); status.classList.add('hidden'); saveBtn.disabled = false;
            } catch (error) { if (error.name !== 'AbortError') customAlert("Error de Imagen", error.message); hideImageUploadModal(); }
            finally { imageUploadAbortController = null; }
        });

        document.getElementById('image-upload-cancel').addEventListener('click', hideImageUploadModal);
        document.getElementById('image-upload-save').addEventListener('click', async () => {
            if (!processedImageBase64 || !targetUserIdForImageUpload) return;
            const btn = document.getElementById('image-upload-save'); btn.disabled = true; btn.textContent = 'Guardando...';
            try {
                await updateDoc(getUserRef(contestId, targetUserIdForImageUpload), { costumeImageBase64: processedImageBase64 });
                hideImageUploadModal();
            } catch (error) { customAlert("Error", "No se pudo guardar la imagen."); }
            finally { btn.disabled = false; btn.textContent = 'Guardar'; }
        });

        const getImageTag = (b64, cls, alt) => b64 ? `<img src="${b64}" class="${cls}" alt="${alt}">` : `<div class="${cls} bg-gray-700 flex items-center justify-center rounded-sm"><span class="text-gray-400 text-xs">IMG</span></div>`;

        function renderScoringInputs() {
            const container = document.getElementById('scoring-inputs');
            container.innerHTML = `<div class="text-center"><label class="block mb-4 text-xl font-bold">Puntaje: <span class="score-value text-orange-400 font-creepster text-3xl">${currentJurorScore}</span></label><div class="pumpkin-icons">${Array(MAX_PUMPKINS).fill(0).map((_,i)=>`<span class="pumpkin-icon" data-value="${i+1}">🎃</span>`).join('')}</div></div>`;
            updatePumpkinSelection(currentJurorScore); attachScoringListeners();
        }

        const updatePumpkinSelection = s => document.querySelectorAll('.pumpkin-icon').forEach(p => p.classList.toggle('selected', p.dataset.value <= s));

        async function setInitialJurorScore(participantId) {
            if (!participantId || !currentUserId) return;
            const q = query(getVotesCollectionRef(contestId, participantId), where("jurorId", "==", currentUserId));
            const snap = await getDocs(q); let hasVoted = false; currentJurorScore = 5;
            if (!snap.empty) { currentJurorScore = snap.docs[0].data().score; hasVoted = true; }
            const scoreSpan = document.querySelector('#scoring-inputs .score-value'); if (scoreSpan) scoreSpan.textContent = currentJurorScore;
            updatePumpkinSelection(currentJurorScore);
            const btn = document.getElementById('submit-vote-btn'); if (btn) { btn.disabled = hasVoted; btn.textContent = hasVoted ? 'Voto Enviado' : 'Enviar Voto'; btn.classList.toggle('ready-to-send', !hasVoted); }
        }

        function attachScoringListeners() {
            document.querySelector('.pumpkin-icons')?.addEventListener('click', (e) => {
                const target = e.target.closest('.pumpkin-icon'); if (!target) return;
                currentJurorScore = parseInt(target.dataset.value);
                document.querySelector('#scoring-inputs .score-value').textContent = currentJurorScore;
                updatePumpkinSelection(currentJurorScore);
                const btn = document.getElementById('submit-vote-btn'); if (btn.disabled) { btn.disabled = false; btn.textContent = 'Enviar Voto'; btn.classList.add('ready-to-send'); }
            });
        }
        
        document.getElementById('create-contest-btn').addEventListener('click', () => { contestId = generateId(); window.location.hash = contestId; showScreen('register'); });
        document.getElementById('join-contest-btn').addEventListener('click', async () => {
            const id = document.getElementById('contest-id-input').value.trim().toUpperCase(); if (!id) return;
            if ((await getDoc(getContestRef(id))).exists()) { contestId = id; window.location.hash = id; showScreen('register'); } else { customAlert("Error", "Sala no encontrada."); }
        });
        document.getElementById('back-to-home-btn').addEventListener('click', leaveContest);
        document.getElementById('leave-lobby-btn').addEventListener('click', leaveContest);

        document.getElementById('register-btn').addEventListener('click', async () => {
            const name = document.getElementById('user-name-input').value.trim(); if (!name) return customAlert("Error", "Nombre requerido.");
            loadingOverlay.classList.remove('hidden');
            const costume = document.getElementById('costume-name-input').value.trim();
            const isCreator = !(await getDoc(getContestRef(contestId))).exists();
            if (isCreator) { await setDoc(getContestRef(contestId), { status: "lobby", creatorId: currentUserId }); }
            await setDoc(getUserRef(contestId, currentUserId), { name, costume, isParticipant: !!costume, isJuror: false, hasVoted: false, totalScore: 0 });
            subscribeToContest(contestId);
        });
        
        const showScreen = name => { 
            Object.values(screens).forEach(s => s.classList.add('hidden')); 
            screens[name]?.classList.remove('hidden'); 
            loadingOverlay.classList.add('hidden'); 
            if(name==='voting') renderScoringInputs(); 
        };

        function subscribeToContest(id) {
            if (contestUnsubscribe) contestUnsubscribe();
            contestUnsubscribe = onSnapshot(getContestRef(id), (doc) => {
                if (!doc.exists()) { leaveContest(); customAlert("Error", "La sala ha sido eliminada o no existe."); return; }
                localContestData = { id: doc.id, ...doc.data() };
                const isTiebreaker = localContestData.status === 'tiebreaker';
                const statusMap = { lobby: renderLobby, voting: renderVotingScreen, tiebreaker: renderVotingScreen, results: renderResults };
                showScreen(isTiebreaker ? 'voting' : localContestData.status);
                if (statusMap[localContestData.status]) subscribeToUsers(id, statusMap[localContestData.status]);
            });
        }

        function subscribeToUsers(id, renderer) {
            if (usersUnsubscribe) usersUnsubscribe();
            usersUnsubscribe = onSnapshot(getUsersCollectionRef(id), (snap) => renderer(localContestData, snap.docs.map(d => ({ id: d.id, ...d.data() }))));
        }
        
        function renderLobby(contestData, users) {
            document.getElementById('contest-code').textContent = contestId;
            const isAdmin = contestData.creatorId === currentUserId;
            document.getElementById('admin-controls').classList.toggle('hidden', !isAdmin);
            document.getElementById('wait-for-admin').classList.toggle('hidden', isAdmin);
            const list = document.getElementById('users-list'); list.innerHTML = '';
            const sortedUsers = [...users].sort((a,b) => (a.id === currentUserId) ? -1 : (b.id === currentUserId) ? 1 : 0);
            sortedUsers.forEach(user => {
                const isMe = user.id === currentUserId, canEdit = isAdmin || isMe;
                const imgTag = getImageTag(user.costumeImageBase64, 'image-preview-sm flex-shrink-0', user.costume);
                const imgContainer = canEdit ? `<div class="editable-image-container mr-3" data-action="edit-image" data-userid="${user.id}">${imgTag}<div class="editable-image-overlay">📸</div></div>` : `<div class="mr-3">${imgTag}</div>`;
                const costumeHTML = user.costume?.trim() ? `<div class="text-sm text-gray-300"><span>${user.costume}</span> ${canEdit ? `<button data-action="edit-costume" data-userid="${user.id}" class="text-xl ml-2">✏️</button>`:''}</div>` : `<div class="text-sm text-gray-500">No concursa ${canEdit ? `<button data-action="edit-costume" data-userid="${user.id}" class="text-xl ml-2">✏️</button>`:''}</div>`;
                const rolesHTML = isAdmin ? `<div class="flex items-center gap-4 pt-2 border-t border-gray-700 mt-2"><label class="toggle-label flex-1"><span>Participa</span><input type="checkbox" class="toggle-checkbox" data-role="isParticipant" data-userid="${user.id}" ${user.isParticipant?'checked':''}><div class="toggle-switch"></div></label><label class="toggle-label flex-1"><span>Jurado</span><input type="checkbox" class="toggle-checkbox" data-role="isJuror" data-userid="${user.id}" ${user.isJuror?'checked':''}><div class="toggle-switch"></div></label></div>` : `<div class="text-sm text-orange-400 mt-1">${user.isParticipant?'Participante':''} ${user.isJuror?(user.isParticipant?'/ Jurado':'Jurado'):''}</div>`;
                const item = document.createElement('div'); item.className = `bg-gray-800 p-3 rounded-lg ${isMe ? 'border-2 border-orange-500' : ''}`;
                item.innerHTML = `<div class="flex items-center">${imgContainer}<div class="flex-grow"><div class="font-bold"><span>${user.name} ${isMe?'(Tú)':''}</span> ${canEdit ? `<button data-action="edit-name" data-userid="${user.id}" class="text-xl ml-2">✏️</button>`:''}</div>${costumeHTML}</div></div>${rolesHTML}`;
                list.appendChild(item);
            });
            list.onclick = (e) => {
                const target = e.target.closest('[data-action], [data-role]'); if (!target) return;
                const userId = target.dataset.userid, user = users.find(u => u.id === userId), action = target.dataset.action || target.dataset.role;
                if (action === 'edit-name') namePrompt.show(user?.name || '', async val => { if(val) await updateDoc(getUserRef(contestId, userId), { name: val }); });
                else if (action === 'edit-costume') costumePrompt.show(user?.costume || '', async val => await updateDoc(getUserRef(contestId, userId), { costume: val, isParticipant: !!val }));
                else if (action === 'edit-image') showImageUploadModal(userId);
                else if (target.dataset.role) {
                    if (target.dataset.role === 'isParticipant' && target.checked && !user.costume?.trim()) { target.checked = false; customAlert("Disfraz Requerido", "Añade un nombre de disfraz antes de marcarlo como participante."); costumePrompt.show('', async val => { if (val) await updateDoc(getUserRef(contestId, userId), { costume: val, isParticipant: true }); }); }
                    else { updateDoc(getUserRef(contestId, userId), { [target.dataset.role]: target.checked }); }
                }
            };
        }
        
        async function calculateFullRanking(contestId) {
             const usersSnapshot = await getDocs(getUsersCollectionRef(contestId));
            const allUsers = usersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            const participants = allUsers.filter(u => u.isParticipant);
            const results = [];
            for (const p of participants) {
                const votesSnapshot = await getDocs(getVotesCollectionRef(contestId, p.id));
                 const totalScore = votesSnapshot.docs.reduce((sum, doc) => sum + doc.data().score, 0);
                results.push({ ...p, voteCount: votesSnapshot.size, overallScore: totalScore });
            }
            return results.sort((a, b) => b.overallScore - a.overallScore);
        }
        
        async function renderVotingScreen(contestData, users) {
            const isAdmin = contestData.creatorId === currentUserId;
            const me = users.find(u => u.id === currentUserId);
            const isJuror = me?.isJuror;
            const isTiebreaker = contestData.status === 'tiebreaker';

            document.getElementById('voting-screen-title').textContent = isTiebreaker ? `Desempate por el ${contestData.tiebreakerInfo.rank}º Lugar` : 'Votación en Progreso';

            document.getElementById('admin-voting-view').classList.toggle('hidden', !isAdmin); 
            document.getElementById('voter-voting-view').classList.remove('hidden');
            
            let participants = users.filter(u => u.isParticipant);
            if (isTiebreaker) {
                participants = participants.filter(p => contestData.tiebreakerInfo.participantIds.includes(p.id));
            }
            
            const jurors = users.filter(u => u.isJuror);
            const currentPId = contestData.currentlyVotingFor;
            const currentP = users.find(u => u.id === currentPId);
            const allDone = participants.length > 0 && participants.every(p => contestData.votedOnParticipants?.includes(p.id));

            if (isAdmin) {
                const view = document.getElementById('admin-voting-view'); let html = `<div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-700"><h3 class="text-xl font-bold">Panel de Votación</h3><button id="admin-pause-vote-btn" class="btn-danger py-2 px-3 text-sm">Pausar</button></div><div class="space-y-2 mb-4">`;
                participants.forEach(p => { const evaluated = contestData.votedOnParticipants?.includes(p.id), voting = p.id === currentPId; html += `<div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg"><div><p class="font-bold">${p.name}</p><p class="text-sm text-gray-400">${p.costume}</p></div><button data-userid="${p.id}" data-action="${evaluated?'reopen':'set'}-voting" class="${evaluated?'bg-gray-500':'bg-blue-600'} text-white font-bold py-2 px-4 rounded text-sm">${evaluated?'Reabrir':(voting?'Evaluando...':'Evaluar')}</button></div>`; });
                html += `</div>`; if (currentP) { const votes = (await getDocs(getVotesCollectionRef(contestId, currentP.id))).docs.map(d=>d.data().jurorId); html += `<div class="mt-6 p-4 bg-gray-700 rounded-xl"><h4 class="font-bold text-yellow-400">Evaluando a ${currentP.name}</h4><p>Votos: ${votes.length}/${jurors.length}</p><div class="flex gap-2 mt-4"><button id="admin-reset-vote-btn" class="btn-danger w-1/2" data-currentid="${currentPId}">Reiniciar Votos</button><button id="admin-finalize-vote-btn" class="btn-primary w-1/2" data-currentid="${currentPId}">Finalizar</button></div></div>`; }
                if (allDone) {
                     if (isTiebreaker) {
                        html += `<button id="admin-resolve-tiebreaker-btn" class="btn-primary bg-purple-600 w-full mt-8">Finalizar Desempate</button>`;
                    } else {
                        html += `<button id="admin-show-results-btn" class="btn-primary bg-green-600 w-full mt-8">Ver Resultados Finales</button>`;
                    }
                }
                view.innerHTML = html;
                view.onclick = async e => { 
                    const target = e.target.closest('button'); if (!target) return; const { action, userid, currentid } = target.dataset; 
                    if (target.id === 'admin-pause-vote-btn') await updateDoc(getContestRef(contestId), { status: 'lobby' }); 
                    if (action === 'set-voting') { const batch=writeBatch(db); jurors.forEach(j=>batch.update(getUserRef(contestId,j.id),{hasVoted:false})); batch.update(getContestRef(contestId),{currentlyVotingFor:userid}); await batch.commit(); } 
                    if (action === 'reopen-voting') { const batch=writeBatch(db); const votes=await getDocs(getVotesCollectionRef(contestId,userid)); votes.forEach(v=>batch.delete(v.ref)); batch.update(getContestRef(contestId),{currentlyVotingFor:userid, votedOnParticipants: contestData.votedOnParticipants.filter(id=>id!==userid)}); jurors.forEach(j=>batch.update(getUserRef(contestId,j.id),{hasVoted:false})); await batch.commit(); } 
                    if (target.id === 'admin-finalize-vote-btn') await updateDoc(getContestRef(contestId),{currentlyVotingFor:null,votedOnParticipants:[...(contestData.votedOnParticipants||[]),currentid]}); 
                    if (target.id === 'admin-reset-vote-btn') { const batch=writeBatch(db); const votes=await getDocs(getVotesCollectionRef(contestId,currentid)); votes.forEach(v=>batch.delete(v.ref)); jurors.forEach(j=>batch.update(getUserRef(contestId,j.id),{hasVoted:false})); await batch.commit(); } 
                    if (target.id === 'admin-show-results-btn') {
                        const fullRanking = await calculateFullRanking(contestId);
                        if (fullRanking.length < 1) return customAlert("Sin Votos", "No hay participantes con votos para mostrar resultados.");

                        const scores = fullRanking.reduce((acc, p) => { acc[p.overallScore] = acc[p.overallScore] || []; acc[p.overallScore].push(p.id); return acc; }, {});
                        const uniqueScores = Object.keys(scores).map(Number).sort((a, b) => b - a);

                        let tiedParticipantIds = [], tieRank = 0, ranksFilled = 0;
                        for (const score of uniqueScores) {
                            const participantsAtScore = scores[score];
                            if (participantsAtScore.length > 1 && ranksFilled < 3) {
                                tiedParticipantIds = participantsAtScore;
                                tieRank = ranksFilled + 1;
                                break;
                            }
                            ranksFilled += participantsAtScore.length;
                            if (ranksFilled >= 3) break;
                        }

                        if (tiedParticipantIds.length > 0) {
                            const batch = writeBatch(db);
                            for (const pId of tiedParticipantIds) {
                                const votesSnapshot = await getDocs(getVotesCollectionRef(contestId, pId));
                                votesSnapshot.forEach(vDoc => batch.delete(vDoc.ref));
                            }
                            batch.update(getContestRef(contestId), { status: 'tiebreaker', currentlyVotingFor: null, votedOnParticipants: [], tiebreakerInfo: { rank: tieRank, participantIds: tiedParticipantIds, originalRanking: JSON.stringify(fullRanking) } });
                            await batch.commit();
                            customAlert("¡Empate Detectado!", `Hay un empate por el ${tieRank}º lugar. Se iniciará una ronda de desempate solo entre ellos.`);
                        } else {
                            const topResults = fullRanking.slice(0, 3).map((r, i) => ({ ...r, rank: i + 1 }));
                            await updateDoc(getContestRef(contestId), { status: 'results', revealStep: 0, topResults: JSON.stringify(topResults) });
                        }
                    }
                    if (target.id === 'admin-resolve-tiebreaker-btn') {
                        const tiebreakerRanking = await calculateFullRanking(contestId);
                        const tiedParticipantsRanked = tiebreakerRanking.filter(p => contestData.tiebreakerInfo.participantIds.includes(p.id));

                        let originalRanking = JSON.parse(contestData.tiebreakerInfo.originalRanking);

                        const winnerScore = tiedParticipantsRanked[0].overallScore;
                        const winners = tiedParticipantsRanked.filter(p => p.overallScore === winnerScore);
                        const winnerIds = winners.map(p => p.id);

                        originalRanking = originalRanking.map(p => {
                            if (winnerIds.includes(p.id)) {
                                return { ...p, overallScore: p.overallScore + 0.5 };
                            }
                            return p;
                        });

                        originalRanking.sort((a, b) => b.overallScore - a.overallScore);
                        
                        const topResults = originalRanking.slice(0, 3).map((r, i) => ({ ...r, rank: i + 1 }));
                        await updateDoc(getContestRef(contestId), { status: 'results', revealStep: 0, topResults: JSON.stringify(topResults), tiebreakerInfo: null });
                    }
                };
            }
            const votingDiv = document.getElementById('currently-voting-for'), jurorControls = document.getElementById('juror-controls'), pendingJurorsList = document.getElementById('pending-jurors-list-voter'); pendingJurorsList.innerHTML = '';
            if(currentP) { votingDiv.innerHTML = `${getImageTag(currentP.costumeImageBase64,'image-preview-lg mx-auto',currentP.costume)}<h3 class="font-creepster text-5xl text-orange-400 mt-4">${currentP.name}</h3><p class="text-2xl">"${currentP.costume}"</p>`; const selfVote = me?.isParticipant&&me.id===currentP.id; jurorControls.classList.toggle('hidden', !isJuror || selfVote); if (isJuror && !selfVote) await setInitialJurorScore(currentPId); const votes = (await getDocs(getVotesCollectionRef(contestId,currentP.id))).docs.map(d=>d.data().jurorId); const pending = jurors.filter(j=>!votes.includes(j.id)); pendingJurorsList.innerHTML=pending.length?pending.map(j=>`<li>${j.name}</li>`).join(''):`<li class="text-green-400">¡Todos votaron!</li>`; }
            else { votingDiv.innerHTML = `<h3 class="text-2xl text-gray-400">${allDone? (isTiebreaker ? '¡Desempate finalizado!' : '¡Votación Finalizada!') :'Esperando concursante...'}</h3>`; jurorControls.classList.add('hidden'); }
            const votedIds = contestData.votedOnParticipants || []; document.getElementById('voted-list').innerHTML = participants.filter(p=>votedIds.includes(p.id)).map(p=>`<li>${p.name}</li>`).join(''); document.getElementById('pending-list').innerHTML = participants.filter(p=>!votedIds.includes(p.id)&&p.id!==currentPId).map(p=>`<li>${p.name}</li>`).join('');
        }
        
        async function renderResults(contestData, users) {
            const isAdmin = contestData.creatorId === currentUserId;
            const resultsContainer = document.getElementById('results-container');
            const controlsContainer = document.getElementById('results-controls');
            controlsContainer.innerHTML = ''; // Clear previous controls

            const finalResults = contestData.topResults ? JSON.parse(contestData.topResults) : [];
            const revealStep = contestData.revealStep || 0; 
            let resultsHTML = '';
            const ranks = [3, 2, 1];

            if (finalResults.length === 0 && contestData.status === 'results') {
                resultsHTML = '<p class="text-xl text-yellow-400">No hubo participantes con votos para mostrar.</p>';
            } else {
                ranks.forEach(rank => {
                    const result = finalResults.find(r => r.rank === rank);
                    const requiredStep = 4 - rank; 
                    const isRevealed = revealStep >= requiredStep;

                    if (!result) {
                        resultsHTML += `<div class="bg-gray-900 p-4 rounded-xl flex justify-between items-center opacity-50"><p class="text-xl font-bold text-gray-600">${rank}º Lugar:</p><p class="text-gray-500">N/A</p></div>`;
                        return;
                    }

                    const imageTag = getImageTag(result.costumeImageBase64, 'image-preview-sm mr-3 flex-shrink-0', result.costume);
                    if (isRevealed) {
                        const colorClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : 'rank-3';
                        const icon = rank === 1 ? '👑' : rank === 2 ? '🥈' : '🥉';
                        const isTiebreakerWinner = result.overallScore % 1 !== 0;

                        resultsHTML += `
                            <div class="bg-gray-900 p-4 rounded-xl flex justify-between items-center border-l-4 border-orange-500 transform transition-transform hover:scale-[1.02]">
                                <div class="flex items-center text-left">
                                    <span class="font-creepster text-3xl md:text-4xl mr-4 ${colorClass}">${icon}</span>
                                    ${imageTag}
                                    <div>
                                        <p class="text-xl font-bold text-white">${result.name}</p>
                                        <p class="text-sm text-gray-400">${result.costume}</p>
                                    </div>
                                </div>
                                <div class="text-right flex items-center gap-2" title="${isTiebreakerWinner ? 'Ganador del desempate' : ''}">
                                    ${isTiebreakerWinner ? '<span class="text-2xl text-yellow-400">✨</span>' : ''}
                                    <p class="font-creepster text-5xl ${colorClass}">${Math.floor(result.overallScore)}</p>
                                    <span class="font-creepster text-3xl text-orange-500">🎃</span>
                                </div>
                            </div>`;
                    } else {
                        resultsHTML += `
                            <div class="bg-gray-900 p-4 rounded-xl flex justify-between items-center opacity-40">
                                <p class="text-xl font-bold text-gray-500">${rank}º Lugar</p>
                                <p class="font-creepster text-4xl text-gray-700">???</p>
                            </div>`;
                    }
                });
            }
            resultsContainer.innerHTML = resultsHTML;

            let controlsHTML = '';
            if (isAdmin) {
                ranks.forEach(rank => {
                    const result = finalResults.find(r => r.rank === rank);
                    const stepToTriggerReveal = 3 - rank;
                    const nextStepValue = 4 - rank;
                    const isRevealed = revealStep >= nextStepValue;
                    const canReveal = revealStep === stepToTriggerReveal;

                    if (!result) {
                        controlsHTML += `<button class="btn-primary w-full mt-2 bg-gray-700" disabled>${rank}º Lugar (N/A)</button>`;
                    } else if (isRevealed) {
                        controlsHTML += `<button class="btn-primary w-full mt-2 bg-green-600 hover:bg-green-700" disabled>✔️ ${rank}º Lugar Revelado</button>`;
                    } else if (canReveal) {
                        controlsHTML += `<button data-action="reveal" data-next-step="${nextStepValue}" class="btn-primary w-full mt-2 animate-pulse bg-purple-600 hover:bg-purple-700">✨ Revelar ${rank}º Lugar</button>`;
                    } else {
                        controlsHTML += `<button class="btn-primary w-full mt-2" disabled>Revelar ${rank}º Lugar</button>`;
                    }
                });
            }

            if (revealStep >= 3) { // 1st place is revealed (step 3)
                if(isAdmin) {
                    controlsHTML += `<button data-action="restart" class="btn-secondary mt-6 w-full">Reiniciar Concurso</button>`;
                }
                controlsHTML += `<button data-action="leave" class="btn-danger mt-2 w-full">Volver al Inicio</button>`;
            }
            controlsContainer.innerHTML = controlsHTML;
            
            controlsContainer.onclick = async (e) => {
                const target = e.target.closest('button[data-action]');
                if (!target) return;
                const action = target.dataset.action;
                if(action === 'reveal') {
                    await updateDoc(getContestRef(contestId), { revealStep: parseInt(target.dataset.nextStep) });
                } else if (action === 'restart') {
                    const batch = writeBatch(db);
                    batch.update(getContestRef(contestId), { status: "lobby", currentlyVotingFor: null, votedOnParticipants: [], revealStep: 0, topResults: null, tiebreakerInfo: null });
                    users.forEach(u => batch.update(getUserRef(contestId, u.id), { hasVoted: false, totalScore: 0 }));
                    const allUsers = (await getDocs(getUsersCollectionRef(contestId))).docs;
                    for (const userDoc of allUsers) {
                        const votesSnapshot = await getDocs(getVotesCollectionRef(contestId, userDoc.id));
                        votesSnapshot.forEach(voteDoc => batch.delete(voteDoc.ref));
                    }
                    await batch.commit();
                } else if(action === 'leave') {
                    leaveContest();
                }
            };
        }

        document.getElementById('add-participants-from-list-btn')?.addEventListener('click', async () => { const list=document.getElementById('participants-list-input').value.trim(); if(!list)return; const batch=writeBatch(db); list.split('\n').forEach(l=>{const [name,costume='']=l.split(',').map(p=>p.trim()); if(name)batch.set(doc(getUsersCollectionRef(contestId)),{name,costume,isParticipant:true,isJuror:false,isManualEntry:true})}); await batch.commit(); document.getElementById('participants-list-input').value=''; });
        document.getElementById('add-juror-btn')?.addEventListener('click', async () => { const name=document.getElementById('new-juror-name').value.trim(); if(name){await addDoc(getUsersCollectionRef(contestId),{name,costume:'',isParticipant:false,isJuror:true,isManualEntry:true}); document.getElementById('new-juror-name').value='';} });
        document.getElementById('start-contest-btn')?.addEventListener('click', async () => { const users=(await getDocs(getUsersCollectionRef(contestId))).docs.map(d=>d.data()); if(users.filter(u=>u.isParticipant).length<1) return customAlert("Error","Debe haber al menos un participante."); if(users.filter(u=>u.isJuror).length<1) return customAlert("Error","Debe haber al menos un jurado."); await updateDoc(getContestRef(contestId), {status:'voting', votedOnParticipants: []}); });
        document.getElementById('submit-vote-btn')?.addEventListener('click', async (e) => { if (e.target.disabled) return; e.target.disabled=true; e.target.textContent='Enviado'; const voteRef=doc(getVotesCollectionRef(contestId,localContestData.currentlyVotingFor), currentUserId); const batch=writeBatch(db); batch.set(voteRef,{jurorId:currentUserId,score:currentJurorScore}); batch.update(getUserRef(contestId,currentUserId),{hasVoted:true}); await batch.commit(); });
        
        onAuthStateChanged(auth, async (user) => {
            if (user) { 
                currentUserId = user.uid; 
                const hashId = window.location.hash.substring(1).toUpperCase(); 
                if (hashId) { 
                    contestId = hashId; 
                    if ((await getDoc(getContestRef(hashId))).exists()) {
                        subscribeToContest(contestId); 
                    } else {
                        showScreen('register');
                    }
                } else { 
                    showScreen('home'); 
                }
            } else { 
                await signInAnonymously(auth);
            }
        });
    </script>
</body>
</html>



                if(isAdmin) {
                    controlsHTML += `<button data-action="restart" class="btn-secondary mt-6 w-full">Reiniciar Concurso</button>`;
                }
                controlsHTML += `<button data-action="leave" class="btn-danger mt-2 w-full">Volver al Inicio</button>`;
            }
            controlsContainer.innerHTML = controlsHTML;
            
            controlsContainer.onclick = async (e) => {
                const target = e.target.closest('button[data-action]');
                if (!target) return;
                const action = target.dataset.action;
                if(action === 'reveal') {
                    await updateDoc(getContestRef(contestId), { revealStep: parseInt(target.dataset.nextStep) });
                } else if (action === 'restart') {
                    const batch = writeBatch(db);
                    batch.update(getContestRef(contestId), { status: "lobby", currentlyVotingFor: null, votedOnParticipants: [], revealStep: 0, topResults: null, tiebreakerInfo: null });
                    users.forEach(u => batch.update(getUserRef(contestId, u.id), { hasVoted: false, totalScore: 0 }));
                    const allUsers = (await getDocs(getUsersCollectionRef(contestId))).docs;
                    for (const userDoc of allUsers) {
                        const votesSnapshot = await getDocs(getVotesCollectionRef(contestId, userDoc.id));
                        votesSnapshot.forEach(voteDoc => batch.delete(voteDoc.ref));
                    }
                    await batch.commit();
                } else if(action === 'leave') {
                    leaveContest();
                }
            };
        }

        document.getElementById('add-participants-from-list-btn')?.addEventListener('click', async () => { const list=document.getElementById('participants-list-input').value.trim(); if(!list)return; const batch=writeBatch(db); list.split('\n').forEach(l=>{const [name,costume='']=l.split(',').map(p=>p.trim()); if(name)batch.set(doc(getUsersCollectionRef(contestId)),{name,costume,isParticipant:true,isJuror:false,isManualEntry:true})}); await batch.commit(); document.getElementById('participants-list-input').value=''; });
        document.getElementById('add-juror-btn')?.addEventListener('click', async () => { const name=document.getElementById('new-juror-name').value.trim(); if(name){await addDoc(getUsersCollectionRef(contestId),{name,costume:'',isParticipant:false,isJuror:true,isManualEntry:true}); document.getElementById('new-juror-name').value='';} });
        document.getElementById('start-contest-btn')?.addEventListener('click', async () => { const users=(await getDocs(getUsersCollectionRef(contestId))).docs.map(d=>d.data()); if(users.filter(u=>u.isParticipant).length<1) return customAlert("Error","Debe haber al menos un participante."); if(users.filter(u=>u.isJuror).length<1) return customAlert("Error","Debe haber al menos un jurado."); await updateDoc(getContestRef(contestId), {status:'voting', votedOnParticipants: []}); });
        document.getElementById('submit-vote-btn')?.addEventListener('click', async (e) => { if (e.target.disabled) return; e.target.disabled=true; e.target.textContent='Enviado'; const voteRef=doc(getVotesCollectionRef(contestId,localContestData.currentlyVotingFor), currentUserId); const batch=writeBatch(db); batch.set(voteRef,{jurorId:currentUserId,score:currentJurorScore}); batch.update(getUserRef(contestId,currentUserId),{hasVoted:true}); await batch.commit(); });
        
        onAuthStateChanged(auth, async (user) => {
            if (user) { 
                currentUserId = user.uid; 
                const hashId = window.location.hash.substring(1).toUpperCase(); 
                if (hashId) { 
                    contestId = hashId; 
                    if ((await getDoc(getContestRef(hashId))).exists()) {
                        subscribeToContest(contestId); 
                    } else {
                        // If the room in the URL doesn't exist in our app space, offer to register for it.
                        showScreen('register');
                    }
                } else { 
                    showScreen('home'); 
                }
            } else { 
                await signInAnonymously(auth);
            }
        });
    </script>
</body>
</html>



